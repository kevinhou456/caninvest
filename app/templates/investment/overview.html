{% extends "base/investment_base.html" %}

{% block extra_css %}
<style>
    /* Overview Page Specific Styles */
    .metric-card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .metric-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 0.5rem;
        flex-shrink: 0;
    }
    
    .holdings-table {
        font-size: 0.9rem;
    }
    
    .stock-avatar {
        width: 32px;
        height: 32px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .return-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Ë¥¶Êà∑ËØ¶ÊÉÖÊÇ¨ÂÅúÊèêÁ§∫Ê†∑Âºè - ‰ºòÈõÖÁôΩËâ≤È£éÊ†º */
    .account-tooltip {
        cursor: help;
        position: relative;
    }
    
    .tooltip {
        --bs-tooltip-bg: #ffffff;
        --bs-tooltip-border-color: #dee2e6;
        --bs-tooltip-color: #212529;
        --bs-tooltip-max-width: 500px;
    }
    
    .tooltip-inner {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        color: #212529;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 16px;
        font-size: 0.85rem;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: left;
        max-width: 500px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .tooltip-account-item {
        margin-bottom: 12px;
        padding: 12px;
        background: rgba(248, 249, 250, 0.8);
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
    }
    
    .tooltip-account-item:last-child {
        margin-bottom: 0;
    }
    
    .tooltip-account-name {
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }
    
    .tooltip-account-name::before {
        content: 'üè¶';
        margin-right: 6px;
    }
    
    .tooltip-account-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 0.8rem;
    }
    
    .tooltip-detail {
        padding: 6px 8px;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        text-align: center;
    }
    
    .tooltip-detail-label {
        font-size: 0.7rem;
        color: #6c757d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }
    
    .tooltip-detail-value {
        font-weight: 600;
        color: #212529;
    }
    
    .tooltip-detail.gain {
        border-left: 3px solid #198754;
    }
    
    .tooltip-detail.gain .tooltip-detail-value {
        color: #198754;
    }
    
    .tooltip-detail.loss {
        border-left: 3px solid #dc3545;
    }
    
    .tooltip-detail.loss .tooltip-detail-value {
        color: #dc3545;
    }
    
    .tooltip-detail.neutral {
        border-left: 3px solid #6c757d;
    }
    
    .tooltip-detail.shares {
        border-left: 3px solid #0dcaf0;
    }
    
    .tooltip-detail.cost {
        border-left: 3px solid #fd7e14;
    }
    
    @media (max-width: 768px) {
        .metric-card .card-body {
            padding: 1rem 0.75rem;
        }
        
        .holdings-table {
            font-size: 0.8rem;
        }
        
        .stock-avatar {
            width: 24px;
            height: 24px;
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Portfolio Overview Header -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h4>{{ _('Portfolio Overview') }}</h4>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshPortfolioData()">
                <i class="fas fa-sync-alt me-1"></i>{{ _('Refresh Data') }}
            </button>
        </div>
        <!-- <p class="text-muted">{{ _('Summary of investment portfolio for') }} {{ filter_description }}</p> -->
    </div>
</div>

<!-- Key Investment Metrics -->
<div class="row mb-4">
    <!-- Total Assets -->
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon bg-primary bg-opacity-10">
                        <i class="fas fa-wallet text-primary"></i>
                    </div>
                    <h6 class="card-title text-muted mb-0">{{ _('Total Assets') }}</h6>
                </div>
                <h4 id="total-assets-display" class="text-primary mb-1">${{ "{:,.2f}".format(metrics.total_assets.cad if metrics else 0) }}</h4>
                <div class="text-muted">
                    <small class="d-block" id="total-assets-breakdown-cad">CAD:${{ "{:,.2f}".format(metrics.total_assets.cad_only if metrics else 0) }}</small>
                    <small class="d-block" id="total-assets-breakdown-usd">USD:${{ "{:,.2f}".format(metrics.total_assets.usd_only if metrics else 0) }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Return -->
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon bg-{{ 'success' if metrics and metrics.total_return.cad >= 0 else 'danger' }} bg-opacity-10">
                        <i class="fas fa-chart-line {{ 'text-success' if metrics and metrics.total_return.cad >= 0 else 'text-danger' }}"></i>
                    </div>
                    <h6 class="card-title text-muted mb-0">{{ _('Total Return') }}</h6>
                </div>
                <h4 class="mb-1">
                    <span id="total-return-display" class="{{ 'text-success' if metrics and metrics.total_return.cad >= 0 else 'text-danger' }}">
                        {% if metrics and metrics.total_return.cad >= 0 %}+{% endif %}${{ "{:,.2f}".format(metrics.total_return.cad if metrics else 0) }}
                    </span>
                    <small id="total-return-rate-display" class="ms-2 {{ 'text-success' if metrics and metrics.total_return_rate >= 0 else 'text-danger' }}">
                        ({% if metrics %}{{ "+" if metrics.total_return_rate >= 0 else "" }}{{ "{:.2f}".format(metrics.total_return_rate) }}{% else %}0.00{% endif %}%)
                    </small>
                </h4>
                <div class="text-muted">
                    <small class="d-block" id="total-return-breakdown-cad">CAD:${{ "{:,.2f}".format(metrics.total_return.cad_only if metrics else 0) }}</small>
                    <small class="d-block" id="total-return-breakdown-usd">USD:${{ "{:,.2f}".format(metrics.total_return.usd_only if metrics else 0) }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Realized Gain -->
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon bg-{{ 'success' if metrics and metrics.realized_gain.cad >= 0 else 'danger' }} bg-opacity-10">
                        <i class="fas fa-coins {{ 'text-success' if metrics and metrics.realized_gain.cad >= 0 else 'text-danger' }}"></i>
                    </div>
                    <h6 class="card-title text-muted mb-0">{{ _('Realized Gain') }}</h6>
                </div>
                <h4 id="realized-gain-display" class="{{ 'text-success' if metrics and metrics.realized_gain.cad >= 0 else 'text-danger' }} mb-1">
                    {% if metrics and metrics.realized_gain.cad >= 0 %}+{% endif %}${{ "{:,.2f}".format(metrics.realized_gain.cad if metrics else 0) }}
                </h4>
                <div class="text-muted">
                    <small class="d-block" id="realized-gain-breakdown-cad">CAD:${{ "{:,.2f}".format(metrics.realized_gain.cad_only if metrics else 0) }}</small>
                    <small class="d-block" id="realized-gain-breakdown-usd">USD:${{ "{:,.2f}".format(metrics.realized_gain.usd_only if metrics else 0) }}</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Unrealized Gain -->
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon bg-{{ 'success' if metrics and metrics.unrealized_gain.cad >= 0 else 'danger' }} bg-opacity-10">
                        <i class="fas fa-chart-area {{ 'text-success' if metrics and metrics.unrealized_gain.cad >= 0 else 'text-danger' }}"></i>
                    </div>
                    <h6 class="card-title text-muted mb-0">{{ _('Unrealized Gain') }}</h6>
                </div>
                <h4 id="unrealized-gain-display" class="{{ 'text-success' if metrics and metrics.unrealized_gain.cad >= 0 else 'text-danger' }} mb-1">
                    {% if metrics and metrics.unrealized_gain.cad >= 0 %}+{% endif %}${{ "{:,.2f}".format(metrics.unrealized_gain.cad if metrics else 0) }}
                </h4>
                <div class="text-muted">
                    <small class="d-block" id="unrealized-gain-breakdown-cad">CAD:${{ "{:,.2f}".format(metrics.unrealized_gain.cad_only if metrics else 0) }}</small>
                    <small class="d-block" id="unrealized-gain-breakdown-usd">USD:${{ "{:,.2f}".format(metrics.unrealized_gain.usd_only if metrics else 0) }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Change -->
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon bg-{{ 'success' if metrics and metrics.daily_change.cad >= 0 else 'danger' }} bg-opacity-10">
                        <i class="fas fa-wave-square {{ 'text-success' if metrics and metrics.daily_change.cad >= 0 else 'text-danger' }}"></i>
                    </div>
                    <h6 class="card-title text-muted mb-0">{{ _('Daily Change') }}</h6>
                </div>
                <h4 class="mb-1" id="daily-change-display">
                    <span class="{{ 'text-success' if metrics and metrics.daily_change.cad >= 0 else 'text-danger' }}">
                        {% if metrics and metrics.daily_change.cad >= 0 %}+{% endif %}${{ "{:,.2f}".format(metrics.daily_change.cad if metrics else 0) }}
                    </span>
                </h4>
                <div class="text-muted">
                    <small class="d-block" id="daily-change-breakdown-cad">CAD:${{ "{:,.2f}".format(metrics.daily_change.cad_only if metrics else 0) }}</small>
                    <small class="d-block" id="daily-change-breakdown-usd">USD:${{ "{:,.2f}".format(metrics.daily_change.usd_only if metrics else 0) }}</small>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Cash Balance -->
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card h-100 metric-card cash-card" onclick="openCashModal()" style="cursor: pointer; position: relative;">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="metric-icon bg-success bg-opacity-10">
                        <i class="fas fa-money-bill-wave text-success"></i>
                    </div>
                    <h6 class="card-title text-muted mb-0">{{ _('Cash Balance') }}</h6>
                </div>
                <h4 class="text-success mb-1" id="cash-balance-display">${{ "{:,.2f}".format(cash_data.total_cad if cash_data else 0) }}</h4>
                <small class="text-muted">CAD:${{ "{:,.0f}".format(cash_data.cad if cash_data else 0) }}|USD:${{ "{:,.0f}".format(cash_data.usd if cash_data else 0) }}</small>
            </div>
            <!-- Edit Icon -->
            <div class="position-absolute top-0 end-0 m-2">
                <i class="fas fa-edit text-muted" style="font-size: 14px; opacity: 0.7;"></i>
            </div>
        </div>
    </div>
    
</div>

<!-- Holdings Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>{{ _('Current Holdings') }}
                </h5>
                <span class="badge bg-secondary">{{ holdings|length if holdings else 0 }} {{ _('stocks') }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 holdings-table" id="holdingsTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center flex-grow-1">
                                            <span class="sort-region sortable me-2" data-sort="currency" title="{{ _('Sort by Currency') }}">
                                                <i class="fas fa-dollar-sign"></i>
                                                <i class="fas fa-sort sort-icon ms-1" style="font-size: 0.7rem;"></i>
                                            </span>
                                            <span class="sort-region sortable me-2 flex-grow-1" data-sort="symbol" title="{{ _('Sort by Stock Symbol') }}">
                                                {{ _('Stock Symbol') }}
                                                <i class="fas fa-sort sort-icon ms-1" style="font-size: 0.7rem;"></i>
                                            </span>
                                            <span class="sort-region sortable" data-sort="sector" title="{{ _('Sort by Sector') }}">
                                                <i class="fas fa-tags"></i>
                                                <i class="fas fa-sort sort-icon ms-1" style="font-size: 0.7rem;"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="text-end sortable" data-sort="shares">
                                    {{ _('Shares') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="avg_cost">
                                    {{ _('Avg Cost') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="current_price">
                                    {{ _('Current Price') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="daily_change">
                                    {{ _('Daily Change') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="market_value">
                                    {{ _('Market Value') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="unrealized_gain">
                                    {{ _('Unrealized P&L') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="realized_gain">
                                    {{ _('Realized Gains') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="dividends">
                                    {{ _('Div+Int') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end pe-3 sortable" data-sort="return_percent">
                                    {{ _('Return Percent') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if holdings %}
                                {% for holding in holdings %}
                                <tr class="align-middle"
                                    data-symbol="{{ holding['symbol'] }}"
                                    data-currency="{{ holding['currency'] }}"
                                    data-account-id="{{ holding.get('account_id', '') }}"
                                    data-sector="{{ holding.get('sector', 'Unknown') }}"
                                    data-shares="{{ holding['shares'] or 0 }}"
                                    data-avg-cost="{{ holding.get('average_cost_display', holding.get('average_cost', 0)) or 0 }}"
                                    data-current-price="{{ holding['current_price'] or 0 }}"
                                    data-daily-change="{{ holding.get('daily_change_value', 0) }}"
                                    data-market-value="{{ holding['current_value'] or 0 }}"
                                    data-unrealized-gain="{{ holding['unrealized_gain'] or 0 }}"
                                    data-realized-gain="{{ holding['realized_gain'] or 0 }}"
                                    data-dividends="{{ (holding.get('dividends', 0) or 0) + (holding.get('interest', 0) or 0) }}"
                                    data-return-percent="{{ holding['unrealized_gain_percent'] or 0 }}">
                                <!-- Stock Symbol -->
                                <td class="ps-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-{{ 'warning' if holding['currency'] == 'CAD' else 'success' }} rounded-circle d-flex align-items-center justify-content-center me-2 stock-avatar" 
                                             style="color: {{ 'black' if holding['currency'] == 'CAD' else 'white' }}; cursor: pointer;"
                                             onclick="openAddTransactionModalForStock('{{ holding['symbol'] }}', '{{ holding['currency'] }}', {{ account_id if account_id else 'null' }})"
                                             title="{{ _('Click to add transaction for') }} {{ holding['symbol'] }}">
                                            {% if holding['currency'] == 'CAD' %}C${% else %}${% endif %}
                                        </div>
                                        <div>
                                            <a href="{{ url_for('main.stock_detail', stock_symbol=holding['symbol'], member_id=member_id, account_id=account_id) }}" class="text-decoration-none">
                                                <strong>{{ holding['symbol'] }}</strong>
                                            </a>
                                            <br><small class="text-muted">{{ holding['sector'] or 'Unknown' }}</small>
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- Shares -->
                                <td class="text-end">
                                    {% if holding.get('account_details') %}
                                        <!-- ÊòæÁ§∫ÊÇ¨ÂÅúÊèêÁ§∫ -->
                                        <span class="fw-medium account-tooltip" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-html="true"
                                              data-bs-placement="top"
                                              title="{% for detail in holding['account_details'] %}{{ detail['account_name'] }}: {{ '{:,.2f}'.format(detail['shares']) }}ËÇ°, ${{ '{:,.2f}'.format(detail['cost']) }}{% if detail.get('realized_gain') is not none %}, <span class='{% if detail['realized_gain'] >= 0 %}gain-positive{% else %}gain-negative{% endif %}'>Â∑≤ÂÆûÁé∞{% if detail['realized_gain'] >= 0 %}+{% endif %}${{ '{:,.2f}'.format(detail['realized_gain']) }}</span>{% endif %}{% if detail.get('unrealized_gain') is not none %}, <span class='{% if detail['unrealized_gain'] >= 0 %}gain-positive{% else %}gain-negative{% endif %}'>ÊµÆÂä®{% if detail['unrealized_gain'] >= 0 %}+{% endif %}${{ '{:,.2f}'.format(detail['unrealized_gain']) }}</span>{% endif %}{% if not loop.last %}<br>{% endif %}{% endfor %}">
                                            {{ "{:,.2f}".format(holding['shares'] or 0) }} <i class="fas fa-info-circle text-muted ms-1" style="font-size: 0.8rem;"></i>
                                        </span>
                                    {% else %}
                                        <!-- Êó†Ë¥¶Êà∑ËØ¶ÊÉÖÔºöÊ≠£Â∏∏ÊòæÁ§∫ -->
                                        <span class="fw-medium">{{ "{:,.2f}".format(holding['shares'] or 0) }}</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Average Cost -->
                                <td class="text-end">
                                    {% set avg_cost_display = holding.get('average_cost_display', holding.get('average_cost', 0)) %}
                                    <span class="text-muted">${{ "{:.2f}".format(avg_cost_display or 0) }}</span>
                                    <br><small class="text-muted">{{ holding['currency'] }}</small>
                                </td>
                                
                                <!-- Current Price -->
                                <td class="text-end">
                                    <span class="fw-medium">${{ "{:.2f}".format(holding['current_price'] or 0) }}</span>
                                    <br><small class="text-muted">{{ holding['currency'] }}</small>
                                </td>

                                <!-- Daily Change -->
                                <td class="text-end">
                                    {% set daily_value = holding.get('daily_change_value', 0) %}
                                    {% set daily_percent = holding.get('daily_change_percent', 0) %}
                                    <span class="fw-medium {{ 'text-success' if daily_value >= 0 else 'text-danger' }}">
                                        {% if daily_value >= 0 %}+{% endif %}
                                        ${{ "{:,.2f}".format(daily_value) }}
                                    </span>
                                    <br>
                                    <small class="{{ 'text-success' if daily_percent >= 0 else 'text-danger' }}">
                                        {% if daily_percent >= 0 %}+{% endif %}
                                        {{ "{:.2f}".format(daily_percent) }}%
                                    </small>
                                </td>

                                <!-- Market Value -->
                                <td class="text-end">
                                    <span class="fw-bold">${{ "{:,.2f}".format(holding['current_value'] or 0) }}</span>
                                    <br><small class="text-muted">{{ holding['currency'] }}</small>
                                </td>
                                
                                <!-- Unrealized Gain/Loss -->
                                <td class="text-end">
                                    <span class="fw-bold {{ 'text-success' if holding.get('unrealized_gain', 0) >= 0 else 'text-danger' }}">
                                        {% if holding.get('unrealized_gain', 0) >= 0 %}+{% endif %}
                                        ${{ "{:,.2f}".format(holding['unrealized_gain'] or 0) }}
                                    </span>
                                    <br><small class="text-muted {{ 'text-success' if holding.get('unrealized_gain_percent', 0) >= 0 else 'text-danger' }}">
                                        {% if holding.get('unrealized_gain_percent', 0) >= 0 %}+{% endif %}
                                        {{ "{:.1f}".format(holding.get('unrealized_gain_percent', 0)) }}%
                                    </small>
                                </td>
                                
                                <!-- Realized Gains -->
                                <td class="text-end">
                                    <span class="fw-medium {{ 'text-success' if holding.get('realized_gain', 0) >= 0 else 'text-danger' }}">
                                        {% if holding.get('realized_gain', 0) >= 0 %}+{% endif %}
                                        ${{ "{:,.2f}".format(holding.get('realized_gain', 0) or 0) }}
                                    </span>
                                </td>
                                
                                <!-- Dividends + Interest -->
                                <td class="text-end">
                                    <span class="fw-medium text-success">
                                        ${{ "{:,.2f}".format((holding['dividends'] or 0) + (holding['interest'] or 0)) }}
                                    </span>
                                    {% if (holding['dividends'] or 0) > 0 and (holding['interest'] or 0) > 0 %}
                                        <br><small class="text-muted">${{ "{:,.2f}".format(holding['dividends'] or 0) }}+${{ "{:,.2f}".format(holding['interest'] or 0) }}</small>
                                    {% endif %}
                                </td>
                                
                                <!-- Return Percentage -->
                                <td class="text-end pe-3">
                                    {% set total_gain = (holding.get('unrealized_gain', 0) or 0) + (holding.get('realized_gain', 0) or 0) + (holding.get('dividends', 0) or 0) + (holding.get('interest', 0) or 0) %}
                                    {% set total_cost = holding.get('total_cost', 0) or 0 %}
                                    {% set total_return_percent = (total_gain / total_cost * 100) if total_cost > 0 else 0 %}
                                    <span class="badge {{ 'bg-success' if total_return_percent >= 0 else 'bg-danger' }} return-badge">
                                        {% if total_return_percent >= 0 %}+{% endif %}
                                        {{ "{:.1f}".format(total_return_percent) }}%
                                    </span>
                                </td>
                            </tr>
                                {% endfor %}
                            {% else %}
                                <!-- ÂºÇÊ≠•Âä†ËΩΩÊó∂ÊòæÁ§∫Á©∫Ë°åÔºåÁ≠âÂæÖÊï∞ÊçÆÂ°´ÂÖÖ -->
                                <tr id="holdings-loading-row" style="display: none;">
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading holdings data...</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- ÂßãÁªàÊòæÁ§∫No holdingsÊèêÁ§∫ÔºåJavaScript‰ºöÂú®ÊúâÊï∞ÊçÆÊó∂ÈöêËóè -->
                <div class="text-center py-5" id="no-holdings-message">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">{{ _('No holdings found') }}</h5>
                    <p class="text-muted mb-0">{{ _('Start investing to see your portfolio here') }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cleared Holdings Section -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2 text-muted"></i>{{ _('Cleared Holdings') }}
                        <small class="text-muted ms-2">({{ _('Previously Owned Stocks') }})</small>
                    </h5>
                    <span class="badge bg-secondary">{{ cleared_holdings|length }} {{ _('stocks') }}</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="clearedHoldingsTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center flex-grow-1">
                                            <span class="sort-region sortable me-2" data-sort="currency" title="{{ _('Sort by Currency') }}">
                                                <i class="fas fa-dollar-sign"></i>
                                                <i class="fas fa-sort sort-icon ms-1" style="font-size: 0.7rem;"></i>
                                            </span>
                                            <span class="sort-region sortable me-2 flex-grow-1" data-sort="symbol" title="{{ _('Sort by Stock Symbol') }}">
                                                {{ _('Stock') }}
                                                <i class="fas fa-sort sort-icon ms-1" style="font-size: 0.7rem;"></i>
                                            </span>
                                            <span class="sort-region sortable" data-sort="sector" title="{{ _('Sort by Sector') }}">
                                                <i class="fas fa-tags"></i>
                                                <i class="fas fa-sort sort-icon ms-1" style="font-size: 0.7rem;"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable" data-sort="company">
                                    {{ _('Company') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="bought_shares">
                                    {{ _('Bought Shares') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="sold_shares">
                                    {{ _('Sold Shares') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="total_invested">
                                    {{ _('Total Invested') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="total_received">
                                    {{ _('Total Received') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="realized_gain">
                                    {{ _('Realized Gain') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="dividends">
                                    {{ _('Div+Int') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end pe-3 sortable" data-sort="return_percent">
                                    {{ _('Return Percent') }}
                                    <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if cleared_holdings %}
                                {% for holding in cleared_holdings %}
                                <tr data-symbol="{{ holding['symbol'] }}"
                                    data-currency="{{ holding['currency'] }}"
                                    data-sector="{{ holding.get('sector', 'Unknown') }}"
                                    data-company="{{ holding['company_name'] }}"
                                    data-bought-shares="{{ holding['total_bought_shares'] or 0 }}"
                                    data-sold-shares="{{ holding['total_sold_shares'] or 0 }}"
                                    data-total-invested="{{ holding['total_bought_value'] or 0 }}"
                                    data-total-received="{{ holding['total_sold_value'] or 0 }}"
                                    data-realized-gain="{{ holding['realized_gain'] or 0 }}"
                                    data-dividends="{{ (holding.get('dividends', 0) or 0) + (holding.get('interest', 0) or 0) }}"
                                    data-return-percent="{{ holding.get('realized_gain_percent', 0) or 0 }}">
                                <!-- Stock Symbol -->
                                <td class="ps-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-{{ 'warning' if holding['currency'] == 'CAD' else 'success' }} rounded-circle d-flex align-items-center justify-content-center me-2 stock-avatar" 
                                             style="color: {{ 'black' if holding['currency'] == 'CAD' else 'white' }};">
                                            {% if holding['currency'] == 'CAD' %}C${% else %}${% endif %}
                                        </div>
                                        <a href="{{ url_for('main.stock_detail', stock_symbol=holding['symbol'], member_id=member_id, account_id=account_id) }}" class="text-decoration-none">
                                            <strong>{{ holding['symbol'] }}</strong>
                                        </a>
                                    </div>
                                </td>
                                
                                <!-- Company Name -->
                                <td>
                                    <div>
                                        <div class="fw-medium">{{ holding['company_name'] or holding['symbol'] }}</div>
                                        <small class="text-muted">{{ holding['sector'] or 'Unknown Sector' }}</small>
                                    </div>
                                </td>
                                
                                <!-- Bought Shares -->
                                <td class="text-end">
                                    {% if holding.get('account_details') %}
                                        <!-- ÊòæÁ§∫ÊÇ¨ÂÅúÊèêÁ§∫ -->
                                        <span class="fw-medium account-tooltip" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-html="true"
                                              data-bs-placement="top"
                                              title="{% for detail in holding['account_details'] %}{{ detail['account_name'] }}: {{ '{:,.2f}'.format(detail.get('bought_shares', 0)) }}ËÇ°, ${{ '{:,.2f}'.format(detail['cost']) }}{% if detail.get('realized_gain') is not none %}, <span class='{% if detail['realized_gain'] >= 0 %}gain-positive{% else %}gain-negative{% endif %}'>Â∑≤ÂÆûÁé∞{% if detail['realized_gain'] >= 0 %}+{% endif %}${{ '{:,.2f}'.format(detail['realized_gain']) }}</span>{% endif %}{% if not loop.last %}<br>{% endif %}{% endfor %}">
                                            {{ "{:,.2f}".format(holding['total_bought_shares'] or 0) }} <i class="fas fa-info-circle text-muted ms-1" style="font-size: 0.8rem;"></i>
                                        </span>
                                    {% else %}
                                        <!-- Êó†Ë¥¶Êà∑ËØ¶ÊÉÖÔºöÊ≠£Â∏∏ÊòæÁ§∫ -->
                                        <span class="fw-medium">{{ "{:,.2f}".format(holding['total_bought_shares'] or 0) }}</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Sold Shares -->
                                <td class="text-end">
                                    {% if holding.get('account_details') %}
                                        <!-- ÊòæÁ§∫ÊÇ¨ÂÅúÊèêÁ§∫ -->
                                        <span class="fw-medium account-tooltip" 
                                              data-bs-toggle="tooltip" 
                                              data-bs-html="true"
                                              data-bs-placement="top"
                                              title="{% for detail in holding['account_details'] %}{{ detail['account_name'] }}: {{ '{:,.2f}'.format(detail.get('sold_shares', 0)) }}ËÇ°, ${{ '{:,.2f}'.format(detail.get('sold_value', 0)) }}Êî∂ÂÖ•{% if detail.get('realized_gain') is not none %}, <span class='{% if detail['realized_gain'] >= 0 %}gain-positive{% else %}gain-negative{% endif %}'>Â∑≤ÂÆûÁé∞{% if detail['realized_gain'] >= 0 %}+{% endif %}${{ '{:,.2f}'.format(detail['realized_gain']) }}</span>{% endif %}{% if not loop.last %}<br>{% endif %}{% endfor %}">
                                            {{ "{:,.2f}".format(holding['total_sold_shares'] or 0) }} <i class="fas fa-info-circle text-muted ms-1" style="font-size: 0.8rem;"></i>
                                        </span>
                                    {% else %}
                                        <!-- Êó†Ë¥¶Êà∑ËØ¶ÊÉÖÔºöÊ≠£Â∏∏ÊòæÁ§∫ -->
                                        <span class="fw-medium">{{ "{:,.2f}".format(holding['total_sold_shares'] or 0) }}</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Total Invested -->
                                <td class="text-end">
                                    <span class="text-muted">${{ "{:,.2f}".format(holding['total_bought_value'] or 0) }}</span>
                                    <br><small class="text-muted">{{ holding['currency'] }}</small>
                                </td>
                                
                                <!-- Total Received -->
                                <td class="text-end">
                                    <span class="text-muted">${{ "{:,.2f}".format(holding['total_sold_value'] or 0) }}</span>
                                    <br><small class="text-muted">{{ holding['currency'] }}</small>
                                </td>
                                
                                <!-- Realized Gain/Loss -->
                                <td class="text-end">
                                    <span class="fw-bold {{ 'text-success' if holding['realized_gain'] >= 0 else 'text-danger' }}">
                                        {% if holding['realized_gain'] >= 0 %}+{% endif %}
                                        ${{ "{:,.2f}".format(holding['realized_gain'] or 0) }}
                                    </span>
                                </td>
                                
                                <!-- Dividends + Interest -->
                                <td class="text-end">
                                    <span class="fw-medium text-success">
                                        ${{ "{:,.2f}".format((holding['dividends'] or 0) + (holding['interest'] or 0)) }}
                                    </span>
                                    {% if (holding['dividends'] or 0) > 0 and (holding['interest'] or 0) > 0 %}
                                        <br><small class="text-muted">${{ "{:,.2f}".format(holding['dividends'] or 0) }}+${{ "{:,.2f}".format(holding['interest'] or 0) }}</small>
                                    {% endif %}
                                </td>
                                
                                <!-- Return Percentage -->
                                <td class="text-end pe-3">
                                    <span class="badge {{ 'bg-success' if holding.get('realized_gain_percent', 0) >= 0 else 'bg-danger' }} return-badge">
                                        {% if holding.get('realized_gain_percent', 0) >= 0 %}+{% endif %}
                                        {{ "{:.1f}".format(holding.get('realized_gain_percent', 0)) }}%
                                    </span>
                                </td>
                            </tr>
                                {% endfor %}
                            {% else %}
                                <!-- ÂºÇÊ≠•Âä†ËΩΩÊó∂ÊòæÁ§∫Á©∫Ë°åÔºåÁ≠âÂæÖÊï∞ÊçÆÂ°´ÂÖÖ -->
                                <tr id="cleared-holdings-loading-row" style="display: none;">
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading cleared holdings data...</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- ÂßãÁªàÊòæÁ§∫No cleared holdingsÊèêÁ§∫ÔºåJavaScript‰ºöÂú®ÊúâÊï∞ÊçÆÊó∂ÈöêËóè -->
                <div class="text-center py-5" id="no-cleared-holdings-message">
                    <i class="fas fa-history fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">{{ _('No cleared holdings found') }}</h5>
                    <p class="text-muted mb-0">{{ _('Stocks you have completely sold will appear here') }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Information Cards -->
{% if exchange_rates %}
<div class="row">
    
    <!-- Portfolio Statistics & Financial Summary -->
    <div class="col-12 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>{{ _('Portfolio Statistics & Financial Summary') }}
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-0">
                    <div class="col-md-3 text-center border-end">
                        <h5 class="text-info mb-1">{{ stats.accounts_count }}</h5>
                        <small class="text-muted">{{ _('Active Accounts') }}</small>
                    </div>
                    <div class="col-md-3 text-center border-end">
                        <h5 class="text-warning mb-1">{{ stats.transactions_count }}</h5>
                        <small class="text-muted">{{ _('Total Transactions') }}</small>
                    </div>
                    <div class="col-md-3 text-center border-end">
                        <h5 class="text-primary mb-1">{{ "{:.4f}".format(exchange_rates['usd_to_cad'] if exchange_rates else 1.35) }}</h5>
                        <small class="text-muted">{{ _('USD/CAD Rate') }}</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h5 class="text-secondary mb-1">{{ "{:.4f}".format(exchange_rates['cad_to_usd'] if exchange_rates else 0.74) }}</h5>
                        <small class="text-muted">{{ _('CAD/USD Rate') }}</small>
                    </div>
                </div>
                <hr class="my-3">
                <div class="row g-0">
                    <div class="col-md-4 text-center border-end">
                        <h5 class="text-success mb-1">${{ "{:,.0f}".format(metrics.total_deposits.cad if metrics else 0) }}</h5>
                        <small class="text-muted">{{ _('Total Deposits') }}</small>
                        <br><small class="text-muted" style="font-size: 0.7rem;">CAD:${{ "{:,.0f}".format(metrics.total_deposits.cad_only if metrics else 0) }} | USD:${{ "{:,.0f}".format(metrics.total_deposits.usd_only if metrics else 0) }}</small>
                    </div>
                    <div class="col-md-4 text-center border-end">
                        <h5 class="text-danger mb-1">${{ "{:,.0f}".format(metrics.total_withdrawals.cad if metrics else 0) }}</h5>
                        <small class="text-muted">{{ _('Total Withdrawals') }}</small>
                        <br><small class="text-muted" style="font-size: 0.7rem;">CAD:${{ "{:,.0f}".format(metrics.total_withdrawals.cad_only if metrics else 0) }} | USD:${{ "{:,.0f}".format(metrics.total_withdrawals.usd_only if metrics else 0) }}</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h5 class="text-info mb-1">${{ "{:,.2f}".format((metrics.total_dividends.cad + metrics.total_interest.cad) if metrics else 0) }}</h5>
                        <small class="text-muted">{{ _('Div+Int') }}</small>
                        <br><small class="text-muted" style="font-size: 0.7rem;">CAD:${{ "{:,.2f}".format((metrics.total_dividends.cad_only + metrics.total_interest.cad_only) if metrics else 0) }} | USD:${{ "{:,.2f}".format((metrics.total_dividends.usd_only + metrics.total_interest.usd_only) if metrics else 0) }}</small>
                    </div>
                </div>
                {% if exchange_rates %}
                <div class="text-center mt-2">
                    <small class="text-muted" style="font-size: 0.7rem;">
                        <i class="fas fa-clock me-1"></i>
                        {{ _('Exchange rates updated') }}: {{ exchange_rates['updated_date'] }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cash Management Modal -->
<div class="modal fade" id="cashModal" tabindex="-1" aria-labelledby="cashModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cashModalLabel">
                    <i class="fas fa-edit me-2"></i>{{ _('Cash Adjustment') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ _('Select an account to adjust its cash balance.') }}
                </div>
                
                <!-- Account Selection -->
                <div class="mb-4">
                    <label for="accountSelect" class="form-label">
                        <i class="fas fa-university me-2"></i>{{ _('Select Account') }}
                    </label>
                    <select class="form-select" id="accountSelect" onchange="onAccountSelected()">
                        <option value="">{{ _('Please select an account...') }}</option>
                    </select>
                </div>
                
                <!-- Cash Input Forms -->
                <div id="cashInputSection" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0" id="selectedAccountInfo">
                                <i class="fas fa-edit me-2"></i>{{ _('Cash Balance Adjustment') }}
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cadInput" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>{{ _('CAD Amount') }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text text-dark" style="background-color: #fff3cd;">
                                            <i class="fas fa-dollar-sign"></i>
                                        </span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="cadInput" 
                                               step="0.01"
                                               min="0"
                                               placeholder="0.00">
                                        <span class="input-group-text text-muted">CAD</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="usdInput" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>{{ _('USD Amount') }}
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text text-white" style="background-color: #28a745;">
                                            <i class="fas fa-dollar-sign"></i>
                                        </span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="usdInput" 
                                               step="0.01"
                                               min="0"
                                               placeholder="0.00">
                                        <span class="input-group-text text-muted">USD</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" onclick="saveCashForAccount()" id="saveCashBtn" style="display: none;">
                    <i class="fas fa-save me-2"></i>{{ _('Save Changes') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">{{ _('Loading...') }}</span>
    </div>
    <p class="mt-2 text-muted">{{ _('Loading portfolio data...') }}</p>
</div>

{% endblock %}

{% block scripts %}
<script>
// Âä†ËΩΩÊèêÁ§∫ÂáΩÊï∞
function showLoadingOverlay(message) {
    const msg = message || 'Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...';
    const loadingSpinner = document.getElementById('loading-spinner');
    if (loadingSpinner) {
        const messageElement = loadingSpinner.querySelector('p');
        if (messageElement) {
            messageElement.textContent = msg;
        }
        loadingSpinner.style.display = 'block';
    }
    
    // Â¶ÇÊûúGlobalLoadingÂèØÁî®Ôºå‰πü‰ΩøÁî®ÂÆÉ
    if (window.GlobalLoading && typeof GlobalLoading.manualShow === 'function') {
        GlobalLoading.manualShow(msg);
    } else if (window.GlobalLoading && typeof GlobalLoading.show === 'function') {
        GlobalLoading.show(msg);
    }
}

function hideLoadingOverlay() {
    const loadingSpinner = document.getElementById('loading-spinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'none';
    }
    
    // Â∞ùËØïÈöêËóèÊâÄÊúâÂèØËÉΩÁöÑÂä†ËΩΩÊèêÁ§∫
    const allLoadingElements = document.querySelectorAll('[id*="loading"], [class*="loading"], [class*="spinner"]');
    allLoadingElements.forEach(element => {
        if (element.style.display !== 'none') {
            element.style.display = 'none';
        }
    });
    
    // Â¶ÇÊûúGlobalLoadingÂèØÁî®Ôºå‰πü‰ΩøÁî®ÂÆÉ
    if (window.GlobalLoading && typeof GlobalLoading.manualHide === 'function') {
        GlobalLoading.manualHide(300);
    } else if (window.GlobalLoading && typeof GlobalLoading.hide === 'function') {
        GlobalLoading.hide(300);
    }
}

// ÂºÇÊ≠•Âä†ËΩΩËÇ°Á•®‰ª∑Ê†ºÊï∞ÊçÆ
function loadStockPricesAsync(forceRefresh = false) {
    if (forceRefresh) {
        showLoadingOverlay('Ê≠£Âú®Âº∫Âà∂Êõ¥Êñ∞ËÇ°Á•®‰ª∑Ê†º...');
    } else {
        showLoadingOverlay('Ê≠£Âú®Ëé∑ÂèñËÇ°Á•®‰ª∑Ê†º...');
    }
    
    // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ÁöÑËøáÊª§ÂèÇÊï∞
    const accountId = {{ account_id if account_id else 'null' }};
    const memberId = {{ member_id if member_id else 'null' }};
    
    // Ë∞ÉÁî®ÂºÇÊ≠•APIËé∑ÂèñËÇ°Á•®‰ª∑Ê†º
    fetch('/api/overview/update-prices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            account_id: accountId,
            member_id: memberId,
            force_refresh: forceRefresh  // Ê∑ªÂä†Âº∫Âà∂Âà∑Êñ∞ÂèÇÊï∞
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Êõ¥Êñ∞È°µÈù¢Êï∞ÊçÆ
            updatePortfolioData(data);
            hideLoadingOverlay();
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            if (forceRefresh) {
                showSuccessToast('ËÇ°Á•®‰ª∑Ê†ºÂ∑≤Âº∫Âà∂Êõ¥Êñ∞');
            } else {
                showSuccessToast('ËÇ°Á•®‰ª∑Ê†ºÂ∑≤Êõ¥Êñ∞');
            }
        } else {
            hideLoadingOverlay();
            showErrorToast('Ëé∑ÂèñËÇ°Á•®‰ª∑Ê†ºÂ§±Ë¥•: ' + (data.error || 'Êú™Áü•ÈîôËØØ'));
        }
    })
    .catch(error => {
        console.error('Error loading stock prices:', error);
        hideLoadingOverlay();
        showErrorToast('Ëé∑ÂèñËÇ°Á•®‰ª∑Ê†ºÊó∂ÂèëÁîüÈîôËØØ');
    });
}

// Êõ¥Êñ∞ÊäïËµÑÁªÑÂêàÊï∞ÊçÆ
function updatePortfolioData(data) {
    console.log('Êõ¥Êñ∞ÊäïËµÑÁªÑÂêàÊï∞ÊçÆ:', data);
    
    // Êõ¥Êñ∞ÊåÅ‰ªìË°®Ê†º
    if (data.holdings && data.holdings.length > 0) {
        updateHoldingsTable(data.holdings);
    }
    
    // Â∑≤Ê∏Ö‰ªìË°®Ê†º‰∏éÂΩìÂâçËÇ°‰ª∑Êó†ÂÖ≥Ôºå‰∏çÈúÄË¶ÅÂºÇÊ≠•Êõ¥Êñ∞
    // if (data.cleared_holdings && data.cleared_holdings.length > 0) {
    //     updateClearedHoldingsTable(data.cleared_holdings);
    // }
    
    // Êõ¥Êñ∞ÊåáÊ†áÊï∞ÊçÆ
    if (data.metrics) {
        updateMetrics(data.metrics);
    }
    
    // Êõ¥Êñ∞Êó•ÂèòÂåñÊï∞ÊçÆ
    if (data.daily_change) {
        updateDailyChange(data.daily_change);
    }
    
    // Êõ¥Êñ∞Ê±áÁéáÊï∞ÊçÆ
    if (data.exchange_rates) {
        updateExchangeRates(data.exchange_rates);
    }
    
    // ÊòæÁ§∫Êõ¥Êñ∞ÁªìÊûú
    if (data.update_result) {
        const updated = data.update_result.updated || 0;
        const failed = data.update_result.failed || 0;
        if (updated > 0) {
            showSuccessToast(`ÊàêÂäüÊõ¥Êñ∞ ${updated} Âè™ËÇ°Á•®‰ª∑Ê†º`);
        }
        if (failed > 0) {
            showErrorToast(`${failed} Âè™ËÇ°Á•®‰ª∑Ê†ºÊõ¥Êñ∞Â§±Ë¥•`);
        }
    }
}

// Êõ¥Êñ∞Êó•ÂèòÂåñÊï∞ÊçÆ
function updateDailyChange(dailyChange) {
    // Êõ¥Êñ∞Êó•ÂèòÂåñÊåáÊ†áÊòæÁ§∫
    const dailyChangeElements = document.querySelectorAll('[data-daily-change]');
    dailyChangeElements.forEach(element => {
        const currency = element.getAttribute('data-daily-change') || 'cad';
        const value = dailyChange[currency] || 0;
        element.textContent = formatCurrency(value, currency);
        
        // Ê∑ªÂä†È¢úËâ≤Ê†∑Âºè
        if (value > 0) {
            element.classList.add('text-success');
            element.classList.remove('text-danger');
        } else if (value < 0) {
            element.classList.add('text-danger');
            element.classList.remove('text-success');
        } else {
            element.classList.remove('text-success', 'text-danger');
        }
    });
}

// Êõ¥Êñ∞ÊåÅ‰ªìË°®Ê†º
function updateHoldingsTable(holdings) {
    const tbody = document.querySelector('#holdingsTable tbody');
    if (!tbody) return;
    
    console.log('Êõ¥Êñ∞ÊåÅ‰ªìË°®Ê†ºÔºåÊï∞ÊçÆ:', holdings);
    
    // ÂàõÂª∫ÊåÅ‰ªìÊï∞ÊçÆÊò†Â∞ÑÔºåÊåâsymbol+currency‰Ωú‰∏∫key
    const holdingsMap = new Map();
    holdings.forEach(holding => {
        const key = `${holding.symbol}_${holding.currency}`;
        holdingsMap.set(key, holding);
    });
    
    // Êõ¥Êñ∞Áé∞ÊúâË°åÔºåËÄå‰∏çÊòØÈáçÊñ∞ÁîüÊàêÊï¥‰∏™Ë°®Ê†º
    const existingRows = tbody.querySelectorAll('tr');
    existingRows.forEach(row => {
        const symbol = row.getAttribute('data-symbol');
        const currency = row.getAttribute('data-currency');
        const key = `${symbol}_${currency}`;
        const updatedHolding = holdingsMap.get(key);
        
        if (updatedHolding) {
            // Âè™Êõ¥Êñ∞ÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÂçïÂÖÉÊ†º
            updateHoldingRowData(row, updatedHolding);
        }
    });
    
    // ÈöêËóè"No holdings found"ÊèêÁ§∫
    const cardBody = document.querySelector('#holdingsTable').closest('.card-body');
    const noHoldingsDiv = cardBody ? cardBody.querySelector('.text-center.py-5') : null;
    if (noHoldingsDiv) {
        noHoldingsDiv.style.display = 'none';
    }
}

// Êõ¥Êñ∞ÊåÅ‰ªìË°åÊï∞ÊçÆÔºàÂè™Êõ¥Êñ∞‰ª∑Ê†ºÁõ∏ÂÖ≥ÁöÑÂçïÂÖÉÊ†ºÔºâ
function updateHoldingRowData(row, holding) {
    const cells = row.querySelectorAll('td');
    
    // Êõ¥Êñ∞ÂΩìÂâç‰ª∑Ê†ºÔºàÁ¨¨4ÂàóÔºåÁ¥¢Âºï3Ôºâ
    if (cells[3] && holding.current_price) {
        const priceSpan = cells[3].querySelector('span');
        if (priceSpan) {
            priceSpan.textContent = '$' + parseFloat(holding.current_price).toFixed(2);
        }
    }
    
    // Êõ¥Êñ∞Daily ChangeÔºàÁ¨¨5ÂàóÔºåÁ¥¢Âºï4Ôºâ
    if (cells[4] && holding.daily_change_value !== undefined) {
        const dailyValue = parseFloat(holding.daily_change_value);
        const dailyPercent = parseFloat(holding.daily_change_percent || 0);
        const sign = dailyValue >= 0 ? '+' : '-';
        const percentSign = dailyPercent >= 0 ? '+' : '';
        
        // Êõ¥Êñ∞ÈáëÈ¢ù
        const valueSpan = cells[4].querySelector('span.fw-medium');
        if (valueSpan) {
            valueSpan.textContent = sign + '$' + Math.abs(dailyValue).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            valueSpan.className = 'fw-medium ' + (dailyValue >= 0 ? 'text-success' : 'text-danger');
        }
        
        // Êõ¥Êñ∞ÁôæÂàÜÊØî
        const percentSpan = cells[4].querySelector('small');
        if (percentSpan) {
            percentSpan.textContent = percentSign + dailyPercent.toFixed(2) + '%';
            percentSpan.className = (dailyPercent >= 0 ? 'text-success' : 'text-danger');
        }
    }
    
    // Êõ¥Êñ∞ÂΩìÂâç‰ª∑ÂÄºÔºàÁ¨¨6ÂàóÔºåÁ¥¢Âºï5Ôºâ
    if (cells[5] && holding.current_value) {
        const valueSpan = cells[5].querySelector('span');
        if (valueSpan) {
            valueSpan.textContent = '$' + parseFloat(holding.current_value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    }
    
    // Êõ¥Êñ∞Êú™ÂÆûÁé∞Êî∂ÁõäÔºàÁ¨¨7ÂàóÔºåÁ¥¢Âºï6Ôºâ- ÂÖàÊòæÁ§∫ÈáëÈ¢ùÔºåÂÜçÊòæÁ§∫Êî∂ÁõäÁéá
    if (cells[6] && holding.unrealized_gain !== undefined) {
        const unrealizedGain = parseFloat(holding.unrealized_gain || 0);
        const unrealizedGainPercent = parseFloat(holding.unrealized_gain_percent || 0);
        const gainSign = unrealizedGain >= 0 ? '+' : '';
        const percentSign = unrealizedGainPercent >= 0 ? '+' : '';
        
        // Êõ¥Êñ∞‰∏ªË¶ÅÊòæÁ§∫ÔºàÈáëÈ¢ùÔºâ
        const span = cells[6].querySelector('span');
        if (span) {
            span.textContent = gainSign + '$' + Math.abs(unrealizedGain).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            span.className = 'fw-bold ' + (unrealizedGain >= 0 ? 'text-success' : 'text-danger');
        }
        
        // Êõ¥Êñ∞Â∞èÂ≠óÊòæÁ§∫ÔºàÊî∂ÁõäÁéáÔºâ
        const smallSpan = cells[6].querySelector('small');
        if (smallSpan) {
            smallSpan.textContent = percentSign + unrealizedGainPercent.toFixed(1) + '%';
            smallSpan.className = 'text-muted ' + (unrealizedGainPercent >= 0 ? 'text-success' : 'text-danger');
        }
    }
    
    // Êõ¥Êñ∞Â∑≤ÂÆûÁé∞Êî∂ÁõäÔºàÁ¨¨8ÂàóÔºåÁ¥¢Âºï7Ôºâ
    if (cells[7] && holding.realized_gain !== undefined) {
        const realizedGain = parseFloat(holding.realized_gain);
        const sign = realizedGain >= 0 ? '+' : '-';
        const span = cells[7].querySelector('span');
        if (span) {
            span.textContent = sign + '$' + Math.abs(realizedGain).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            span.className = 'fw-medium ' + (realizedGain >= 0 ? 'text-success' : 'text-danger');
        }
    }
    
    // Êõ¥Êñ∞ÊÄªÊî∂ÁõäÁéáÔºàÊúÄÂêé‰∏ÄÂàóÔºâ- ËÆ°ÁÆóÊâÄÊúâÊó∂Èó¥ÁöÑÊÄªÊî∂ÁõäÁéá
    if (cells[cells.length - 1]) {
        const unrealizedGain = parseFloat(holding.unrealized_gain || 0);
        const realizedGain = parseFloat(holding.realized_gain || 0);
        const dividends = parseFloat(holding.dividends || 0);
        const interest = parseFloat(holding.interest || 0);
        const totalCost = parseFloat(holding.total_cost || 0);
        
        const totalGain = unrealizedGain + realizedGain + dividends + interest;
        const totalReturnPercent = totalCost > 0 ? (totalGain / totalCost * 100) : 0;
        
        const sign = totalReturnPercent >= 0 ? '+' : '';
        const badge = cells[cells.length - 1].querySelector('.badge');
        if (badge) {
            badge.textContent = sign + totalReturnPercent.toFixed(1) + '%';
            badge.className = 'badge ' + (totalReturnPercent >= 0 ? 'bg-success' : 'bg-danger');
        }
    }
}

// Êõ¥Êñ∞Â∑≤Ê∏Ö‰ªìË°®Ê†º
function updateClearedHoldingsTable(clearedHoldings) {
    const tbody = document.querySelector('#clearedHoldingsTable tbody');
    if (!tbody) return;
    
    console.log('Êõ¥Êñ∞Ê∏Ö‰ªìË°®Ê†ºÔºåÊï∞ÊçÆ:', clearedHoldings);
    
    // ÂàõÂª∫Â∑≤Ê∏Ö‰ªìÊï∞ÊçÆÊò†Â∞Ñ
    const clearedHoldingsMap = new Map();
    clearedHoldings.forEach(holding => {
        const key = `${holding.symbol}_${holding.currency}`;
        clearedHoldingsMap.set(key, holding);
    });
    
    // Êõ¥Êñ∞Áé∞ÊúâË°åÔºåËÄå‰∏çÊòØÈáçÊñ∞ÁîüÊàêÊï¥‰∏™Ë°®Ê†º
    const existingRows = tbody.querySelectorAll('tr');
    existingRows.forEach(row => {
        const symbol = row.getAttribute('data-symbol');
        const currency = row.getAttribute('data-currency');
        const key = `${symbol}_${currency}`;
        const updatedHolding = clearedHoldingsMap.get(key);
        
        if (updatedHolding) {
            // Âè™Êõ¥Êñ∞ÈúÄË¶ÅÊõ¥Êñ∞ÁöÑÂçïÂÖÉÊ†º
            updateClearedHoldingRowData(row, updatedHolding);
        }
    });
    
    // ÈöêËóè"No cleared holdings found"ÊèêÁ§∫
    const cardBody = document.querySelector('#clearedHoldingsTable').closest('.card-body');
    const noClearedHoldingsDiv = cardBody ? cardBody.querySelector('.text-center.py-5') : null;
    if (noClearedHoldingsDiv) {
        noClearedHoldingsDiv.style.display = 'none';
    }
}


// Êõ¥Êñ∞Â∑≤Ê∏Ö‰ªìË°åÊï∞ÊçÆÔºàÂè™Êõ¥Êñ∞‰ª∑Ê†ºÁõ∏ÂÖ≥ÁöÑÂçïÂÖÉÊ†ºÔºâ
function updateClearedHoldingRowData(row, holding) {
    const cells = row.querySelectorAll('td');
    
    // Êõ¥Êñ∞Â∑≤ÂÆûÁé∞Êî∂ÁõäÔºàÁ¨¨4ÂàóÔºåÁ¥¢Âºï3Ôºâ
    if (cells[3] && holding.realized_gain !== undefined) {
        const realizedGain = parseFloat(holding.realized_gain);
        const sign = realizedGain >= 0 ? '+' : '';
        const span = cells[3].querySelector('span');
        if (span) {
            span.textContent = sign + '$' + realizedGain.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            span.className = 'fw-bold ' + (realizedGain >= 0 ? 'text-success' : 'text-danger');
        }
    }
    
    // Êõ¥Êñ∞Â∑≤ÂÆûÁé∞Êî∂ÁõäÁéáÔºàÁ¨¨5ÂàóÔºåÁ¥¢Âºï4Ôºâ
    if (cells[4] && holding.realized_gain_percent !== undefined) {
        const percent = parseFloat(holding.realized_gain_percent);
        const sign = percent >= 0 ? '+' : '';
        const span = cells[4].querySelector('span');
        if (span) {
            span.textContent = sign + percent.toFixed(1) + '%';
            span.className = 'fw-bold ' + (percent >= 0 ? 'text-success' : 'text-danger');
        }
    }
}

// ÂàõÂª∫ÊåÅ‰ªìË°å
function createHoldingRow(holding) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <div class="stock-avatar bg-primary text-white rounded-circle me-2">
                    ${holding.symbol ? holding.symbol.substring(0, 2).toUpperCase() : '??'}
                </div>
                <div>
                    <div class="fw-bold">${holding.symbol || 'N/A'}</div>
                    <small class="text-muted">${holding.company_name || 'Unknown Company'}</small>
                </div>
            </div>
        </td>
        <td>${holding.shares || 0}</td>
        <td>$${parseFloat(holding.average_cost || 0).toFixed(2)}</td>
        <td>$${parseFloat(holding.current_price || 0).toFixed(2)}</td>
        <td>$${parseFloat(holding.market_value || 0).toFixed(2)}</td>
        <td>
            <span class="badge ${parseFloat(holding.unrealized_gain || 0) >= 0 ? 'bg-success' : 'bg-danger'}">
                ${parseFloat(holding.unrealized_gain || 0) >= 0 ? '+' : ''}$${parseFloat(holding.unrealized_gain || 0).toFixed(2)}
            </span>
        </td>
        <td>
            <span class="badge ${parseFloat(holding.return_percent || 0) >= 0 ? 'bg-success' : 'bg-danger'}">
                ${parseFloat(holding.return_percent || 0) >= 0 ? '+' : ''}${parseFloat(holding.return_percent || 0).toFixed(2)}%
            </span>
        </td>
    `;
    return row;
}

// ÂàõÂª∫Â∑≤Ê∏Ö‰ªìË°å
function createClearedHoldingRow(holding) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <div class="stock-avatar bg-secondary text-white rounded-circle me-2">
                    ${holding.symbol ? holding.symbol.substring(0, 2).toUpperCase() : '??'}
                </div>
                <div>
                    <div class="fw-bold">${holding.symbol || 'N/A'}</div>
                    <small class="text-muted">${holding.company_name || 'Unknown Company'}</small>
                </div>
            </div>
        </td>
        <td>${holding.total_bought_shares || 0}</td>
        <td>${holding.total_sold_shares || 0}</td>
        <td>$${parseFloat(holding.total_invested || 0).toFixed(2)}</td>
        <td>$${parseFloat(holding.total_received || 0).toFixed(2)}</td>
        <td>
            <span class="badge ${parseFloat(holding.realized_gain || 0) >= 0 ? 'bg-success' : 'bg-danger'}">
                ${parseFloat(holding.realized_gain || 0) >= 0 ? '+' : ''}$${parseFloat(holding.realized_gain || 0).toFixed(2)}
            </span>
        </td>
    `;
    return row;
}

// Êõ¥Êñ∞ÊåáÊ†áÊï∞ÊçÆ
function updateMetrics(metrics) {
    // Êõ¥Êñ∞ÊÄªËµÑ‰∫ß
    const totalAssetsElement = document.getElementById('total-assets-display');
    if (totalAssetsElement && metrics.total_assets) {
        totalAssetsElement.textContent = '$' + parseFloat(metrics.total_assets.cad || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // Êõ¥Êñ∞ÊÄªËµÑ‰∫ßÂàÜËß£
    const totalAssetsCadElement = document.getElementById('total-assets-breakdown-cad');
    const totalAssetsUsdElement = document.getElementById('total-assets-breakdown-usd');
    if (metrics.total_assets) {
        const cadOnly = parseFloat(metrics.total_assets.cad_only || 0);
        const usdOnly = parseFloat(metrics.total_assets.usd_only || 0);
        if (totalAssetsCadElement) {
            totalAssetsCadElement.textContent = `CAD:$${cadOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        if (totalAssetsUsdElement) {
            totalAssetsUsdElement.textContent = `USD:$${usdOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    }
    
    // Êõ¥Êñ∞ÊÄªÂõûÊä•
    const totalReturnElement = document.getElementById('total-return-display');
    if (totalReturnElement && metrics.total_return) {
        const totalReturn = parseFloat(metrics.total_return.cad || 0);
        const sign = totalReturn >= 0 ? '+' : '';
        totalReturnElement.textContent = sign + '$' + totalReturn.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        totalReturnElement.className = totalReturn >= 0 ? 'text-success' : 'text-danger';
    }
    
    // Êõ¥Êñ∞ÊÄªÂõûÊä•ÂàÜËß£
    const totalReturnCadElement = document.getElementById('total-return-breakdown-cad');
    const totalReturnUsdElement = document.getElementById('total-return-breakdown-usd');
    if (metrics.total_return) {
        const cadOnly = parseFloat(metrics.total_return.cad_only || 0);
        const usdOnly = parseFloat(metrics.total_return.usd_only || 0);
        if (totalReturnCadElement) {
            totalReturnCadElement.textContent = `CAD:$${cadOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        if (totalReturnUsdElement) {
            totalReturnUsdElement.textContent = `USD:$${usdOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    }
    
    // Êõ¥Êñ∞ÂõûÊä•Áéá
    const returnRateElement = document.getElementById('total-return-rate-display');
    if (returnRateElement && metrics.total_return_rate) {
        const rate = parseFloat(metrics.total_return_rate || 0);
        const rateSign = rate >= 0 ? '+' : '';
        returnRateElement.textContent = '(' + rateSign + rate.toFixed(2) + '%)';
        returnRateElement.className = 'ms-2 ' + (rate >= 0 ? 'text-success' : 'text-danger');
    }
    
    // Êõ¥Êñ∞Â∑≤ÂÆûÁé∞Êî∂Áõä
    const realizedGainElement = document.getElementById('realized-gain-display');
    if (realizedGainElement && metrics.realized_gain) {
        const realizedGain = parseFloat(metrics.realized_gain.cad || 0);
        const sign = realizedGain >= 0 ? '+' : '';
        realizedGainElement.textContent = sign + '$' + realizedGain.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        realizedGainElement.className = realizedGain >= 0 ? 'text-success' : 'text-danger';
    }
    
    // Êõ¥Êñ∞Â∑≤ÂÆûÁé∞Êî∂ÁõäÂàÜËß£
    const realizedGainCadElement = document.getElementById('realized-gain-breakdown-cad');
    const realizedGainUsdElement = document.getElementById('realized-gain-breakdown-usd');
    if (metrics.realized_gain) {
        const cadOnly = parseFloat(metrics.realized_gain.cad_only || 0);
        const usdOnly = parseFloat(metrics.realized_gain.usd_only || 0);
        if (realizedGainCadElement) {
            realizedGainCadElement.textContent = `CAD:$${cadOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        if (realizedGainUsdElement) {
            realizedGainUsdElement.textContent = `USD:$${usdOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    }
    
    // Êõ¥Êñ∞Êú™ÂÆûÁé∞Êî∂Áõä
    const unrealizedGainElement = document.getElementById('unrealized-gain-display');
    if (unrealizedGainElement && metrics.unrealized_gain) {
        const unrealizedGain = parseFloat(metrics.unrealized_gain.cad || 0);
        const sign = unrealizedGain >= 0 ? '+' : '';
        unrealizedGainElement.textContent = sign + '$' + unrealizedGain.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        unrealizedGainElement.className = unrealizedGain >= 0 ? 'text-success' : 'text-danger';
    }
    
    // Êõ¥Êñ∞Êú™ÂÆûÁé∞Êî∂ÁõäÂàÜËß£
    const unrealizedGainCadElement = document.getElementById('unrealized-gain-breakdown-cad');
    const unrealizedGainUsdElement = document.getElementById('unrealized-gain-breakdown-usd');
    if (metrics.unrealized_gain) {
        const cadOnly = parseFloat(metrics.unrealized_gain.cad_only || 0);
        const usdOnly = parseFloat(metrics.unrealized_gain.usd_only || 0);
        if (unrealizedGainCadElement) {
            unrealizedGainCadElement.textContent = `CAD:$${cadOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        if (unrealizedGainUsdElement) {
            unrealizedGainUsdElement.textContent = `USD:$${usdOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    }
    
    // Êõ¥Êñ∞ÂΩìÊó•ÊµÆÂä®Áõà‰∫è
    const dailyChangeElement = document.getElementById('daily-change-display');
    if (dailyChangeElement && metrics.daily_change) {
        const dailyChange = parseFloat(metrics.daily_change.cad || 0);
        const sign = dailyChange >= 0 ? '+' : '';
        dailyChangeElement.textContent = sign + '$' + dailyChange.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        dailyChangeElement.className = dailyChange >= 0 ? 'text-success' : 'text-danger';
    }
    
    // Êõ¥Êñ∞ÂΩìÊó•ÂèòÂåñÂàÜËß£
    const dailyChangeCadElement = document.getElementById('daily-change-breakdown-cad');
    const dailyChangeUsdElement = document.getElementById('daily-change-breakdown-usd');
    if (metrics.daily_change) {
        const cadOnly = parseFloat(metrics.daily_change.cad_only || 0);
        const usdOnly = parseFloat(metrics.daily_change.usd_only || 0);
        if (dailyChangeCadElement) {
            dailyChangeCadElement.textContent = `CAD:$${cadOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        if (dailyChangeUsdElement) {
            dailyChangeUsdElement.textContent = `USD:$${usdOnly.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    }
    
    // Êõ¥Êñ∞Áé∞Èáë‰ΩôÈ¢ù
    const cashBalanceElement = document.getElementById('cash-balance-display');
    if (cashBalanceElement && metrics.cash_balance) {
        const cashBalance = parseFloat(metrics.cash_balance.cad || 0);
        cashBalanceElement.textContent = '$' + cashBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
}

// Êõ¥Êñ∞Ê±áÁéáÊï∞ÊçÆ
function updateExchangeRates(exchangeRates) {
    // ËøôÈáåÂèØ‰ª•Êõ¥Êñ∞Ê±áÁéáÁõ∏ÂÖ≥ÁöÑÊòæÁ§∫
}

// ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 3000);
}

// ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
function showErrorToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 5000);
}

// Âà∑Êñ∞ÊäïËµÑÁªÑÂêàÊï∞ÊçÆ
function refreshPortfolioData() {
    loadStockPricesAsync(true);  // Âº∫Âà∂Êõ¥Êñ∞ËÇ°Á•®‰ª∑Ê†º
}

// È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥ÊòæÁ§∫È°µÈù¢ÔºåÁÑ∂ÂêéÂºÇÊ≠•Êõ¥Êñ∞Êï∞ÊçÆ
document.addEventListener('DOMContentLoaded', function() {
    // ÂºÇÊ≠•ÁâàÊú¨ÔºöÈ°µÈù¢Á´ãÂç≥ÊòæÁ§∫ÔºåÁÑ∂ÂêéÂºÇÊ≠•Âä†ËΩΩÊï∞ÊçÆ
    console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂºÇÊ≠•Êõ¥Êñ∞Êï∞ÊçÆ...');
    
    // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    showLoadingOverlay('Ê≠£Âú®Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ...');
    
    // ÂºÇÊ≠•Âä†ËΩΩËÇ°Á•®‰ª∑Ê†ºÂíåÊäïËµÑÁªÑÂêàÊï∞ÊçÆ
    loadStockPricesAsync(false);
});
</script>

<style>
.sortable {
    user-select: none;
    transition: background-color 0.2s ease;
}

.sortable:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.sort-icon {
    opacity: 0.3;
    transition: opacity 0.2s ease;
    font-size: 0.8rem;
}

.sortable:hover .sort-icon {
    opacity: 0.7;
}

.sortable .fa-sort-up,
.sortable .fa-sort-down {
    opacity: 1;
    color: #007bff;
}

.holdings-table {
    position: relative;
}

.holdings-table tbody tr {
    transition: all 0.3s ease;
}

.sort-region {
    padding: 2px 4px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
    font-size: 0.9rem;
}

.sort-region {
    padding: 2px 4px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
}

.sort-region:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.sort-region.sortable {
    cursor: pointer;
}

.sort-region .sort-icon {
    opacity: 0.4;
}

.sort-region:hover .sort-icon {
    opacity: 0.8;
}

.sort-region .fa-sort-up,
.sort-region .fa-sort-down {
    opacity: 1;
    color: #007bff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ê∑ªÂä†ÊåÅ‰ªìË°®Ê†ºÊêúÁ¥¢ÂäüËÉΩ
    const holdingsTable = document.querySelector('.holdings-table');
    if (holdingsTable) {
        // Ê∑ªÂä†ÊêúÁ¥¢Ê°Ü
        const searchContainer = document.createElement('div');
        searchContainer.className = 'row mb-3';
        searchContainer.innerHTML = `
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="holdingsSearch" 
                           placeholder="{{ _('Search stocks...') }}">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    <span id="holdingsCount">{{ holdings|length if holdings else 0 }}</span> 
                    {{ _('holdings displayed') }}
                </small>
            </div>
        `;
        
        const tableCard = holdingsTable.closest('.card');
        if (tableCard) {
            tableCard.querySelector('.card-body').insertBefore(searchContainer, tableCard.querySelector('.table-responsive'));
        }
        
        // ÊêúÁ¥¢ÂäüËÉΩÂÆûÁé∞
        const searchInput = document.getElementById('holdingsSearch');
        const tableRows = holdingsTable.querySelectorAll('tbody tr');
        const countSpan = document.getElementById('holdingsCount');
        
        searchInput?.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;
            
            tableRows.forEach(row => {
                const symbol = row.querySelector('td:first-child strong')?.textContent.toLowerCase() || '';
                const sector = row.querySelector('td:first-child small')?.textContent.toLowerCase() || '';
                
                const isVisible = symbol.includes(searchTerm) || 
                                sector.includes(searchTerm);
                
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            if (countSpan) {
                countSpan.textContent = visibleCount;
            }
        });
    }
    
    // Ê∑ªÂä†ÊåáÊ†áÂç°ÁâáÁÇπÂáªÂä®ÁîªÊïàÊûú
    const metricCards = document.querySelectorAll('.metric-card');
    metricCards.forEach(card => {
        card.addEventListener('click', function() {
            this.style.transform = 'scale(0.98)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
    
    // Ê∑ªÂä†Ê∏Ö‰ªìÊåÅ‰ªìË°®Ê†ºÊêúÁ¥¢ÂäüËÉΩ
    const clearedHoldingsTable = document.querySelector('#clearedHoldingsTable');
    if (clearedHoldingsTable) {
        // Ê∑ªÂä†ÊêúÁ¥¢Ê°Ü
        const searchContainer = document.createElement('div');
        searchContainer.className = 'row mb-3';
        searchContainer.innerHTML = `
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="clearedHoldingsSearch" 
                           placeholder="{{ _('Search cleared stocks...') }}">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <small class="text-muted">
                    <span id="clearedHoldingsCount">{{ cleared_holdings|length if cleared_holdings else 0 }}</span> 
                    {{ _('cleared holdings displayed') }}
                </small>
            </div>
        `;
        
        const tableCard = clearedHoldingsTable.closest('.card');
        if (tableCard) {
            tableCard.querySelector('.card-body').insertBefore(searchContainer, tableCard.querySelector('.table-responsive'));
        }
        
        // ÊêúÁ¥¢ÂäüËÉΩÂÆûÁé∞
        const searchInput = document.getElementById('clearedHoldingsSearch');
        const tableRows = clearedHoldingsTable.querySelectorAll('tbody tr');
        const countSpan = document.getElementById('clearedHoldingsCount');
        
        searchInput?.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;
            
            tableRows.forEach(row => {
                const symbol = row.querySelector('td:first-child strong')?.textContent.toLowerCase() || '';
                const sector = row.querySelector('td:first-child small')?.textContent.toLowerCase() || '';
                
                const isVisible = symbol.includes(searchTerm) || 
                                sector.includes(searchTerm);
                
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            if (countSpan) {
                countSpan.textContent = visibleCount;
            }
        });
    }
    
    // Â∑•ÂÖ∑ÊèêÁ§∫ÂäüËÉΩ
    const tooltipElements = document.querySelectorAll('[title]');
    tooltipElements.forEach(element => {
        if (element.title) {
            element.setAttribute('data-bs-toggle', 'tooltip');
            element.setAttribute('data-bs-placement', 'top');
        }
    });
    
    // ÂàùÂßãÂåñ Bootstrap Â∑•ÂÖ∑ÊèêÁ§∫
    if (typeof bootstrap !== 'undefined') {
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
    }
});

// Ê†ºÂºèÂåñÊï∞Â≠óÊòæÁ§∫ÔºàÂèØÊâ©Â±ïÔºâ
function formatCurrency(amount, currency = 'CAD') {
    return new Intl.NumberFormat('en-CA', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function formatPercent(value) {
    const sign = value >= 0 ? '+' : '';
    return `${sign}${value.toFixed(1)}%`;
}

// Cash Management Functions
let accountsData = [];
let exchangeRate = {{ exchange_rates['usd_to_cad'] if exchange_rates else 1.35 }};

function openCashModal() {
    // Load accounts data
    loadAccountsCashData();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cashModal'));
    modal.show();
}

function loadAccountsCashData() {
    fetch('/api/accounts/cash-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                accountsData = data.accounts;
                populateAccountSelect();
            } else {
                alert('{{ _("Error loading accounts data: ") }}' + (data.error || '{{ _("Unknown error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ _("Error loading accounts data. Please try again.") }}');
        });
}

function populateAccountSelect() {
    const accountSelect = document.getElementById('accountSelect');
    accountSelect.innerHTML = '<option value="">{{ _("Please select an account...") }}</option>';
    
    accountsData.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.name} (${account.owners}) - ${account.type}`;
        accountSelect.appendChild(option);
    });
    
    // Â¶ÇÊûúÂΩìÂâçÈ°µÈù¢ÊúâÈÄâ‰∏≠ÁöÑË¥¶Êà∑ÔºåÈªòËÆ§ÈÄâÊã©ÂÆÉ
    const currentAccountId = {{ account_id if account_id else 'null' }};
    if (currentAccountId) {
        accountSelect.value = currentAccountId;
        // Ëß¶ÂèëÈÄâÊã©‰∫ã‰ª∂‰ª•ÊòæÁ§∫ËØ•Ë¥¶Êà∑ÁöÑÁé∞ÈáëËæìÂÖ•Ë°®Âçï
        onAccountSelected();
    }
}

function onAccountSelected() {
    const accountSelect = document.getElementById('accountSelect');
    const selectedAccountId = accountSelect.value;
    const cashInputSection = document.getElementById('cashInputSection');
    
    if (selectedAccountId) {
        // Find the selected account data
        const selectedAccount = accountsData.find(account => account.id == selectedAccountId);
        
        if (selectedAccount) {
            // Update the account info display
            const accountInfo = document.getElementById('selectedAccountInfo');
            accountInfo.innerHTML = `
                <i class="fas fa-edit me-2"></i>{{ _('Cash Balance for') }} ${selectedAccount.name} (${selectedAccount.owners})
            `;
            
            // Populate current cash values
            document.getElementById('cadInput').value = selectedAccount.cash.cad || 0;
            document.getElementById('usdInput').value = selectedAccount.cash.usd || 0;
            
            // Show the input section and save button
            cashInputSection.style.display = 'block';
            document.getElementById('saveCashBtn').style.display = 'inline-block';
        }
    } else {
        // Hide the input section and save button
        cashInputSection.style.display = 'none';
        document.getElementById('saveCashBtn').style.display = 'none';
    }
}

function saveCashForAccount() {
    const accountSelect = document.getElementById('accountSelect');
    const selectedAccountId = accountSelect.value;
    
    if (!selectedAccountId) {
        alert('{{ _("Please select an account first.") }}');
        return;
    }
    
    const cadValue = parseFloat(document.getElementById('cadInput').value) || 0;
    const usdValue = parseFloat(document.getElementById('usdInput').value) || 0;
    
    const updates = [{
        account_id: parseInt(selectedAccountId),
        cad: cadValue,
        usd: usdValue
    }];
    
    // Save to server
    fetch('/api/cash/batch-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ updates: updates })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('{{ _("Cash balance updated successfully!") }}');
            
            // Update local data
            const selectedAccount = accountsData.find(account => account.id == selectedAccountId);
            if (selectedAccount) {
                selectedAccount.cash.cad = cadValue;
                selectedAccount.cash.usd = usdValue;
            }
            
            // Close modal and refresh page
            bootstrap.Modal.getInstance(document.getElementById('cashModal')).hide();
            location.reload();
        } else {
            alert('{{ _("Error updating cash balance: ") }}' + (data.error || '{{ _("Unknown error") }}'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ _("Error updating cash balance. Please try again.") }}');
    });
}

// Apply current exchange rate logic to overview metrics
document.addEventListener('DOMContentLoaded', function() {
    {% if metrics and exchange_rates %}
    // Get current exchange rate for USD to CAD conversion
    const currentRate = {{ exchange_rates['usd_to_cad'] if exchange_rates else 1.3782 }};

    // Use pre-calculated CAD values from metrics (already includes all conversions)
    const totalAssetsCorrect = {{ metrics.total_assets.cad if metrics else 0 }};
    const totalReturnCorrect = {{ metrics.total_return.cad if metrics else 0 }};
    const realizedGainCorrect = {{ metrics.realized_gain.cad if metrics else 0 }};
    const unrealizedGainCorrect = {{ metrics.unrealized_gain.cad if metrics else 0 }};

    // Recalculate return rate based on corrected values
    const totalReturnRateCorrect = totalAssetsCorrect > 0 ? (totalReturnCorrect / (totalAssetsCorrect - totalReturnCorrect)) * 100 : 0;

    // Update the DOM elements using precise ID selectors
    const totalAssetsElement = document.getElementById('total-assets-display');
    if (totalAssetsElement) {
        totalAssetsElement.textContent = '$' + totalAssetsCorrect.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Update total return display
    const totalReturnElement = document.getElementById('total-return-display');
    if (totalReturnElement) {
        const sign = totalReturnCorrect >= 0 ? '+' : '';
        totalReturnElement.textContent = sign + '$' + totalReturnCorrect.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        totalReturnElement.className = totalReturnCorrect >= 0 ? 'text-success' : 'text-danger';
    }

    // Update return rate
    const returnRateElement = document.getElementById('total-return-rate-display');
    if (returnRateElement) {
        const rateSign = totalReturnRateCorrect >= 0 ? '+' : '';
        returnRateElement.textContent = '(' + rateSign + totalReturnRateCorrect.toFixed(2) + '%)';
        returnRateElement.className = 'ms-2 ' + (totalReturnRateCorrect >= 0 ? 'text-success' : 'text-danger');
    }

    // Update realized gain display
    const realizedGainElement = document.getElementById('realized-gain-display');
    if (realizedGainElement) {
        const sign = realizedGainCorrect >= 0 ? '+' : '';
        realizedGainElement.textContent = sign + '$' + realizedGainCorrect.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        realizedGainElement.className = (realizedGainCorrect >= 0 ? 'text-success' : 'text-danger') + ' mb-1';
    }

    // Update unrealized gain display
    const unrealizedGainElement = document.getElementById('unrealized-gain-display');
    if (unrealizedGainElement) {
        const sign = unrealizedGainCorrect >= 0 ? '+' : '';
        unrealizedGainElement.textContent = sign + '$' + unrealizedGainCorrect.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        unrealizedGainElement.className = (unrealizedGainCorrect >= 0 ? 'text-success' : 'text-danger') + ' mb-1';
    }

    console.log('Overview metrics updated with current exchange rate:', currentRate);
    {% endif %}
});

// Table sorting functionality
document.addEventListener('DOMContentLoaded', function() {
    // Initialize sorting for both tables
    initTableSorting('holdingsTable');
    initTableSorting('clearedHoldingsTable');

    function initTableSorting(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        // Select both th.sortable and .sort-region.sortable elements
        const sortableElements = table.querySelectorAll('th.sortable, .sort-region.sortable');
        let currentSort = {column: null, direction: 'asc'};

        sortableElements.forEach(element => {
            element.style.cursor = 'pointer';
            element.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const sortType = this.dataset.sort;
                const sortDirection = (currentSort.column === sortType && currentSort.direction === 'asc') ? 'desc' : 'asc';

                sortTable(table, sortType, sortDirection);
                updateSortIcons(sortableElements, this, sortDirection);

                currentSort = {column: sortType, direction: sortDirection};
            });
        });
    }

    function sortTable(table, sortType, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;

            if (sortType === 'symbol' || sortType === 'company' || sortType === 'currency' || sortType === 'sector') {
                aVal = (a.dataset[sortType] || '').toLowerCase();
                bVal = (b.dataset[sortType] || '').toLowerCase();
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            } else {
                // For numeric values - handle attribute mapping
                let dataAttr = sortType;

                // Manual mapping for specific cases
                const attrMap = {
                    'avg_cost': 'avgCost',
                    'current_price': 'currentPrice',
                    'daily_change': 'dailyChange',
                    'market_value': 'marketValue',
                    'unrealized_gain': 'unrealizedGain',
                    'realized_gain': 'realizedGain',
                    'return_percent': 'returnPercent',
                    'bought_shares': 'boughtShares',
                    'sold_shares': 'soldShares',
                    'total_invested': 'totalInvested',
                    'total_received': 'totalReceived'
                };

                if (attrMap[sortType]) {
                    dataAttr = attrMap[sortType];
                } else {
                    // Fallback: convert underscore to camelCase
                    dataAttr = sortType.replace(/_([a-z])/g, (match, p1) => p1.toUpperCase());
                }

                aVal = parseFloat(a.dataset[dataAttr]) || 0;
                bVal = parseFloat(b.dataset[dataAttr]) || 0;

                if (direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            }
        });

        // Remove all rows and re-add them in sorted order
        rows.forEach(row => tbody.removeChild(row));
        rows.forEach(row => tbody.appendChild(row));
    }

    function updateSortIcons(headers, clickedHeader, direction) {
        // Reset all icons
        headers.forEach(header => {
            const icon = header.querySelector('.sort-icon');
            icon.className = 'fas fa-sort ms-1 sort-icon';
        });

        // Update clicked header icon
        const icon = clickedHeader.querySelector('.sort-icon');
        icon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} ms-1 sort-icon`;
    }
});

</script>

<!-- Transaction Creation Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTransactionModalLabel">
                    <i class="fas fa-plus me-2"></i>{{ _('Add New Transaction') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form method="POST" id="addTransactionForm" action="{{ url_for('main.create_transaction') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_account_id" class="form-label">{{ _('Account') }} <span class="text-danger">*</span></label>
                            <select class="form-select" id="modal_account_id" name="account_id" required>
                                <option value="">{{ _('Select Account') }}</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}">{{ account.name }} ({{ account.account_members|map(attribute='member.name')|join(', ') }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6" id="stock_symbol_section">
                            <label for="modal_stock_symbol" class="form-label">{{ _('Stock Symbol') }} <span class="text-danger" id="stock_required">*</span></label>
                            <input type="text" class="form-control" id="modal_stock_symbol" name="stock_symbol" 
                                   placeholder="{{ _('e.g. AAPL, SHOP.TO') }}" required>
                            <small class="form-text text-muted">{{ _('System will auto-lookup stock information') }}</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_currency" class="form-label">{{ _('Currency') }} <span class="text-danger">*</span></label>
                            <select class="form-select" id="modal_currency" name="currency" required>
                                <option value="">{{ _('Select Currency') }}</option>
                                <option value="USD">USD</option>
                                <option value="CAD">CAD</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="stock_info_section">
                            <label for="modal_stock_info" class="form-label">{{ _('Stock Information') }}</label>
                            <div id="modal_stock_info" class="form-control-plaintext">
                                <small class="text-muted">{{ _('Enter symbol and currency to lookup') }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for stock info -->
                    <input type="hidden" id="modal_stock_name" name="stock_name">
                    <input type="hidden" id="modal_exchange" name="exchange">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_transaction_type" class="form-label">{{ _('Transaction Type') }} <span class="text-danger">*</span></label>
                            <select class="form-select" id="modal_transaction_type" name="type" required>
                                <option value="">{{ _('Select Type') }}</option>
                                <optgroup label="{{ _('Stock Transactions') }}">
                                    <option value="BUY">{{ _('Buy') }}</option>
                                    <option value="SELL" selected>{{ _('Sell') }}</option>
                                </optgroup>
                                <optgroup label="{{ _('Cash Transactions') }}">
                                    <option value="DEPOSIT">{{ _('Deposit') }}</option>
                                    <option value="WITHDRAWAL">{{ _('Withdrawal') }}</option>
                                    <option value="DIVIDEND">{{ _('Dividend') }}</option>
                                    <option value="INTEREST">{{ _('Interest') }}</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="modal_trade_date" class="form-label">{{ _('Transaction Date') }} <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="modal_trade_date" name="trade_date" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4" id="quantity_section">
                            <label for="modal_quantity" class="form-label"><span id="quantity_label">{{ _('Quantity') }}</span> <span class="text-danger" id="quantity_required">*</span></label>
                            <input type="number" class="form-control" id="modal_quantity" name="quantity" 
                                   step="0.0001" min="0.0001" required>
                        </div>
                        <!-- Amount Field for cash transactions -->
                        <div class="col-md-4" id="amount_section" style="display: none;">
                            <label for="modal_amount" class="form-label"><span id="amount_label">{{ _('Amount') }}</span> <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="modal_amount" name="amount"
                                   step="0.01" min="0.01" placeholder="{{ _('Enter amount') }}">
                        </div>
                        <div class="col-md-4" id="price_section">
                            <label for="modal_price_per_share" class="form-label"><span id="price_label">{{ _('Price per Share') }}</span> <span class="text-danger" id="price_required">*</span></label>
                            <input type="number" class="form-control" id="modal_price_per_share" name="price" 
                                   step="0.01" min="0.01" required>
                        </div>
                        <div class="col-md-4" id="fee_section">
                            <label for="modal_transaction_fee" class="form-label">{{ _('Transaction Fee') }}</label>
                            <input type="number" class="form-control" id="modal_transaction_fee" name="fee" 
                                   step="0.01" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_notes" class="form-label">{{ _('Notes') }}</label>
                        <textarea class="form-control" id="modal_notes" name="notes" rows="2" 
                                  placeholder="{{ _('Optional transaction notes...') }}"></textarea>
                    </div>
                    
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">{{ _('Transaction Summary') }}</h6>
                            <div id="modal-summary-content">
                                <p class="text-muted">{{ _('Fill in the form to see transaction summary') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>{{ _('Cancel') }}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>{{ _('Create Transaction') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Function to open modal with stock pre-filled
function openAddTransactionModalForStock(symbol, currency, accountId = null) {
    console.log('Opening transaction modal for:', symbol, currency, accountId);
    
    const modalElement = document.getElementById('addTransactionModal');
    if (!modalElement) {
        console.error('Modal element not found!');
        return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    
    // Reset form to default state
    resetTransactionForm();
    
    // Pre-fill stock information
    document.getElementById('modal_stock_symbol').value = symbol;
    document.getElementById('modal_currency').value = currency;
    document.getElementById('modal_transaction_type').value = 'SELL'; // Default to sell
    
    // Smart account selection logic
    const accountSelect = document.getElementById('modal_account_id');
    if (accountId) {
        // Use provided account ID
        console.log('Using provided account ID:', accountId);
        accountSelect.value = accountId;
    } else {
        // Try to find the best account for this stock
        const currentMemberId = {{ member_id if member_id else 'null' }};
        console.log('Current member ID:', currentMemberId);
        
        try {
            const bestAccountId = findBestAccountForStock(symbol, currency, currentMemberId);
            console.log('Best account ID found:', bestAccountId);
            
            if (bestAccountId) {
                accountSelect.value = bestAccountId;
                console.log('Selected best account:', bestAccountId);
            } else if (accountSelect.options.length > 1) {
                // Fallback to first available account
                accountSelect.selectedIndex = 1;
                console.log('Fallback to first available account');
            }
        } catch (error) {
            console.error('Error in smart account selection:', error);
            // Fallback to first available account
            if (accountSelect.options.length > 1) {
                accountSelect.selectedIndex = 1;
                console.log('Error fallback to first available account');
            }
        }
    }
    
    // Trigger stock lookup
    handleStockSymbolChange();
    
    console.log('Showing modal...');
    modal.show();
}

// Function to find the best account for a specific stock
function findBestAccountForStock(symbol, currency, memberId) {
    try {
        console.log('Finding best account for:', symbol, currency, memberId);
        
        const accountSelect = document.getElementById('modal_account_id');
        if (!accountSelect) {
            console.error('Account select element not found');
            return null;
        }
        
        const options = Array.from(accountSelect.options);
        console.log('Available accounts:', options.length);
        
        // Get current member name from the page context
        const currentMemberName = getCurrentMemberName();
        console.log('Current member name:', currentMemberName);
        
        // First, try to find accounts that actually hold this stock
        // Look for the stock in the current page's holdings data
        const stockHoldings = findStockInHoldings(symbol, currency);
        console.log('Stock holdings found:', stockHoldings);
        
        if (stockHoldings && stockHoldings.length > 0) {
            // Find the account that holds this stock
            for (const holding of stockHoldings) {
                const accountId = holding.account_id;
                console.log('Found stock in account:', accountId);
                
                // Check if this account is available in the dropdown
                for (let i = 1; i < options.length; i++) {
                    if (options[i].value == accountId) {
                        console.log('Found account that holds this stock:', accountId);
                        return accountId;
                    }
                }
            }
        }
        
        // If no account holds this stock, fall back to member-based selection
        if (memberId && currentMemberName) {
            console.log('Looking for member-specific accounts for member:', currentMemberName);
            // Look for accounts that belong to the current member
            for (let i = 1; i < options.length; i++) { // Skip the first "Select Account" option
                const option = options[i];
                const accountText = option.textContent;
                console.log('Checking account:', accountText);
                
                // Check if this account belongs to the current member
                // Account text format: "Account Name (Member1, Member2)"
                if (accountText.includes('(') && accountText.includes(')')) {
                    const membersPart = accountText.split('(')[1].split(')')[0];
                    const members = membersPart.split(',').map(m => m.trim());
                    console.log('Account members:', members);
                    
                    // If current member is in this account, this is a good candidate
                    // Use more flexible matching
                    const isMemberAccount = members.some(member => {
                        const memberLower = member.toLowerCase();
                        const currentMemberLower = currentMemberName.toLowerCase();
                        return memberLower === currentMemberLower || 
                               memberLower.includes(currentMemberLower) ||
                               currentMemberLower.includes(memberLower);
                    });
                    
                    if (isMemberAccount) {
                        console.log('Found member-specific account:', option.value);
                        return option.value;
                    }
                }
            }
        }
        
        // If no member-specific account found, or no member selected, 
        // look for accounts that might have this stock based on currency
        console.log('Looking for currency-specific accounts for currency:', currency);
        for (let i = 1; i < options.length; i++) {
            const option = options[i];
            const accountText = option.textContent;
            console.log('Checking account for currency match:', accountText);
            
            // For CAD stocks, prefer accounts with CAD in the name or description
            // For USD stocks, prefer accounts with USD in the name or description
            const accountTextLower = accountText.toLowerCase();
            if (currency === 'CAD' && (accountTextLower.includes('cad') || accountTextLower.includes('canadian'))) {
                console.log('Found CAD account:', option.value);
                return option.value;
            } else if (currency === 'USD' && (accountTextLower.includes('usd') || accountTextLower.includes('us') || accountTextLower.includes('american'))) {
                console.log('Found USD account:', option.value);
                return option.value;
            }
        }
        
        // If no currency-specific account found, try to find accounts that might be suitable
        // For USD stocks, prefer accounts that might contain USD investments
        if (currency === 'USD') {
            console.log('Looking for any suitable account for USD stock...');
            for (let i = 1; i < options.length; i++) {
                const option = options[i];
                const accountText = option.textContent;
                const accountTextLower = accountText.toLowerCase();
                // Prefer accounts that might be used for USD investments
                if (accountTextLower.includes('non-registered') || accountTextLower.includes('tfsa') || accountTextLower.includes('joint')) {
                    console.log('Found suitable account for USD:', option.value);
                    return option.value;
                }
            }
        }
        
        console.log('No specific account found, returning null');
        return null;
    } catch (error) {
        console.error('Error in findBestAccountForStock:', error);
        return null;
    }
}

// Function to find stock in current page holdings
function findStockInHoldings(symbol, currency) {
    try {
        // Look for the stock in the holdings table
        const holdingsRows = document.querySelectorAll('tr[data-symbol]');
        const matchingHoldings = [];
        
        for (const row of holdingsRows) {
            const rowSymbol = row.getAttribute('data-symbol');
            const rowCurrency = row.getAttribute('data-currency');
            
            if (rowSymbol === symbol && rowCurrency === currency) {
                // Extract account information from the row
                const accountId = row.getAttribute('data-account-id');
                if (accountId) {
                    matchingHoldings.push({
                        account_id: accountId,
                        symbol: rowSymbol,
                        currency: rowCurrency
                    });
                }
            }
        }
        
        return matchingHoldings;
    } catch (error) {
        console.error('Error finding stock in holdings:', error);
        return [];
    }
}

// Function to get current member name from page context
function getCurrentMemberName() {
    // Use the current member info passed from the server
    const currentMember = {{ current_member.name|tojson if current_member else 'null' }};
    return currentMember;
}

// Handle stock symbol change for stock lookup
function handleStockSymbolChange() {
    const symbol = document.getElementById('modal_stock_symbol').value;
    const currency = document.getElementById('modal_currency').value;
    
    if (symbol && currency) {
        // Simplified stock info display - just show the symbol and currency
        document.getElementById('modal_stock_info').innerHTML = `
            <div class="d-flex align-items-center">
                <div class="me-2">
                    <strong>${symbol}</strong>
                </div>
                <div class="ms-auto">
                    <small class="text-muted">${currency}</small>
                </div>
            </div>
        `;
        
        // Set basic stock info
        document.getElementById('modal_stock_name').value = symbol;
        document.getElementById('modal_exchange').value = '';
    } else {
        document.getElementById('modal_stock_info').innerHTML = '<small class="text-muted">{{ _("Enter symbol and currency to lookup") }}</small>';
    }
}

// Add event listeners for stock symbol and currency changes
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing transaction modal...');
    
    const stockSymbolInput = document.getElementById('modal_stock_symbol');
    const currencySelect = document.getElementById('modal_currency');
    
    if (stockSymbolInput) {
        stockSymbolInput.addEventListener('input', handleStockSymbolChange);
    }
    
    if (currencySelect) {
        currencySelect.addEventListener('change', handleStockSymbolChange);
    }
    
    // Test if modal element exists
    const modalElement = document.getElementById('addTransactionModal');
    if (modalElement) {
        console.log('Modal element found:', modalElement);
    } else {
        console.error('Modal element not found!');
    }
    
    // Test if Bootstrap is available
    if (typeof bootstrap !== 'undefined') {
        console.log('Bootstrap is available');
    } else {
        console.error('Bootstrap is not available!');
    }
    
    // Test function - add a simple test button
    const testButton = document.createElement('button');
    testButton.textContent = 'Test Modal';
    testButton.className = 'btn btn-warning btn-sm';
    testButton.style.position = 'fixed';
    testButton.style.top = '10px';
    testButton.style.right = '10px';
    testButton.style.zIndex = '9999';
    testButton.onclick = function() {
        console.log('Test button clicked');
        openAddTransactionModalForStock('TEST', 'USD', null);
    };
    document.body.appendChild(testButton);
});

// Reset form to default state
function resetTransactionForm() {
    // Reset form fields
    document.getElementById('addTransactionForm').reset();
    
    // Reset visibility and requirements
    document.getElementById('stock_symbol_section').style.display = 'block';
    document.getElementById('stock_info_section').style.display = 'block';
    document.getElementById('price_section').style.display = 'block';
    document.getElementById('quantity_section').style.display = 'block';
    document.getElementById('amount_section').style.display = 'none';
    
    // Reset required fields
    document.getElementById('modal_stock_symbol').required = true;
    document.getElementById('modal_quantity').required = true;
    document.getElementById('modal_price_per_share').required = true;
    document.getElementById('modal_amount').required = false;
    
    // Reset labels
    document.getElementById('quantity_label').textContent = '{{ _("Quantity") }}';
    document.getElementById('price_label').textContent = '{{ _("Price per Share") }}';
    
    // Reset required indicators
    document.getElementById('stock_required').style.display = 'inline';
    document.getElementById('quantity_required').style.display = 'inline';
    document.getElementById('price_required').style.display = 'inline';
    
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('modal_trade_date').value = today;
    
    // Set default account if available
    const accountSelect = document.getElementById('modal_account_id');
    if (accountSelect.options.length > 1) {
        accountSelect.selectedIndex = 1; // Select first available account
    }
    
    // Reset summary
    document.getElementById('modal-summary-content').innerHTML = '<p class="text-muted">{{ _("Fill in the form to see transaction summary") }}</p>';
}

// Handle form submission with AJAX
document.getElementById('addTransactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonContent = submitButton.innerHTML;
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{{ _("Creating...") }}';
    
    // Get form data
    const formData = new FormData(this);
    
    // Send AJAX request
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        return response.json().then(data => ({ status: response.status, data: data }));
    })
    .then(({ status, data }) => {
        if (status === 200 && data.success) {
            // Success - show success popup and redirect
            alert(data.message || '{{ _("Transaction created successfully!") }}');
            const accountId = formData.get('account_id');
            window.location.href = '{{ url_for("main.transactions") }}' + (accountId ? '?account_id=' + accountId : '');
        } else {
            // Error - show error popup
            const errorMessage = data.error || '{{ _("An error occurred while creating the transaction") }}';
            alert(errorMessage);
            
            // Reset button state
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonContent;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ _("Network error occurred. Please try again.") }}');
        
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonContent;
    });
});
</script>

{% endblock %}
