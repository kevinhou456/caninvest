{% extends "base/investment_base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-bar me-2"></i>{{ _('Annual Analysis') }}
        </h2>
        <!-- <p class="text-muted">{{ _('Comprehensive annual investment performance analysis') }}</p> -->
    </div>
</div>

<!-- Annual Data Analysis Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-info">
        <h6 class="m-0 font-weight-bold text-white">{{ _('Annual Data Analysis') }}</h6>
        <div class="d-flex align-items-center">
            <button type="button" class="btn btn-light btn-sm me-3" id="fetchAnnualRatesBtn">
                <i class="fas fa-sync-alt me-1"></i>{{ _('Fetch Annual Average FX') }}
            </button>
            <div class="form-check form-switch text-white mb-0 me-3" id="accountBreakdownWrapper">
                <input class="form-check-input" type="checkbox" id="toggleAccountBreakdown">
                <label class="form-check-label" for="toggleAccountBreakdown">{{ _('Separate by Account') }}</label>
            </div>
            <div class="form-check form-switch text-white mb-0">
                <input class="form-check-input" type="checkbox" id="toggleCurrencyBreakdown">
                <label class="form-check-label" for="toggleCurrencyBreakdown">{{ _('Currency Details') }}</label>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="annualAnalysisTable" width="100%" cellspacing="0">
                <thead>
                    <tr class="bg-primary text-white">
                        <th>{{ _('Year') }}</th>
                        <th>{{ _('Total Assets') }}</th>
                        <th>{{ _('Realized Gain/Loss') }}</th>
                        <th>{{ _('Div+Int') }}</th>
                        <th>{{ _('Deposits') }}</th>
                        <th>{{ _('Withdrawals') }}</th>
                        <th>{{ _('Unrealized Gain/Loss') }}</th>
                        <th>{{ _('Return Rate') }}</th>
                        <th>{{ _('Annual Exchange Rates(*)') }}</th>
                    </tr>
                </thead>
                <tbody id="annual-data-tbody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
                <tfoot>
                    <tr class="bg-light font-weight-bold">
                        <td>{{ _('Total') }}</td>
                        <td id="total-assets-footer">
                            -
                            <br><small class="text-muted currency-breakdown">CAD: - | USD: -</small>
                        </td>
                        <td id="total-realized-footer">
                            -
                            <br><small class="text-muted currency-breakdown">CAD: - | USD: -</small>
                        </td>
                        <td id="total-income-footer">
                            -
                            <br><small class="text-muted currency-breakdown">CAD: - | USD: -</small>
                        </td>
                        <td id="total-deposits-footer">
                            -
                            <br><small class="text-muted currency-breakdown">CAD: - | USD: -</small>
                        </td>
                        <td id="total-withdrawals-footer">
                            -
                            <br><small class="text-muted currency-breakdown">CAD: - | USD: -</small>
                        </td>
                        <td id="total-unrealized-footer">
                            -
                            <br><small class="text-muted currency-breakdown">CAD: - | USD: -</small>
                        </td>
                        <td id="total-return-rate-footer">-</td>
                        <td id="total-usd-cad-rate-footer">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Year-end Holdings Breakdown -->
<div class="card shadow mb-4" id="yearlyHoldingsCard" style="display: none;">
    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-secondary text-white">
        <h6 class="m-0 font-weight-bold">{{ _('Year-end Holdings / Cleared Stocks') }}</h6>
        <div class="d-flex align-items-center">
            <label for="yearlyHoldingsSelect" class="me-2 mb-0">{{ _('Select Year') }}</label>
            <select class="form-select form-select-sm" id="yearlyHoldingsSelect" style="min-width: 120px;"></select>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0 holdings-table" id="yearlyHoldingsTable">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3 sortable" data-sort="symbol">
                            <div class="d-flex align-items-center">
                                {{ _('Stock') }}
                                <i class="fas fa-sort ms-1 sort-icon"></i>
                            </div>
                        </th>
                        <th class="text-end sortable" data-sort="shares">
                            {{ _('Shares') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="avg_cost">
                            {{ _('Avg Cost') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="price">
                            {{ _('Year-end Price') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="value">
                            {{ _('Year-end Value') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="unrealized">
                            {{ _('Unrealized P&L') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="realized">
                            {{ _('Realized P&L') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="divint">
                            {{ _('Div+Int') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                        <th class="text-end sortable" data-sort="return_percent">
                            {{ _('Period Return') }}
                            <i class="fas fa-sort ms-1 sort-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="yearlyHoldingsTbody">
                    <!-- populated via JS -->
                </tbody>
            </table>
        </div>
        <div id="yearlyHoldingsEmpty" class="text-center py-4 text-muted" style="display: none;">
            <i class="fas fa-info-circle me-2"></i>{{ _('No holdings data for the selected year.') }}
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Combined Assets Chart (Total + Members) -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary">
                <h6 class="m-0 font-weight-bold text-white">{{ _('Annual Total Assets & Members Breakdown') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="height: 400px;">
                    <canvas id="combinedAssetsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Returns Breakdown Chart (Total + Members) -->
    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success">
                <h6 class="m-0 font-weight-bold text-white">{{ _('Annual Returns Breakdown & Members') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="height: 400px;">
                    <canvas id="enhancedReturnsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loading-spinner" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">{{ _('Loading...') }}</span>
    </div>
    <p class="mt-2 text-muted">{{ _('Loading annual analysis data...') }}</p>
</div>

{% endblock %}

{% block extra_css %}
<style>
.detail-row {
    background-color: rgba(108, 117, 125, 0.1) !important;
}

.detail-row td {
    border-top: 1px dashed #dee2e6 !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

.detail-row:hover {
    background-color: rgba(108, 117, 125, 0.15) !important;
}

.account-type-indent {
    margin-left: 20px;
    color: #6c757d;
    font-size: 0.9em;
}

.account-type-indent::before {
    content: "‚îú‚îÄ ";
    color: #adb5bd;
}

.member-row {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

.member-row td {
    border-top: 1px dashed #0dcaf0 !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

.member-row:hover {
    background-color: rgba(13, 202, 240, 0.15) !important;
}

.member-name-indent {
    margin-left: 20px;
    color: #0dcaf0;
    font-size: 0.9em;
    font-weight: 600;
}

.member-name-indent::before {
    content: "üë§ ";
    color: #0dcaf0;
}

.member-account-type-row {
    background-color: rgba(108, 117, 125, 0.08) !important;
}

.member-account-type-row td {
    border-top: 1px dashed #adb5bd !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

.member-account-type-row:hover {
    background-color: rgba(108, 117, 125, 0.12) !important;
}

.member-account-type-indent {
    margin-left: 40px;
    color: #6c757d;
    font-size: 0.85em;
    font-weight: 500;
}

.member-account-type-indent::before {
    content: "‚îú‚îÄ üìä ";
    color: #6c757d;
}

.account-row {
    background-color: rgba(0, 123, 255, 0.05) !important;
}

.account-row td {
    border-top: 1px dashed #0d6efd !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

.account-indent {
    margin-left: 20px;
    color: #0d6efd;
    font-size: 0.9em;
    font-weight: 600;
}

.account-indent::before {
    content: "üè¶ ";
    color: #0d6efd;
}

.holdings-table {
    font-size: 0.9rem;
}

.stock-avatar {
    width: 32px;
    height: 32px;
    font-size: 11px;
    font-weight: 600;
}

.sort-icon {
    font-size: 0.7rem;
    color: #adb5bd;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let annualData = [];
let combinedAssetsChart = null;
let enhancedReturnsChart = null;
let showCurrencyBreakdown = false;
let yearlyHoldings = {};
let selectedYear = null;
let separateByAccount = false;
let filterInfo = {};

const familyId = {{ (current_family.id if current_family else 1) | tojson }};
const memberId = {{ (current_member_id if current_member_id else None) | tojson }};
const accountId = {{ (current_account_id if current_account_id else None) | tojson }};

function showLoadingOverlay(message) {
    const msg = message || 'Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...';
    if (window.GlobalLoading && typeof GlobalLoading.manualShow === 'function') {
        GlobalLoading.manualShow(msg);
    } else if (window.GlobalLoading && typeof GlobalLoading.show === 'function') {
        GlobalLoading.show(msg);
    }
}

function hideLoadingOverlay() {
    if (window.GlobalLoading && typeof GlobalLoading.manualHide === 'function') {
        GlobalLoading.manualHide(300);
    } else if (window.GlobalLoading && typeof GlobalLoading.hide === 'function') {
        GlobalLoading.hide(300);
    }
}

// Load annual analysis data
function loadAnnualAnalysis() {
    let apiUrl = `/api/v1/families/${familyId}/reports/annual-analysis`;
    const params = new URLSearchParams();

    if (memberId) {
        params.append('member_id', memberId);
    }
    if (accountId) {
        params.append('account_id', accountId);
    }
    if (separateByAccount) {
        params.append('separate_accounts', '1');
    }
    
    if (params.toString()) {
        apiUrl += '?' + params.toString();
    }
    
    console.log('Loading annual analysis from:', apiUrl);

    showLoadingOverlay('Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...');

    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Annual analysis data:', data);
            if (data.analysis) {
                annualData = data.analysis.annual_data || [];
                yearlyHoldings = data.analysis.yearly_holdings || {};
                filterInfo = data.filter_info || {};
                updateCombinedAssetsChart();
                updateEnhancedReturnsChart();
                updateAnnualTable();
                updateYearlyHoldingsUI();
                document.getElementById('loading-spinner').style.display = 'none';
                updateAccountToggleVisibility();
            } else {
                showError('No analysis data returned from API');
            }
        })
        .catch(error => {
            console.error('Error loading annual analysis:', error);
            showError('Failed to load annual analysis data: ' + error.message);
        })
        .finally(() => {
            hideLoadingOverlay();
        });
}

async function fetchAnnualExchangeRates() {
    if (!annualData || annualData.length === 0) {
        alert('{{ _('Load annual analysis data before fetching rates.') }}');
        return;
    }

    const years = [...new Set(
        annualData
            .filter(item => !item.is_detail_row && !item.is_member_row && !item.is_member_account_type_row)
            .map(item => item.year)
            .filter(year => typeof year === 'number')
    )].sort((a, b) => a - b);

    if (years.length === 0) {
        alert('{{ _('No valid years found for annual exchange rate refresh.') }}');
        return;
    }

    const button = document.getElementById('fetchAnnualRatesBtn');
    const originalContent = button ? button.innerHTML : '';

    showLoadingOverlay('{{ _('Fetching annual average exchange rates...') }}');

    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _('Fetching...') }}';
    }

    try {
        const response = await fetch(`/api/v1/families/${familyId}/reports/annual-analysis/exchange-rates`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                years: years,
                from_currency: 'USD',
                to_currency: 'CAD'
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || '{{ _('Failed to refresh exchange rates.') }}');
        }

        const rates = result.rates || {};
        let message = '{{ _('Annual average exchange rates refreshed:') }}\n';
        years.forEach(year => {
            if (rates.hasOwnProperty(year) && rates[year] !== null && rates[year] !== undefined) {
                message += `${year}: ${Number(rates[year]).toFixed(4)}\n`;
            } else {
                message += `${year}: N/A\n`;
            }
        });

        alert(message.trim());
        loadAnnualAnalysis();
    } catch (error) {
        console.error('Error refreshing annual exchange rates:', error);
        alert('{{ _('Failed to refresh exchange rates:') }} ' + error.message);
    } finally {
        hideLoadingOverlay();
        if (button) {
            button.disabled = false;
            button.innerHTML = originalContent;
        }
    }
}

// Update combined assets chart (Total + Members)
function updateCombinedAssetsChart() {
    const ctx = document.getElementById('combinedAssetsChart').getContext('2d');

    if (combinedAssetsChart) {
        combinedAssetsChart.destroy();
    }

    // Get main data (exclude detail rows and member rows)
    const mainData = [...annualData].filter(item => !item.is_detail_row && !item.is_member_row && !item.is_member_account_type_row).sort((a, b) => a.year - b.year);

    // Get member data
    const memberData = annualData.filter(item => item.is_member_row);

    // Get all years
    const allYears = [...new Set([...mainData, ...memberData].map(item => item.year))].sort((a, b) => a - b);

    // Prepare datasets
    const datasets = [];

    // Add total assets dataset
    const totalAssetsData = allYears.map(year => {
        const yearData = mainData.find(item => item.year === year);
        return yearData ? yearData.total_assets : 0;
    });

    datasets.push({
        label: '{{ _("Total Assets") }}',
        data: totalAssetsData,
        backgroundColor: 'rgba(78, 115, 223, 0.9)',
        borderColor: 'rgba(78, 115, 223, 1)',
        borderWidth: 2
    });

    // Add member datasets if available
    if (memberData.length > 0) {
        // Group member data by member
        const memberGroups = {};
        memberData.forEach(item => {
            if (!memberGroups[item.member_name]) {
                memberGroups[item.member_name] = [];
            }
            memberGroups[item.member_name].push(item);
        });

        const memberColors = ['#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'];
        let colorIndex = 0;

        Object.keys(memberGroups).forEach(memberName => {
            const memberYearData = memberGroups[memberName];
            const color = memberColors[colorIndex % memberColors.length];

            // Convert hex to rgba for transparency
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const rgb = hexToRgb(color);
            const bgColor = rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.7)` : color;

            const assetsData = allYears.map(year => {
                const yearData = memberYearData.find(item => item.year === year);
                return yearData ? yearData.total_assets : 0;
            });

            datasets.push({
                label: memberName,
                data: assetsData,
                backgroundColor: bgColor,
                borderColor: color,
                borderWidth: 1
            });

            colorIndex++;
        });
    }

    combinedAssetsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: allYears,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                bar: {
                    categoryPercentage: 0.8,
                    barPercentage: 0.9
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Year") }}'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Assets ($)") }}'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// Update enhanced returns breakdown chart (Total + Members breakdown)
function updateEnhancedReturnsChart() {
    const ctx = document.getElementById('enhancedReturnsChart').getContext('2d');

    if (enhancedReturnsChart) {
        enhancedReturnsChart.destroy();
    }

    // Get main data (exclude detail rows and member rows)
    const mainData = [...annualData].filter(item => !item.is_detail_row && !item.is_member_row && !item.is_member_account_type_row).sort((a, b) => a.year - b.year);

    // Get member data
    const memberData = annualData.filter(item => item.is_member_row);

    // Get all years
    const allYears = [...new Set([...mainData, ...memberData].map(item => item.year))].sort((a, b) => a - b);

    // Prepare datasets
    const datasets = [];

    // Add total breakdown datasets
    const totalRealizedGains = allYears.map(year => {
        const yearData = mainData.find(item => item.year === year);
        return yearData ? (yearData.annual_realized_gain || 0) : 0;
    });

    const totalUnrealizedGains = allYears.map(year => {
        const yearData = mainData.find(item => item.year === year);
        return yearData ? (yearData.annual_unrealized_gain || 0) : 0;
    });

    const totalDividendsAndInterest = allYears.map(year => {
        const yearData = mainData.find(item => item.year === year);
        return yearData ? ((yearData.annual_dividends || 0) + (yearData.annual_interest || 0)) : 0;
    });

    datasets.push(
        {
            label: '{{ _("Total Realized Gains") }}',
            data: totalRealizedGains,
            backgroundColor: 'rgba(28, 200, 138, 0.9)',
            borderColor: 'rgba(28, 200, 138, 1)',
            borderWidth: 2
        },
        {
            label: '{{ _("Total Unrealized Gains") }}',
            data: totalUnrealizedGains,
            backgroundColor: 'rgba(54, 162, 235, 0.9)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2
        },
        {
            label: '{{ _("Total Div+Int") }}',
            data: totalDividendsAndInterest,
            backgroundColor: 'rgba(255, 206, 86, 0.9)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 2
        }
    );

    // Add member total returns datasets if available
    if (memberData.length > 0) {
        // Group member data by member
        const memberGroups = {};
        memberData.forEach(item => {
            if (!memberGroups[item.member_name]) {
                memberGroups[item.member_name] = [];
            }
            memberGroups[item.member_name].push(item);
        });

        const memberColors = ['#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'];
        let colorIndex = 0;

        Object.keys(memberGroups).forEach(memberName => {
            const memberYearData = memberGroups[memberName];
            const color = memberColors[colorIndex % memberColors.length];

            // Convert hex to rgba for transparency
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const rgb = hexToRgb(color);
            const bgColor = rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.6)` : color;

            // Total returns = realized + unrealized + dividends + interest
            const memberTotalReturns = allYears.map(year => {
                const yearData = memberYearData.find(item => item.year === year);
                if (!yearData) return 0;
                return (yearData.annual_realized_gain || 0) +
                       (yearData.annual_unrealized_gain || 0) +
                       (yearData.annual_dividends || 0) +
                       (yearData.annual_interest || 0);
            });

            datasets.push({
                label: `${memberName} {{ _("Total Returns") }}`,
                data: memberTotalReturns,
                backgroundColor: bgColor,
                borderColor: color,
                borderWidth: 1
            });

            colorIndex++;
        });
    }

    enhancedReturnsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: allYears,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            elements: {
                bar: {
                    categoryPercentage: 0.8,
                    barPercentage: 0.9
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Year") }}'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Returns ($)") }}'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const label = context.dataset.label;

                            if (label === '{{ _("Total Div+Int") }}') {
                                const yearIndex = context.dataIndex;
                                const yearData = mainData.find(item => item.year === allYears[yearIndex]);
                                if (yearData) {
                                    const dividends = yearData.annual_dividends || 0;
                                    const interest = yearData.annual_interest || 0;
                                    return label + ': $' + value.toLocaleString() +
                                           ' ({{ _("Div") }}: $' + dividends.toLocaleString() +
                                           ', {{ _("Int") }}: $' + interest.toLocaleString() + ')';
                                }
                            }
                            return label + ': $' + value.toLocaleString();
                        },
                        footer: function(tooltipItems) {
                            let total = 0;
                            tooltipItems.forEach(function(tooltipItem) {
                                total += tooltipItem.parsed.y;
                            });
                            return '{{ _("Combined Total") }}: $' + total.toLocaleString();
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}


// Update annual table
function updateAnnualTable() {
    const tbody = document.getElementById('annual-data-tbody');
    tbody.innerHTML = '';

    let totalAssets = 0, totalRealized = 0, totalUnrealized = 0;
    let totalIncome = 0, totalDeposits = 0, totalWithdrawals = 0;
    let totalReturnsSum = 0, totalInvestmentSum = 0;
    let latestUsdCadRate = null;

    // Currency breakdown totals
    let totalAssetsCad = 0, totalAssetsUsd = 0;
    let totalRealizedCad = 0, totalRealizedUsd = 0;
    let totalIncomeCad = 0, totalIncomeUsd = 0;
    let totalDepositsCad = 0, totalDepositsUsd = 0;
    let totalWithdrawalsCad = 0, totalWithdrawalsUsd = 0;
    let totalUnrealizedCad = 0, totalUnrealizedUsd = 0;


    // Sort data by year descending for table (newest first), with detail/member rows following main rows
    const tableData = [...annualData].sort((a, b) => {
        // First sort by year (descending)
        if (a.year !== b.year) {
            return b.year - a.year;
        }
        // Within the same year, main row first, then detail/member rows
        const aIsSubRow = a.is_detail_row || a.is_member_row || a.is_member_account_type_row || a.is_account_row;
        const bIsSubRow = b.is_detail_row || b.is_member_row || b.is_member_account_type_row || b.is_account_row;

        if (aIsSubRow && !bIsSubRow) {
            return 1; // a comes after b
        }
        if (!aIsSubRow && bIsSubRow) {
            return -1; // a comes before b
        }
        // Both are sub rows or both are main rows, maintain order
        return 0;
    });

    tableData.forEach(item => {
        const row = document.createElement('tr');

        // Â¶ÇÊûúÊòØËØ¶ÁªÜË°åÊàñÊàêÂëòË°åÊàñË¥¶Êà∑Ë°åÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
        if (item.is_detail_row) {
            row.classList.add('table-secondary', 'detail-row');
            row.style.fontSize = '0.9em';
        } else if (item.is_member_row) {
            row.classList.add('table-info', 'member-row');
            row.style.fontSize = '0.9em';
        } else if (item.is_member_account_type_row) {
            row.classList.add('table-secondary', 'member-account-type-row');
            row.style.fontSize = '0.85em';
        } else if (item.is_account_row) {
            row.classList.add('account-row');
            row.style.fontSize = '0.9em';
        }

        const realizedClass = item.annual_realized_gain >= 0 ? 'text-success' : 'text-danger';
        const unrealizedClass = item.annual_unrealized_gain >= 0 ? 'text-success' : 'text-danger';

        const currencyBreakdown = item.currency_breakdown || {};
        
        // Calculate return rate: annual returns / total assets
        // Note: annual_unrealized_gain is now incremental (yearly change), not cumulative
        const totalReturns = item.annual_realized_gain + item.annual_unrealized_gain + item.annual_dividends + item.annual_interest;
        // Use total_assets as the base since it represents the investment size for the year
        const returnRate = item.total_assets > 0 ? (totalReturns / item.total_assets) * 100 : 0;
        const returnRateClass = returnRate >= 0 ? 'text-success' : 'text-danger';

        // Calculate combined income
        const combinedIncome = item.annual_dividends + item.annual_interest;
        const combinedIncomeCad = (currencyBreakdown.dividends_cad || 0) + (currencyBreakdown.interest_cad || 0);
        const combinedIncomeUsd = (currencyBreakdown.dividends_usd || 0) + (currencyBreakdown.interest_usd || 0);

        // Calculate totals using annual exchange rate for display (*marked fields)
        const annualRate = item.annual_usd_cad_rate || 1.0;
        const realizedGainTotal = (currencyBreakdown.realized_gain_cad || 0) + (currencyBreakdown.realized_gain_usd || 0) * annualRate;
        const combinedIncomeTotal = combinedIncomeCad + combinedIncomeUsd * annualRate;
        const depositsTotal = (currencyBreakdown.deposit_cad || 0) + (currencyBreakdown.deposit_usd || 0) * annualRate;
        const withdrawalsTotal = (currencyBreakdown.withdrawal_cad || 0) + (currencyBreakdown.withdrawal_usd || 0) * annualRate;

        // ÊòæÁ§∫Âπ¥‰ªΩ„ÄÅË¥¶Êà∑Á±ªÂûãÊàñÊàêÂëòÂêçÁß∞
        let displayYear;
        if (item.is_detail_row) {
            displayYear = `<span class="account-type-indent">${item.account_type}</span>`;
        } else if (item.is_member_row) {
            displayYear = `<span class="member-name-indent">${item.member_name}</span>`;
        } else if (item.is_member_account_type_row) {
            displayYear = `<span class="member-account-type-indent">${item.account_type}</span>`;
        } else if (item.is_account_row) {
            displayYear = `<span class="account-indent">${item.account_name}</span>`;
        } else {
            displayYear = item.year;
        }

        row.innerHTML = `
            <td class="font-weight-bold">${displayYear}</td>
            <td>
                $${formatNumber(item.total_assets, 2)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.total_assets_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.total_assets_usd || 0, 2)}</small>
            </td>
            <td class="${realizedClass}">
                $${formatNumber(realizedGainTotal, 2, true)}*
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.realized_gain_cad || 0, 2, true)} | USD: $${formatNumber(currencyBreakdown.realized_gain_usd || 0, 2, true)}</small>
            </td>
            <td class="text-info">
                $${formatNumber(combinedIncomeTotal, 2)}*
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(combinedIncomeCad, 2)} | USD: $${formatNumber(combinedIncomeUsd, 2)}</small>
            </td>
            <td class="text-primary">
                $${formatNumber(depositsTotal, 2)}*
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.deposit_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.deposit_usd || 0, 2)}</small>
            </td>
            <td class="text-warning">
                $${formatNumber(withdrawalsTotal, 2)}*
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.withdrawal_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.withdrawal_usd || 0, 2)}</small>
            </td>
            <td class="${unrealizedClass}">
                $${formatNumber(item.annual_unrealized_gain, 2, true)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.unrealized_gain_cad || 0, 2, true)} | USD: $${formatNumber(currencyBreakdown.unrealized_gain_usd || 0, 2, true)}</small>
            </td>
            <td class="${returnRateClass}">
                ${formatNumber(returnRate, 2, true)}%
            </td>
            <td class="text-muted">
                ${item.is_detail_row || item.is_member_row || item.is_member_account_type_row ? '' : (item.annual_usd_cad_rate ? formatNumber(item.annual_usd_cad_rate, 4) : 'N/A')}
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Update totals (only for main rows, not detail rows or member rows)
        if (!item.is_detail_row && !item.is_member_row && !item.is_member_account_type_row && !item.is_account_row) {
            // Use the first main row for latest assets and set current exchange rate
            if (totalAssets === 0) {
                totalAssets = item.total_assets;
                latestUsdCadRate = {{ exchange_rates['usd_to_cad'] if exchange_rates else 1.3782 }};
            }
            // Accumulate original values for current rate calculation in totals
            totalRealized += item.annual_realized_gain;
            totalUnrealized += item.annual_unrealized_gain;
            totalIncome += item.annual_dividends + item.annual_interest;
            totalDeposits += (item.deposit_amount || 0);
            totalWithdrawals += (item.withdrawal_amount || 0);

            // Currency breakdown totals
            totalAssetsCad += (currencyBreakdown.total_assets_cad || 0);
            totalAssetsUsd += (currencyBreakdown.total_assets_usd || 0);
            totalRealizedCad += (currencyBreakdown.realized_gain_cad || 0);
            totalRealizedUsd += (currencyBreakdown.realized_gain_usd || 0);
            totalIncomeCad += (currencyBreakdown.dividends_cad || 0) + (currencyBreakdown.interest_cad || 0);
            totalIncomeUsd += (currencyBreakdown.dividends_usd || 0) + (currencyBreakdown.interest_usd || 0);
            totalDepositsCad += (currencyBreakdown.deposit_cad || 0);
            totalDepositsUsd += (currencyBreakdown.deposit_usd || 0);
            totalWithdrawalsCad += (currencyBreakdown.withdrawal_cad || 0);
            totalWithdrawalsUsd += (currencyBreakdown.withdrawal_usd || 0);
            totalUnrealizedCad += (currencyBreakdown.unrealized_gain_cad || 0);
            totalUnrealizedUsd += (currencyBreakdown.unrealized_gain_usd || 0);
        }

        // Calculate totals for overall return rate (only for main rows, not detail rows or member rows)
        if (!item.is_detail_row && !item.is_member_row && !item.is_member_account_type_row && !item.is_account_row) {
            const itemReturns = item.annual_realized_gain + item.annual_unrealized_gain + item.annual_dividends + item.annual_interest;
            // Use total_assets as the investment base since annual_unrealized_gain is now incremental
            totalReturnsSum += itemReturns;
            totalInvestmentSum += Math.max(item.total_assets, 0);
        }
    });
    
    // Calculate overall return rate
    const overallReturnRate = totalInvestmentSum > 0 ? (totalReturnsSum / totalInvestmentSum) * 100 : 0;

    // Recalculate totals using current exchange rate (for footer without *)
    const currentRate = latestUsdCadRate;
    const totalRealizedCurrent = totalRealizedCad + totalRealizedUsd * currentRate;
    const totalIncomeCurrent = totalIncomeCad + totalIncomeUsd * currentRate;
    const totalDepositsCurrent = totalDepositsCad + totalDepositsUsd * currentRate;
    const totalWithdrawalsCurrent = totalWithdrawalsCad + totalWithdrawalsUsd * currentRate;

    // Update footer totals
    document.getElementById('total-assets-footer').innerHTML = `
        $${formatNumber(totalAssets, 2)}
        <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalAssetsCad, 2)} | USD: $${formatNumber(totalAssetsUsd, 2)}</small>
    `;
    document.getElementById('total-realized-footer').innerHTML = `
        $${formatNumber(totalRealizedCurrent, 2, true)}
        <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalRealizedCad, 2, true)} | USD: $${formatNumber(totalRealizedUsd, 2, true)}</small>
    `;
    document.getElementById('total-income-footer').innerHTML = `
        $${formatNumber(totalIncomeCurrent, 2)}
        <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalIncomeCad, 2)} | USD: $${formatNumber(totalIncomeUsd, 2)}</small>
    `;
    document.getElementById('total-deposits-footer').innerHTML = `
        $${formatNumber(totalDepositsCurrent, 2)}
        <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalDepositsCad, 2)} | USD: $${formatNumber(totalDepositsUsd, 2)}</small>
    `;
    document.getElementById('total-withdrawals-footer').innerHTML = `
        $${formatNumber(totalWithdrawalsCurrent, 2)}
        <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalWithdrawalsCad, 2)} | USD: $${formatNumber(totalWithdrawalsUsd, 2)}</small>
    `;
    document.getElementById('total-unrealized-footer').innerHTML = `
        $${formatNumber(totalUnrealized, 2, true)}
        <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalUnrealizedCad, 2, true)} | USD: $${formatNumber(totalUnrealizedUsd, 2, true)}</small>
    `;
    document.getElementById('total-return-rate-footer').textContent = formatNumber(overallReturnRate, 2, true) + '%';
    document.getElementById('total-usd-cad-rate-footer').textContent = latestUsdCadRate ? 'Current Rates: ' + formatNumber(latestUsdCadRate, 4) : 'N/A';

    updateCurrencyBreakdownVisibility();
}

// Year-end holdings rendering
function getAvailableYearsForHoldings() {
    return Object.keys(yearlyHoldings || {})
        .map(y => parseInt(y, 10))
        .filter(y => !isNaN(y))
        .sort((a, b) => b - a);
}

function updateYearlyHoldingsUI() {
    const card = document.getElementById('yearlyHoldingsCard');
    const select = document.getElementById('yearlyHoldingsSelect');
    if (!card || !select) return;

    const years = getAvailableYearsForHoldings();
    if (!years.length) {
        card.style.display = 'none';
        return;
    }

    card.style.display = 'block';
    select.innerHTML = '';
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
    });

    if (!selectedYear || !years.includes(selectedYear)) {
        selectedYear = years[0];
    }
    select.value = selectedYear;
    select.onchange = (e) => {
        selectedYear = parseInt(e.target.value, 10);
        renderYearlyHoldingsTable(selectedYear);
    };

    renderYearlyHoldingsTable(selectedYear);
}

function renderYearlyHoldingsTable(year) {
    const tbody = document.getElementById('yearlyHoldingsTbody');
    const emptyHint = document.getElementById('yearlyHoldingsEmpty');
    if (!tbody) return;
    tbody.innerHTML = '';

    const rows = (yearlyHoldings && yearlyHoldings[year]) ? yearlyHoldings[year] : [];
    if (!rows.length) {
        if (emptyHint) emptyHint.style.display = 'block';
        return;
    }
    if (emptyHint) emptyHint.style.display = 'none';

    rows.forEach(item => {
        const unrealizedClass = (item.unrealized_gain || 0) >= 0 ? 'text-success' : 'text-danger';
        const realizedClass = (item.realized_gain || 0) >= 0 ? 'text-success' : 'text-danger';
        const returnClass = (item.return_rate || 0) >= 0 ? 'bg-success' : 'bg-danger';
        const divInt = (item.dividends || 0) + (item.interest || 0);
        const shares = parseFloat(item.shares || 0);
        const totalCost = parseFloat(item.total_cost || 0);
        const avgCost = item.average_cost != null ? parseFloat(item.average_cost) : (shares > 0 ? totalCost / shares : 0);

        const tr = document.createElement('tr');
        tr.dataset.symbol = item.symbol || '';
        tr.dataset.shares = item.shares || 0;
        tr.dataset.avgCost = avgCost || 0;
        tr.dataset.price = item.current_price || 0;
        tr.dataset.value = item.current_value || 0;
        tr.dataset.unrealized = item.unrealized_gain || 0;
        tr.dataset.realized = item.realized_gain || 0;
        tr.dataset.divint = divInt;
        tr.dataset.returnPercent = item.return_rate || 0;
        tr.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="bg-${(item.currency || 'USD') === 'CAD' ? 'warning' : 'success'} rounded-circle d-flex align-items-center justify-content-center me-2 stock-avatar" 
                         style="color: ${(item.currency || 'USD') === 'CAD' ? 'black' : 'white'};">
                        ${(item.currency || 'USD') === 'CAD' ? 'C$' : '$'}
                    </div>
                    <div>
                        <div class="fw-bold">${item.symbol || '-'}</div>
                        <small class="text-muted">${item.company_name || ''}</small>
                    </div>
                </div>
            </td>
            <td class="text-end">${formatShares(item.shares || 0)}</td>
            <td class="text-end">
                $${formatNumber(avgCost || 0, 4)}
                <br><small class="text-muted">${item.currency || ''}</small>
            </td>
            <td class="text-end">$${formatNumber(item.current_price || 0, 2)}</td>
            <td class="text-end">$${formatNumber(item.current_value || 0, 2)}</td>
            <td class="text-end ${unrealizedClass}">$${formatNumber(item.unrealized_gain || 0, 2, true)}</td>
            <td class="text-end ${realizedClass}">$${formatNumber(item.realized_gain || 0, 2, true)}</td>
            <td class="text-end text-success">$${formatNumber(divInt, 2)}</td>
            <td class="text-end"><span class="badge ${returnClass}">${formatNumber(item.return_rate || 0, 1, true)}%</span></td>
        `;
        tbody.appendChild(tr);
    });

    initYearlyHoldingsSorting();
}

function initYearlyHoldingsSorting() {
    const table = document.getElementById('yearlyHoldingsTable');
    if (!table || table.dataset.sortInit) return;

    const headers = table.querySelectorAll('th.sortable');
    let currentSort = {column: null, direction: 'asc'};

    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const sortType = header.dataset.sort;
            const nextDirection = (currentSort.column === sortType && currentSort.direction === 'asc') ? 'desc' : 'asc';
            sortYearlyHoldingsTable(table, sortType, nextDirection);
            updateYearlySortIcons(headers, header, nextDirection);
            currentSort = {column: sortType, direction: nextDirection};
        });
    });

    table.dataset.sortInit = '1';
}

function sortYearlyHoldingsTable(table, sortType, direction) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        if (['symbol'].includes(sortType)) {
            const aVal = (a.dataset[sortType] || '').toLowerCase();
            const bVal = (b.dataset[sortType] || '').toLowerCase();
            return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }

        const dataAttrMap = {
            'avg_cost': 'avgCost',
            'price': 'price',
            'value': 'value',
            'unrealized': 'unrealized',
            'realized': 'realized',
            'divint': 'divint',
            'return_percent': 'returnPercent'
        };
        const attr = dataAttrMap[sortType] || sortType;
        const aNum = parseFloat(a.dataset[attr]) || 0;
        const bNum = parseFloat(b.dataset[attr]) || 0;
        return direction === 'asc' ? aNum - bNum : bNum - aNum;
    });

    rows.forEach(row => tbody.appendChild(row));
}

function updateYearlySortIcons(headers, activeHeader, direction) {
    headers.forEach(header => {
        const icon = header.querySelector('.sort-icon');
        if (icon) {
            icon.className = 'fas fa-sort ms-1 sort-icon';
        }
    });
    const icon = activeHeader.querySelector('.sort-icon');
    if (icon) {
        icon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} ms-1 sort-icon`;
    }
}

function updateCurrencyBreakdownVisibility() {
    const breakdownElements = document.querySelectorAll('.currency-breakdown');
    breakdownElements.forEach(el => {
        if (showCurrencyBreakdown) {
            el.classList.remove('d-none');
        } else {
            el.classList.add('d-none');
        }
    });
}

// Utility functions
function formatNumber(num, decimals = 0, showSign = false) {
    // Convert to number and fix precision to avoid floating point issues
    const number = parseFloat(num) || 0;
    const formatted = number.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
    
    if (showSign && number > 0) {
        return '+' + formatted;
    }
    
    return formatted;
}

function formatShares(value) {
    const num = parseFloat(value) || 0;
    const isInt = Number.isInteger(num);
    return formatNumber(num, isInt ? 0 : 4);
}

function showError(message) {
    document.getElementById('loading-spinner').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `;
}

// Export functions
function exportTableToCSV() {
    const table = document.getElementById('annualAnalysisTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
            row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
        }
        
        csv.push(row.join(','));
    }
    
    const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = 'annual_analysis.csv';
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

function exportTableToPDF() {
    window.print();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAnnualAnalysis();

    const fetchBtn = document.getElementById('fetchAnnualRatesBtn');
    if (fetchBtn) {
        fetchBtn.addEventListener('click', fetchAnnualExchangeRates);
    }

    const toggle = document.getElementById('toggleCurrencyBreakdown');
    if (toggle) {
        showCurrencyBreakdown = toggle.checked;
        toggle.addEventListener('change', function(event) {
            showCurrencyBreakdown = event.target.checked;
            updateCurrencyBreakdownVisibility();
        });
        updateCurrencyBreakdownVisibility();
    }

    setupAccountToggle();
});

function setupAccountToggle() {
    const accountToggle = document.getElementById('toggleAccountBreakdown');
    if (!accountToggle) return;

    accountToggle.checked = separateByAccount;
    accountToggle.addEventListener('change', function(event) {
        separateByAccount = event.target.checked;
        loadAnnualAnalysis();
    });
}

function updateAccountToggleVisibility() {
    const wrapper = document.getElementById('accountBreakdownWrapper');
    if (!wrapper) return;
    const singleAccount = !!accountId || (filterInfo && filterInfo.account_id);
    if (singleAccount) {
        wrapper.style.display = 'none';
        separateByAccount = false;
    } else {
        wrapper.style.display = '';
    }
}
</script>
{% endblock %}
