{% extends "base/investment_base.html" %}

{% block styles %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">

<style>
/* Custom FullCalendar styling for P&L display */
.fc-daygrid-day-frame {
    min-height: 80px;
}

.fc-daygrid-day-events {
    margin-top: 0 !important;
}

.fc-daygrid-day-top {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
}

.fc-daygrid-day-number {
    padding: 2px 4px;
    font-size: 0.875rem;
    font-weight: 600;
}

.pnl-data {
    padding: 2px 4px;
    font-size: 0.75rem;
    line-height: 1.2;
    text-align: center;
    margin-top: 4px;
    position: relative;
    z-index: 10;
}

.pnl-amount {
    font-weight: 500;
    margin-bottom: 1px;
}

.pnl-amount.positive {
    color: #1cc88a !important;
    font-weight: bold;
}

.pnl-amount.negative {
    color: #e74a3b !important;
    font-weight: bold;
}

.pnl-percent {
    font-size: 0.7rem;
    font-weight: 500;
}

.pnl-percent.positive {
    color: #1cc88a !important;
}

.pnl-percent.negative {
    color: #e74a3b !important;
}

/* Trading day and transaction indicators */
.fc-daygrid-day.trading-day {
    border-left: 3px solid #1cc88a !important;
}

.fc-daygrid-day.has-transactions {
    border-top: 3px solid #f6c23e !important;
}

.fc-daygrid-day.positive-change {
    background-color: #d4edda !important;
}

.fc-daygrid-day.negative-change {
    background-color: #f8d7da !important;
}

.fc-daygrid-day.significant-change {
    border: 2px solid #dc3545 !important;
}

/* Today styling */
.fc-day-today {
    background-color: #e7f3ff !important;
}

/* Weekend styling */
.fc-day-sat, .fc-day-sun {
    background-color: #f8f9fc !important;
}

/* Other month days */
.fc-day-other {
    background-color: #fafbfc !important;
    color: #858796 !important;
}

/* Calendar header customization */
.fc-toolbar {
    margin-bottom: 1rem;
}

.fc-toolbar-title {
    color: #5a5c69;
    font-size: 1.25rem;
    font-weight: 600;
}

.fc-button-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.fc-button-primary:hover {
    background-color: #2e59d9;
    border-color: #2e59d9;
}

.fc-button-primary:disabled {
    background-color: #858796;
    border-color: #858796;
}

/* Legend styles - Ultra-forceful approach to ensure visibility */
.calendar-legend {
    display: flex !important;
    flex-direction: row !important;
    justify-content: center !important;
    align-items: center !important;
    flex-wrap: nowrap !important;
    gap: 30px !important;
    padding: 20px !important;
    background-color: #f8f9fc !important;
    border-top: 2px solid #e3e6f0 !important;
    font-size: 14px !important;
    margin-top: 15px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    min-height: 60px !important;
}

.legend-item {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: flex-start !important;
    gap: 10px !important;
    white-space: nowrap !important;
    flex-shrink: 0 !important;
    flex-grow: 0 !important;
    min-width: auto !important;
}

.legend-color {
    width: 20px !important;
    height: 20px !important;
    min-width: 20px !important;
    min-height: 20px !important;
    border-radius: 3px !important;
    border: 1px solid #333 !important;
    flex-shrink: 0 !important;
    display: block !important;
}

.legend-color.trading {
    background-color: #1cc88a !important;
    border-color: #0d6334 !important;
}

.legend-color.transaction {
    background-color: #f6c23e !important;
    border-color: #c49619 !important;
}

.legend-color.positive {
    background-color: #d4edda !important;
    border-color: #1cc88a !important;
}

.legend-color.negative {
    background-color: #f8d7da !important;
    border-color: #e74a3b !important;
}

/* Text styling with explicit control */
.legend-item span {
    font-weight: 600 !important;
    color: #333 !important;
    white-space: nowrap !important;
    display: inline-block !important;
    line-height: 20px !important;
}

@media (max-width: 768px) {
    .calendar-legend {
        flex-wrap: wrap !important;
        gap: 15px !important;
        justify-content: flex-start !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-day me-2"></i>{{ _('Daily Statistics') }}
        </h2>
        <p class="text-muted">{{ _('Monthly calendar view with daily floating P&L indicators') }}</p>
    </div>
</div>

<!-- Month Summary Cards -->
<div class="row mb-4" id="month-summary-cards">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            {{ _('Month Start') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-start-assets">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            {{ _('Month End') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-end-assets">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            {{ _('Total Change') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-total-change">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            {{ _('Return %%') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-return-pct">
                            0.00%
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-percentage fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar View -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div id="calendar"></div>
                
                <!-- Legend -->
                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color trading"></div>
                        <span>{{ _('Trading Day') }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color transaction"></div>
                        <span>{{ _('Has Transactions') }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color positive"></div>
                        <span>{{ _('Positive P&L') }}</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color negative"></div>
                        <span>{{ _('Negative P&L') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Daily P&L Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">每日盈亏数据表格 (调试用)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="daily-pnl-table">
                        <thead class="thead-light">
                            <tr>
                                <th>日期</th>
                                <th>总资产</th>
                                <th>当日变化</th>
                                <th>回报率(%)</th>
                                <th>是否交易日</th>
                                <th>有交易</th>
                            </tr>
                        </thead>
                        <tbody id="daily-pnl-tbody">
                            <tr>
                                <td colspan="6" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- FullCalendar JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script>
let calendarData = null;
let calendar = null;

// Get current family ID and other parameters
const familyId = {{ family.id if family else 'null' }};
{% raw %}
const memberId = new URLSearchParams(window.location.search).get('member_id');
const accountId = new URLSearchParams(window.location.search).get('account_id');
{% endraw %}

// Initialize FullCalendar
function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
        },
        height: 'auto',
        aspectRatio: 1.35,
        firstDay: 0, // Sunday
        showNonCurrentDates: true,
        fixedWeekCount: false,
        
        // Custom day cell content
        dayCellDidMount: function(info) {
            const dateStr = info.date.toISOString().split('T')[0];
            const dayData = calendarData && calendarData.daily_stats ? calendarData.daily_stats[dateStr] : null;
            
            // Display all days with data, including zero changes
            if (!dayData) {
                return; // Skip days without any data
            }
            
            const dailyChange = dayData.daily_change || 0;
            const dailyReturnPct = dayData.daily_return_pct || 0;
            
            console.log(`${dateStr}: change=${dailyChange.toFixed(2)}, return=${dailyReturnPct.toFixed(2)}%`);
            
            // Add CSS classes for styling
            if (Math.abs(dailyChange) > 0) {
                if (dailyChange > 0) {
                    info.el.classList.add('positive-change');
                } else {
                    info.el.classList.add('negative-change');
                }
            }
            
            if (Math.abs(dailyReturnPct) > 5) {
                info.el.classList.add('significant-change');
            }
            
            // Add trading day and transaction indicators from real data if available
            if (dayData && dayData.is_trading_day) {
                info.el.classList.add('trading-day');
            }
            
            if (dayData && dayData.has_transactions) {
                info.el.classList.add('has-transactions');
            }
            
            // Always show P&L data for testing
            const pnlContainer = document.createElement('div');
            pnlContainer.className = 'pnl-data';
            
            // Format as "value(percentage)"
            const formattedAmount = `${dailyChange >= 0 ? '+' : ''}$${Math.abs(dailyChange).toLocaleString('en-US', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            })}`;
            const formattedPercent = `${dailyReturnPct >= 0 ? '+' : ''}${dailyReturnPct.toFixed(2)}%`;
            
            // Combined display: value(percentage)
            const pnlDiv = document.createElement('div');
            pnlDiv.className = `pnl-amount ${dailyChange >= 0 ? 'positive' : 'negative'}`;
            pnlDiv.textContent = `${formattedAmount}(${formattedPercent})`;
            
            // Force color style directly
            if (dailyChange >= 0) {
                pnlDiv.style.color = '#1cc88a';
                pnlDiv.style.fontWeight = 'bold';
            } else {
                pnlDiv.style.color = '#e74a3b';
                pnlDiv.style.fontWeight = 'bold';
            }
            
            pnlContainer.appendChild(pnlDiv);
            
            info.el.querySelector('.fc-daygrid-day-frame').appendChild(pnlContainer);
        },
        
        // Handle date clicks
        dateClick: function(info) {
            onDayClick(info.dateStr);
        },
        
        // Handle month changes
        datesSet: function(info) {
            const startDate = info.view.currentStart;
            const year = startDate.getFullYear();
            const month = startDate.getMonth() + 1;
            loadCalendarData(year, month);
        }
    });
    
    calendar.render();
}

// Load calendar data from API
function loadCalendarData(year, month) {
    let apiUrl = `/api/v1/daily-stats/calendar?year=${year}&month=${month}`;
    
    // Add account_ids parameter if specified in URL
    const urlParams = new URLSearchParams(window.location.search);
    const accountId = urlParams.get('account_id');
    const memberId = urlParams.get('member_id');
    
    if (accountId) {
        apiUrl += `&account_ids=${accountId}`;
    } else if (memberId) {
        // When member_id is specified, we need to get member's accounts
        // For now, just pass member_id and let backend handle it
        apiUrl += `&member_id=${memberId}`;
    }
    
    console.log('Loading calendar data from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendarData = data.data;
                updateMonthSummaryCards(calendarData.month_summary);
                updateDailyPnlTable(calendarData.daily_stats);
                // Re-render calendar to show new data
                if (calendar) {
                    calendar.refetchEvents();
                    calendar.render();
                }
            } else {
                console.error('Failed to load calendar data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
        });
}

// Update month summary cards
function updateMonthSummaryCards(summary) {
    document.getElementById('month-start-assets').textContent = 
        '$' + (summary.start_assets || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    document.getElementById('month-end-assets').textContent = 
        '$' + (summary.end_assets || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    const totalChange = summary.total_change || 0;
    const changeElement = document.getElementById('month-total-change');
    changeElement.textContent = '$' + totalChange.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    changeElement.className = 'h5 mb-0 font-weight-bold ' + (totalChange >= 0 ? 'text-success' : 'text-danger');
    
    const returnPct = summary.return_pct || 0;
    const returnElement = document.getElementById('month-return-pct');
    returnElement.textContent = returnPct.toFixed(2) + '%';
    returnElement.className = 'h5 mb-0 font-weight-bold ' + (returnPct >= 0 ? 'text-success' : 'text-danger');
    
    // Summary cards are always visible now
}

// Update daily P&L table with data
function updateDailyPnlTable(dailyStats) {
    const tbody = document.getElementById('daily-pnl-tbody');
    if (!tbody || !dailyStats) {
        console.log('Table body or daily stats not found');
        return;
    }
    
    // Convert daily_stats object to array if it's an object
    let statsArray = [];
    if (Array.isArray(dailyStats)) {
        statsArray = dailyStats;
    } else if (typeof dailyStats === 'object') {
        // Convert object to array
        statsArray = Object.values(dailyStats);
    }
    
    console.log('Updating daily P&L table with', statsArray.length, 'days of data');
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    if (statsArray.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无数据</td></tr>';
        return;
    }
    
    // Sort by date (most recent first)
    const sortedStats = [...statsArray].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedStats.forEach(day => {
        const row = document.createElement('tr');
        
        // Format date
        const date = new Date(day.date);
        const formattedDate = date.toLocaleDateString('zh-CN', {
            month: '2-digit',
            day: '2-digit'
        });
        
        // Get P&L data - the data structure is directly in the day object
        const totalAssets = day.total_assets || 0;
        const dailyChange = day.daily_change || 0;
        const returnPct = day.daily_return_pct || 0;
        const isTradingDay = day.is_trading_day || false;
        const hasTransactions = day.has_transactions || false;
        
        // Create row HTML
        const changeClass = dailyChange >= 0 ? 'text-success' : 'text-danger';
        const changeSign = dailyChange >= 0 ? '+' : '';
        const returnClass = returnPct >= 0 ? 'text-success' : 'text-danger';
        const returnSign = returnPct >= 0 ? '+' : '';
        
        row.innerHTML = `
            <td><strong>${formattedDate}</strong></td>
            <td>$${totalAssets.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="${changeClass}">${changeSign}$${dailyChange.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="${returnClass}">${returnSign}${returnPct.toFixed(2)}%</td>
            <td><span class="badge ${isTradingDay ? 'badge-success' : 'badge-secondary'}">${isTradingDay ? '是' : '否'}</span></td>
            <td><span class="badge ${hasTransactions ? 'badge-primary' : 'badge-light'}">${hasTransactions ? '有' : '无'}</span></td>
        `;
        
        tbody.appendChild(row);
    });
    
    console.log('Daily P&L table updated successfully');
}

// Handle day click to show details
function onDayClick(dateStr) {
    const apiUrl = `/api/v1/daily-stats/day/${dateStr}`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDayDetails(data.data);
            } else {
                console.error('Failed to load day details:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading day details:', error);
        });
}

// Show day details in modal or alert
function showDayDetails(dayData) {
    const assets = dayData.floating_pnl.total_assets || 0;
    const change = dayData.floating_pnl.daily_change || 0;
    const returnPct = dayData.floating_pnl.daily_return_pct || 0;
    
    alert(`Date: ${dayData.date}\nTotal Assets: $${assets.toLocaleString()}\nDaily Change: ${change >= 0 ? '+' : ''}$${change.toLocaleString()}\nReturn: ${returnPct.toFixed(2)}%`);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    
    // Load initial data for current month
    const today = new Date();
    loadCalendarData(today.getFullYear(), today.getMonth() + 1);
});
</script>
{% endblock %}