{% extends "base/investment_base.html" %}

{% block styles %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">

<style>
/* Custom FullCalendar styling for P&L display */
.fc-daygrid-day-frame {
    min-height: 80px;
}

.fc-daygrid-day-events {
    margin-top: 0 !important;
}

.fc-daygrid-day-top {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
}

.fc-daygrid-day-number {
    padding: 2px 4px;
    font-size: 0.875rem;
    font-weight: 600;
}

.pnl-data {
    padding: 2px 4px;
    font-size: 0.75rem;
    line-height: 1.2;
    text-align: center;
    margin-top: 4px;
    position: relative;
    z-index: 10;
}

.pnl-amount {
    font-weight: 500;
    margin-bottom: 1px;
}

.pnl-amount.positive {
    color: #1cc88a !important;
    font-weight: bold;
}

.pnl-amount.negative {
    color: #e74a3b !important;
    font-weight: bold;
}

.pnl-percent {
    font-size: 0.7rem;
    font-weight: 500;
}

.pnl-percent.positive {
    color: #1cc88a !important;
}

.pnl-percent.negative {
    color: #e74a3b !important;
}

/* Trading day and transaction indicators */
.fc-daygrid-day.trading-day {
    border-left: 3px solid #1cc88a !important;
}

.fc-daygrid-day.has-transactions {
    border-top: 3px solid #f6c23e !important;
}

.fc-daygrid-day.positive-change {
    background-color: #d4edda !important;
}

.fc-daygrid-day.negative-change {
    background-color: #f8d7da !important;
}

.fc-daygrid-day.significant-change {
    border: 2px solid #dc3545 !important;
}

/* Today styling */
.fc-day-today {
    background-color: #e7f3ff !important;
}

/* Weekend styling */
.fc-day-sat, .fc-day-sun {
    background-color: #f8f9fc !important;
}

/* Other month days */
.fc-day-other {
    background-color: #fafbfc !important;
    color: #858796 !important;
}

/* Calendar header customization */
.fc-toolbar {
    margin-bottom: 1rem;
}

.fc-toolbar-title {
    color: #5a5c69;
    font-size: 1.25rem;
    font-weight: 600;
}

.fc-button-primary {
    background-color: #4e73df;
    border-color: #4e73df;
}

.fc-button-primary:hover {
    background-color: #2e59d9;
    border-color: #2e59d9;
}

.fc-button-primary:disabled {
    background-color: #858796;
    border-color: #858796;
}

/* Legend styles - Simplified and more robust */
.calendar-legend {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 25px;
    padding: 15px;
    background-color: #f8f9fc;
    border-top: 2px solid #e3e6f0;
    font-size: 14px;
    margin-top: 15px;
    width: 100%;
    box-sizing: border-box;
    min-height: 50px;
    flex-wrap: nowrap;
    overflow-x: auto;
    white-space: nowrap;
}

.legend-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    flex: 0 0 auto;
}

.legend-color {
    width: 16px;
    height: 16px;
    min-width: 16px;
    min-height: 16px;
    border-radius: 2px;
    border: 1px solid #333;
    flex-shrink: 0;
    display: inline-block;
}

.legend-color.trading {
    background-color: #1cc88a;
    border: 3px solid #1cc88a;
}

.legend-color.transaction {
    background-color: #f6c23e;
    border: 3px solid #f6c23e;
}

.legend-color.positive {
    background-color: #d4edda;
    border: 1px solid #1cc88a;
}

.legend-color.negative {
    background-color: #f8d7da;
    border: 1px solid #e74a3b;
}

.legend-item span {
    font-weight: 500;
    color: #333;
    font-size: 13px;
    line-height: 16px;
}

.pnl-amount.has-transactions::after {
    content: '*';
    color: #f6c23e;
    font-weight: 700;
    margin-left: 4px;
    font-size: 0.75rem;
}

@media (max-width: 768px) {
    .calendar-legend {
        gap: 15px;
        justify-content: flex-start;
        padding: 12px;
    }
    
    .legend-item {
        gap: 6px;
    }
    
    .legend-item span {
        font-size: 12px;
    }
}

.loading-text {
    color: #5a5c69;
    font-weight: 600;
    font-size: 16px;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-day me-2"></i>{{ _('Daily Statistics') }}
        </h2>
        <p class="text-muted">{{ _('Monthly calendar view with daily floating P&L indicators') }}</p>
    </div>
</div>

<!-- Month Summary Cards -->
<div class="row mb-4" id="month-summary-cards">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            {{ _('Month Start') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-start-assets">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            {{ _('Month End') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-end-assets">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            {{ _('Total Change') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-total-change">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            {{ _('Return %%') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="month-return-pct">
                            0.00%
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-percentage fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar View + Daily P&L Chart -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="card shadow h-100">
            <div class="card-body">
                <div id="calendar"></div>

                <!-- Legend -->
                <div class="calendar-legend d-flex flex-nowrap align-items-center justify-content-center" style="display: flex; flex-wrap: nowrap; align-items: center; justify-content: center; gap: 25px; white-space: nowrap;">
                    <div class="legend-item" style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; flex: 0 0 auto;">
                        <div class="legend-color trading" style="display: inline-block; width: 16px; height: 16px; min-width: 16px; min-height: 16px; margin-right: 6px; background-color: #1cc88a; border: 3px solid #1cc88a;"></div>
                        <span>{{ _('Trading Day') }}</span>
                    </div>
                    <div class="legend-item" style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; flex: 0 0 auto;">
                        <div class="legend-color transaction" style="display: inline-block; width: 16px; height: 16px; min-width: 16px; min-height: 16px; margin-right: 6px; background-color: #f6c23e; border: 3px solid #f6c23e;"></div>
                        <span>{{ _('Has Transactions') }}</span>
                    </div>
                    <div class="legend-item" style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; flex: 0 0 auto;">
                        <div class="legend-color positive" style="display: inline-block; width: 16px; height: 16px; min-width: 16px; min-height: 16px; margin-right: 6px; background-color: #d4edda; border: 1px solid #1cc88a;"></div>
                        <span>{{ _('Positive P&L') }}</span>
                    </div>
                    <div class="legend-item" style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap; flex: 0 0 auto;">
                        <div class="legend-color negative" style="display: inline-block; width: 16px; height: 16px; min-width: 16px; min-height: 16px; margin-right: 6px; background-color: #f8d7da; border: 1px solid #e74a3b;"></div>
                        <span>{{ _('Negative P&L') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow h-100">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">{{ _('Daily P&L') }}</h6>
            </div>
            <div class="card-body">
                <canvas id="dailyPnlChart" height="320"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- FullCalendar JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
let calendarData = null;
let calendar = null;
let dailyPnlChart = null;

// Loading dialog helpers (integrated with global loader)
function showLoadingDialog() {
    const message = '正在加载数据...';

    if (window.GlobalLoading && typeof GlobalLoading.manualShow === 'function') {
        GlobalLoading.manualShow(message);
    } else if (window.GlobalLoading && typeof GlobalLoading.show === 'function') {
        GlobalLoading.show(message);
    } else {
        console.log('Loading dialog fallback:', message);
    }
}

function hideLoadingDialog() {
    if (window.GlobalLoading && typeof GlobalLoading.manualHide === 'function') {
        GlobalLoading.manualHide(300);
    } else if (window.GlobalLoading && typeof GlobalLoading.hide === 'function') {
        GlobalLoading.hide(300);
    }
}

// Get current family ID and other parameters
const familyId = {{ family.id if family else 'null' }};
{% raw %}
const memberId = new URLSearchParams(window.location.search).get('member_id');
const accountId = new URLSearchParams(window.location.search).get('account_id');
{% endraw %}

// Initialize FullCalendar
function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
        },
        height: 'auto',
        aspectRatio: 1.35,
        firstDay: 0, // Sunday
        showNonCurrentDates: true,
        fixedWeekCount: false,
        
        // Custom day cell content - will be updated after data loads
        dayCellDidMount: function(info) {
            const dateStr = info.date.toISOString().split('T')[0];
            console.log(`Calendar cell mounted: ${dateStr}, dayOfWeek=${info.date.getDay()}`);
            
            // Store cell reference for later update
            info.el.setAttribute('data-date-cell', dateStr);
        },
        
        // Handle date clicks
        dateClick: function(info) {
            onDayClick(info.dateStr);
        },
        
        // Handle month changes
        datesSet: function(info) {
            const startDate = info.view.currentStart;
            const year = startDate.getFullYear();
            const month = startDate.getMonth() + 1;
            
            // Show loading dialog when month changes
            showLoadingDialog();
            loadCalendarData(year, month);
        },
        
        // Make sure events are refetched after data loads
        eventDidMount: function(info) {
            console.log('Event mounted:', info);
        }
    });
    
    calendar.render();
}

function applyCalendarDataToView() {
    if (!calendarData) {
        return;
    }

    const dayElements = document.querySelectorAll('.fc-daygrid-day');
    const today = new Date().toISOString().split('T')[0];

    dayElements.forEach(dayEl => {
        const dateStr = dayEl.getAttribute('data-date');
        const hasData = !!(calendarData && calendarData.daily_stats && calendarData.daily_stats[dateStr]);
        console.log(`Checking day element: ${dateStr}, has data: ${hasData}`);

        const dayData = hasData ? calendarData.daily_stats[dateStr] : null;

        dayEl.classList.remove('positive-change', 'negative-change', 'significant-change', 'trading-day', 'has-transactions');

        if (dateStr && dateStr <= today && dayData && dayData.is_trading_day) {
            updateDayCell(dayEl, dateStr, dayData);
        } else {
            clearDayIndicators(dayEl);
        }
    });
}

// Load calendar data from API
function loadCalendarData(year, month) {
    let apiUrl = `/api/v1/daily-stats/calendar?year=${year}&month=${month}`;
    
    // Add account_ids parameter if specified in URL
    const urlParams = new URLSearchParams(window.location.search);
    const accountId = urlParams.get('account_id');
    const memberId = urlParams.get('member_id');
    
    if (accountId) {
        apiUrl += `&account_ids=${accountId}`;
    } else if (memberId) {
        // When member_id is specified, we need to get member's accounts
        // For now, just pass member_id and let backend handle it
        apiUrl += `&member_id=${memberId}`;
    }
    
    console.log('Loading calendar data from:', apiUrl);
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendarData = data.data;
                updateMonthSummaryCards(calendarData.month_summary);
                // Hide loading dialog after calendar cells updated
                if (calendar) {
                    setTimeout(() => {
                        applyCalendarDataToView();
                        renderDailyPnlChart(calendarData.daily_stats);
                        hideLoadingDialog();
                    }, 150);
                } else {
                    hideLoadingDialog();
                }
            } else {
                console.error('Failed to load calendar data:', data.error);
                hideLoadingDialog();
            }
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
            hideLoadingDialog();
        });
}

// Update month summary cards
function updateMonthSummaryCards(summary) {
    document.getElementById('month-start-assets').textContent = 
        '$' + (summary.start_assets || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    document.getElementById('month-end-assets').textContent = 
        '$' + (summary.end_assets || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
    const totalChange = summary.total_change || 0;
    const changeElement = document.getElementById('month-total-change');
    changeElement.textContent = '$' + totalChange.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    changeElement.className = 'h5 mb-0 font-weight-bold ' + (totalChange >= 0 ? 'text-success' : 'text-danger');
    
    const returnPct = summary.return_pct || 0;
    const returnElement = document.getElementById('month-return-pct');
    returnElement.textContent = returnPct.toFixed(2) + '%';
    returnElement.className = 'h5 mb-0 font-weight-bold ' + (returnPct >= 0 ? 'text-success' : 'text-danger');
    
    // Summary cards are always visible now
}

// Function to update individual day cell with P&L data
function updateDayCell(dayEl, dateStr, dayData) {
    // Remove existing P&L data if any
    const existingPnl = dayEl.querySelector('.pnl-data');
    if (existingPnl) {
        existingPnl.remove();
    }
    
    if (!dayData || !dayData.is_trading_day) {
        clearDayIndicators(dayEl);
        return;
    }

    const dailyChange = dayData.daily_change || 0;
    const dailyReturnPct = dayData.daily_return_pct || 0;
    
    console.log(`Manual update ${dateStr}: change=${dailyChange.toFixed(2)}, return=${dailyReturnPct.toFixed(2)}%`);

    // Add CSS classes for styling
    dayEl.classList.remove('positive-change', 'negative-change', 'significant-change', 'trading-day', 'has-transactions');
    dayEl.classList.add('trading-day');
    if (dayData.has_transactions) {
        dayEl.classList.add('has-transactions');
    }

    if (Math.abs(dailyChange) > 0) {
        if (dailyChange > 0) {
            dayEl.classList.add('positive-change');
        } else {
            dayEl.classList.add('negative-change');
        }
    }
    
    if (Math.abs(dailyReturnPct) > 5) {
        dayEl.classList.add('significant-change');
    }
    // Add P&L data display
    const pnlContainer = document.createElement('div');
    pnlContainer.className = 'pnl-data';
    
    const formattedAmount = `${dailyChange >= 0 ? '+' : ''}$${Math.abs(dailyChange).toLocaleString('en-US', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    })}`;
    const formattedPercent = `${dailyReturnPct >= 0 ? '+' : ''}${dailyReturnPct.toFixed(2)}%`;
    
    const pnlDiv = document.createElement('div');
    pnlDiv.className = `pnl-amount ${dailyChange >= 0 ? 'positive' : 'negative'}`;
    pnlDiv.textContent = `${formattedAmount}(${formattedPercent})`;
    if (dayData.has_transactions) {
        pnlDiv.classList.add('has-transactions');
    }
    
    if (dailyChange >= 0) {
        pnlDiv.style.color = '#1cc88a';
        pnlDiv.style.fontWeight = 'bold';
    } else {
        pnlDiv.style.color = '#e74a3b';
        pnlDiv.style.fontWeight = 'bold';
    }
    
    pnlContainer.appendChild(pnlDiv);
    
    const dayFrame = dayEl.querySelector('.fc-daygrid-day-frame');
    if (dayFrame) {
        dayFrame.appendChild(pnlContainer);
    }
}

function clearDayIndicators(dayEl) {
    const existing = dayEl.querySelector('.pnl-data');
    if (existing) {
        existing.remove();
    }
    dayEl.classList.remove('positive-change', 'negative-change', 'significant-change', 'trading-day', 'has-transactions');
}

function renderDailyPnlChart(dailyStats) {
    if (!dailyStats) return;
    const todayISO = new Date().toISOString().split('T')[0];

    const statsArray = Object.values(dailyStats)
        .filter(day => day.is_trading_day && day.date <= todayISO)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    const labels = statsArray.map(day => day.date.slice(-5));
    const values = statsArray.map(day => day.daily_change || 0);

    const ctx = document.getElementById('dailyPnlChart');
    if (!ctx) return;

    if (dailyPnlChart) {
        dailyPnlChart.destroy();
    }

    dailyPnlChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: '{{ _('Daily Change') }}',
                data: values,
                backgroundColor: values.map(v => v >= 0 ? 'rgba(28, 200, 138, 0.8)' : 'rgba(231, 74, 59, 0.8)'),
                borderRadius: 4,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    ticks: {
                        color: '#6e707e',
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 12
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    ticks: {
                        color: '#6e707e',
                        callback: value => `$${value.toLocaleString()}`
                    },
                    grid: {
                        color: 'rgba(234, 236, 244, 0.4)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: context => {
                            const value = context.parsed.y || 0;
                            return `${value >= 0 ? '+' : ''}$${value.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });
}

// Handle day click to show details
function onDayClick(dateStr) {
    const params = new URLSearchParams();
    if (accountId) {
        params.append('account_ids', accountId);
    } else if (memberId) {
        params.append('member_id', memberId);
    }

    const apiUrl = params.toString()
        ? `/api/v1/daily-stats/day/${dateStr}?${params.toString()}`
        : `/api/v1/daily-stats/day/${dateStr}`;

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showDayDetails(data.data);
            } else {
                console.error('Failed to load day details:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading day details:', error);
        });
}

// Show day details in modal or alert
function showDayDetails(dayData) {
    const assets = dayData.floating_pnl.total_assets || 0;
    const change = dayData.floating_pnl.daily_change || 0;
    const returnPct = dayData.floating_pnl.daily_return_pct || 0;
    
    alert(`Date: ${dayData.date}\nTotal Assets: $${assets.toLocaleString()}\nDaily Change: ${change >= 0 ? '+' : ''}$${change.toLocaleString()}\nReturn: ${returnPct.toFixed(2)}%`);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
});
</script>
{% endblock %}
