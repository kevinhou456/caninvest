{% extends "base/investment_base.html" %}

{% block extra_css %}
<style>
    /* 复制overview页面的所有样式 */
    .metric-card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .metric-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 0.5rem;
        flex-shrink: 0;
    }

    .holdings-table {
        font-size: 0.9rem;
    }

    .stock-avatar {
        width: 32px;
        height: 32px;
        font-size: 11px;
        font-weight: 600;
    }

    .return-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* 账户详情悬停提示样式 - 优雅白色风格 */
    .account-tooltip {
        cursor: help;
        position: relative;
    }

.hb-tooltip {
    position: fixed;
    background: #fffbea;
    color: #212529;
    border: 1px solid #f0e6b6;
    border-radius: 8px;
    padding: 8px 10px;
    font-size: 0.85rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-width: 700px;
    white-space: nowrap;
    z-index: 2000;
    pointer-events: none;
}


    /* 多选下拉框样式 */
    .multiselect-dropdown {
        position: relative;
        display: inline-block;
        min-width: 250px;
    }

    .multiselect-dropdown .dropdown-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        background: white;
        cursor: pointer;
        text-align: left;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }

    .multiselect-dropdown .dropdown-menu {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .multiselect-dropdown .dropdown-item {
        padding: 0.5rem 0.75rem;
        display: flex;
        align-items: center;
    }

    .multiselect-dropdown .dropdown-item input[type="checkbox"] {
        margin-right: 0.5rem;
    }

    .account-section-divider {
        border-bottom: 2px solid #e9ecef;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
    }

    /* 拖拽样式 */
    .currency-symbol {
        cursor: move;
        user-select: none;
        transition: all 0.3s ease;
    }

    .currency-symbol:hover {
        transform: scale(1.1);
    }

    .currency-symbol.dragging {
        opacity: 0.5;
        transform: rotate(15deg);
    }

    .holdings-row {
        transition: all 0.3s ease;
    }

    .holdings-row.dragging {
        opacity: 0.7;
        background-color: #e3f2fd;
        transform: scale(0.95);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .holdings-row.drag-over {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        transform: translateX(5px);
    }

    /* 期间选择按钮样式，提升对比度 */
    .hb-period-btn-group .hb-period-btn {
        background: #f2f7ff;
        color: #0b5ed7;
        border: 1px solid #99b9ff;
        font-weight: 600;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }

    .hb-period-btn-group .hb-period-btn:hover {
        background: #e4edff;
        color: #0b5ed7;
    }

    .hb-period-btn-group .hb-period-btn.active {
        background: linear-gradient(135deg, #0b5ed7, #0a58ca);
        color: #fff;
        border-color: #0a58ca;
        box-shadow: 0 0 0 2px rgba(11,94,215,0.15);
    }
</style>
{% endblock %}

{% block content %}
<!-- Holdings Board Header -->
<div class="row mb-3 align-items-center">
    <div class="col-6">
        <h4 class="mb-0">{{ _('Holdings Board') }}</h4>
    </div>
    <div class="col-6 text-end">
        <button class="btn btn-primary" onclick="loadHoldings(true)">
            <i class="fas fa-sync-alt me-1"></i>{{ _('Refresh') }}
        </button>
    </div>
</div>

<div class="container-fluid">
    <!-- 控制面板 -->
    <div class="row mb-3 align-items-end">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-end gap-3 justify-content-between">
                <div class="d-flex flex-wrap align-items-end gap-3">
                    <div>
                        <label class="form-label mb-2">
                            <i class="fas fa-university me-1"></i>{{ _('Select Accounts') }}:
                        </label>
                        <div class="multiselect-dropdown">
                            <div class="dropdown-toggle" id="accountDropdownToggle">
                                <span id="selectedAccountsText">{{ _('All Accounts') }}</span>
                            </div>
                            <div class="dropdown-menu" id="accountDropdownMenu" style="display: none;">
                                <div class="dropdown-item">
                                    <input type="checkbox" id="selectAll" checked>
                                    <label for="selectAll"><strong>{{ _('Select All') }}</strong></label>
                                </div>
                                <div class="dropdown-divider"></div>
                                {% for account in accounts %}
                                <div class="dropdown-item">
                                    <input type="checkbox" id="account{{ account.id }}" value="{{ account.id }}" class="account-checkbox" checked>
                                    <label for="account{{ account.id }}">{{ _get_account_name_with_members(account) }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="form-check" style="margin-bottom: 0;">
                        <input class="form-check-input" type="checkbox" id="separateByAccount">
                        <label class="form-check-label" for="separateByAccount">
                            {{ _('Separate by Account') }}
                        </label>
                    </div>
                </div>

                <div class="btn-group btn-group-sm hb-period-btn-group ms-auto" role="group" aria-label="Period selector">
                    <button type="button" class="btn hb-period-btn period-btn active" data-period="1M">1M</button>
                    <button type="button" class="btn hb-period-btn period-btn" data-period="3M">3M</button>
                    <button type="button" class="btn hb-period-btn period-btn" data-period="6M">6M</button>
                    <button type="button" class="btn hb-period-btn period-btn" data-period="YTD">YTD</button>
                    <button type="button" class="btn hb-period-btn period-btn" data-period="1Y">1Y</button>
                    <button type="button" class="btn hb-period-btn period-btn" data-period="ALL">ALL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 持仓显示区域 -->
    <div id="holdingsContent">
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{ _('Loading...') }}</span>
            </div>
            <div class="mt-2">{{ _('Loading holdings data...') }}</div>
        </div>
    </div>
</div>

<script>
// localStorage keys
const STORAGE_KEY_ACCOUNTS = 'holdingsBoard_selectedAccounts';
const STORAGE_KEY_SEPARATE = 'holdingsBoard_separateByAccount';
const STORAGE_KEY_HIDDEN = 'holdingsBoard_hiddenSymbols';

// client-side state
let hiddenSymbols = new Set();

// 多选下拉框功能
document.addEventListener('DOMContentLoaded', function() {
    hiddenSymbols = loadHiddenSymbolsFromStorage();

    const dropdownToggle = document.getElementById('accountDropdownToggle');
    const dropdownMenu = document.getElementById('accountDropdownMenu');
    const selectAllCheckbox = document.getElementById('selectAll');
    const accountCheckboxes = document.querySelectorAll('.account-checkbox');
    const selectedAccountsText = document.getElementById('selectedAccountsText');
    const separateByAccountCheckbox = document.getElementById('separateByAccount');

    // 恢复保存的选择
    restoreSavedSelections();

    // 切换下拉菜单显示
    dropdownToggle.addEventListener('click', function() {
        const isShown = dropdownMenu.style.display === 'block';
        dropdownMenu.style.display = isShown ? 'none' : 'block';
    });

    // 点击外部关闭下拉菜单
    document.addEventListener('click', function(event) {
        if (!dropdownToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
            dropdownMenu.style.display = 'none';
        }
    });

    // 全选/取消全选
    selectAllCheckbox.addEventListener('change', function() {
        accountCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateSelectedAccountsText();
        saveSelectedAccounts();
        loadHoldings();
    });

    // 单个账户选择
    accountCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllState();
            updateSelectedAccountsText();
            saveSelectedAccounts();
            loadHoldings();
        });
    });

    // 显示模式改变
    separateByAccountCheckbox.addEventListener('change', function() {
        saveSeparateByAccount();
        loadHoldings();
    });

    // 更新全选状态
    function updateSelectAllState() {
        const checkedCount = Array.from(accountCheckboxes).filter(cb => cb.checked).length;
        selectAllCheckbox.checked = checkedCount === accountCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < accountCheckboxes.length;
    }

    // 更新选中账户显示文本
    function updateSelectedAccountsText() {
        const checkedBoxes = Array.from(accountCheckboxes).filter(cb => cb.checked);
        if (checkedBoxes.length === 0) {
            selectedAccountsText.textContent = '{{ _("No accounts selected") }}';
        } else if (checkedBoxes.length === accountCheckboxes.length) {
            selectedAccountsText.textContent = '{{ _("All Accounts") }}';
        } else if (checkedBoxes.length === 1) {
            const label = checkedBoxes[0].nextElementSibling.textContent;
            selectedAccountsText.textContent = label;
        } else {
            selectedAccountsText.textContent = `{{ _("Selected") }} ${checkedBoxes.length} {{ _("accounts") }}`;
        }
    }

    // 绑定期间按钮
    bindPeriodButtons();

    // 页面加载后自动加载数据
    setTimeout(() => {
        loadHoldings();
    }, 500);
});

function loadHoldings(forceRefresh = false) {
    console.log('Loading holdings...', forceRefresh ? 'with forced price refresh' : '');

    // 获取选中的账户
    const checkedBoxes = Array.from(document.querySelectorAll('.account-checkbox:checked'));
    const selectedAccountIds = checkedBoxes.map(cb => cb.value);
    const separateByAccount = document.getElementById('separateByAccount').checked;
    const activePeriodBtn = document.querySelector('.period-btn.active');
    const selectedPeriod = activePeriodBtn ? activePeriodBtn.dataset.period : '1M';

    console.log('Selected accounts:', selectedAccountIds);
    console.log('Separate by account:', separateByAccount);

    if (selectedAccountIds.length === 0) {
        document.getElementById('holdingsContent').innerHTML = `
            <div class="alert alert-warning m-3">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ _('Please select at least one account') }}
            </div>
        `;
        return;
    }

    // 显示加载状态
    const loadingMessage = forceRefresh ? '{{ _("Refreshing prices from Yahoo Finance...") }}' : '{{ _("Loading holdings data...") }}';
    document.getElementById('holdingsContent').innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{{ _('Loading...') }}</span>
            </div>
            <div class="mt-2">${loadingMessage}</div>
        </div>
    `;

    // 构建API URL
    let apiUrl = '/api/holdings-board?' + selectedAccountIds.map(id => `account_ids=${id}`).join('&');
    apiUrl += `&period=${selectedPeriod}`;
    if (forceRefresh) {
        apiUrl += '&force_refresh=true';
    }
    console.log('API URL:', apiUrl);

    // 发起API请求
    fetch(apiUrl)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            if (data.success) {
                renderHoldings(data.data, separateByAccount, selectedAccountIds);
            } else {
                document.getElementById('holdingsContent').innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-circle me-2"></i>{{ _('Error') }}: ${data.error || '{{ _("Failed to load holdings") }}'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            document.getElementById('holdingsContent').innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-circle me-2"></i>{{ _('Network error') }}: ${error.message}
                </div>
            `;
        });
}

function renderHoldings(accountsData, separateByAccount, selectedAccountIds) {
    console.log('Rendering holdings:', accountsData, 'Separate by account:', separateByAccount);

    if (!accountsData || accountsData.length === 0) {
        document.getElementById('holdingsContent').innerHTML = `
            <div class="alert alert-warning m-3">
                <i class="fas fa-info-circle me-2"></i>{{ _('No accounts found') }}
            </div>
        `;
        return;
    }

    const clonedAccounts = cloneHoldingsData(accountsData);

    const hasAnyHoldings = clonedAccounts.some(account => (account.holdings || []).length > 0);
    if (!hasAnyHoldings) {
        document.getElementById('holdingsContent').innerHTML = `
            <div class="alert alert-info m-3">
                <i class="fas fa-chart-pie me-2"></i>{{ _('No holdings found') }}
            </div>
        `;
        return;
    }

    const visibleAccountsData = clonedAccounts
        .map(account => {
            const visibleHoldings = filterVisibleHoldings(account.holdings);
            return { ...account, holdings: visibleHoldings };
        })
        .filter(account => account.holdings && account.holdings.length > 0);

    if (visibleAccountsData.length === 0) {
        showAllHiddenHoldingsMessage();
        return;
    }

    if (separateByAccount) {
        renderSequentialView(visibleAccountsData);
    } else {
        const mergedHoldings = mergeHoldingsBySymbol(visibleAccountsData);
        renderMergedView(mergedHoldings);
    }
}

function renderMergedView(holdings) {
    const mergedHoldings = Array.isArray(holdings) ? holdings : [];

    if (mergedHoldings.length === 0) {
        showAllHiddenHoldingsMessage();
        return;
    }

    // 使用完全相同的overview样式
    let html = `
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>{{ _('Active') }}
                </h5>
                <span class="badge bg-secondary" data-label-stocks="{{ _('stocks') }}">${mergedHoldings.length} {{ _('stocks') }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 holdings-table hb-sortable" id="holdingsBoardTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3 sortable" data-sort="symbol">
                                    {{ _('Stock Symbol') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="shares">
                                    {{ _('Shares') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="avg_cost">
                                    {{ _('Avg Cost') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="current_price">
                                    {{ _('Current Price') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="daily_change">
                                    {{ _('Daily Change') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="market_value">
                                    {{ _('Market Value') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="unrealized_gain">
                                    {{ _('Unrealized P&L') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="realized_gain">
                                    {{ _('Realized Gains') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="dividends">
                                    {{ _('Dividends') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end sortable" data-sort="interest">
                                    {{ _('Interest') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                                <th class="text-end pe-3 sortable" data-sort="return_percent">
                                    {{ _('Return Percent') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    const stockDetailBase = `{{ url_for('main.stock_detail', stock_symbol='__SYMBOL__') }}`;
    mergedHoldings.forEach(holding => {
        // 使用与overview完全相同的字段名
        const unrealizedGain = toSafeNumber(holding.unrealized_gain);
        const unrealizedGainPercent = toSafeNumber(holding.unrealized_gain_percent);
        const totalReturnPct = calculateTotalReturnPercent(holding);
        const tooltip = buildTxTooltip(holding);
        const tooltipAttr = tooltip ? `data-tooltip-html-enc="${encodeURIComponent(tooltip)}"` : '';
        const detailUrl = stockDetailBase.replace('__SYMBOL__', encodeURIComponent(holding.symbol || ''));

        html += `
            <tr class="align-middle holdings-row"
                data-symbol="${holding.symbol}"
                data-currency="${holding.currency}"
                data-sector="${holding.sector || 'Unknown'}"
                data-shares="${holding.shares || 0}"
                data-avg-cost="${holding.average_cost || 0}"
                data-current-price="${holding.current_price || 0}"
                data-daily-change="${holding.daily_change_value || 0}"
                data-market-value="${holding.current_value || 0}"
                data-unrealized-gain="${holding.unrealized_gain || 0}"
                data-realized-gain="${holding.realized_gain || 0}"
                data-dividends="${(holding.dividends || 0)}"
                data-interest="${(holding.interest || 0)}"
                data-return-percent="${totalReturnPct || 0}"
                ${tooltipAttr}>
                <!-- Stock Symbol -->
                <td class="ps-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-${holding.currency === 'CAD' ? 'warning' : 'success'} rounded-circle d-flex align-items-center justify-content-center me-2 stock-avatar currency-symbol"
                             style="color: ${holding.currency === 'CAD' ? 'black' : 'white'};"
                             draggable="true"
                             data-symbol="${holding.symbol}">
                            ${holding.currency === 'CAD' ? 'C$' : '$'}
                        </div>
                        <div>
                            <a href="${detailUrl}" class="text-decoration-none fw-bold">${holding.symbol}</a>
                            <br><small class="text-muted">${holding.sector || 'Unknown'}</small>
                        </div>
                    </div>
                </td>

                <!-- Shares -->
                <td class="text-end">
                    <span class="fw-medium">${(holding.shares || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                </td>

                <!-- Average Cost -->
                <td class="text-end">
                    <span class="text-muted">$${(holding.average_cost || 0).toFixed(2)}</span>
                    <br><small class="text-muted">${holding.currency}</small>
                </td>

                <!-- Current Price -->
                <td class="text-end">
                    <span class="fw-medium">$${(holding.current_price || 0).toFixed(2)}</span>
                    <br><small class="text-muted">${holding.currency}</small>
                </td>

                <!-- Daily Change -->
                <td class="text-end">
                    <span class="fw-medium ${(holding.daily_change_value || 0) >= 0 ? 'text-success' : 'text-danger'}">
                        ${(holding.daily_change_value || 0) >= 0 ? '+' : '-'}$${Math.abs(holding.daily_change_value || 0).toFixed(2)}
                    </span>
                    <br>
                    <small class="${(holding.daily_change_percent || 0) >= 0 ? 'text-success' : 'text-danger'}">
                        ${(holding.daily_change_percent || 0) >= 0 ? '+' : ''}${(holding.daily_change_percent || 0).toFixed(2)}%
                    </small>
                </td>

                <!-- Market Value -->
                <td class="text-end">
                    <span class="fw-bold">$${(holding.current_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    <br><small class="text-muted">${holding.currency}</small>
                </td>

                <!-- Unrealized Gain/Loss -->
                <td class="text-end">
                    <span class="fw-bold ${unrealizedGain >= 0 ? 'text-success' : 'text-danger'}">
                        ${unrealizedGain >= 0 ? '+' : '-'}$${Math.abs(unrealizedGain).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </span>
                    <br>
                    <small class="fw-bold text-muted ${unrealizedGainPercent >= 0 ? 'text-success' : 'text-danger'}">
                        ${unrealizedGainPercent >= 0 ? '+' : '-'}${Math.abs(unrealizedGainPercent).toFixed(1)}%
                    </small>
                </td>

                <!-- Realized Gains -->
                <td class="text-end">
                    <span class="fw-medium ${(holding.realized_gain || 0) >= 0 ? 'text-success' : 'text-danger'}">
                        ${(holding.realized_gain || 0) >= 0 ? '+' : '-'}$${Math.abs(holding.realized_gain || 0).toFixed(2)}
                    </span>
                </td>

                <!-- Dividends -->
                <td class="text-end">
                    <span class="fw-medium text-info">
                        $${(holding.dividends || 0).toFixed(2)}
                    </span>
                </td>

                <!-- Interest -->
                <td class="text-end">
                    <span class="fw-medium text-warning">
                        $${(holding.interest || 0).toFixed(2)}
                    </span>
                </td>

                <!-- Return Percentage -->
                <td class="text-end pe-3">
                    <span class="badge ${totalReturnPct >= 0 ? 'bg-success' : 'bg-danger'} return-badge">
                        ${totalReturnPct >= 0 ? '+' : ''}${totalReturnPct.toFixed(1)}%
                    </span>
                </td>
            </tr>
        `;
    });

    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    document.getElementById('holdingsContent').innerHTML = html;

    // 添加拖拽和右键菜单事件监听器
    setupDragAndDropEvents();
    initHoldingsTooltips();
    initHoldingsBoardSorting();
    bindPeriodButtons();
}

function renderSequentialView(accountsData) {
    let html = '';

    const stockDetailBase = `{{ url_for('main.stock_detail', stock_symbol='__SYMBOL__', account_id='__ACCOUNT__') }}`;
    accountsData.forEach(account => {
        if (!account.holdings || account.holdings.length === 0) {
            return;
        }

        html += `
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center account-section-divider">
                    <h5 class="mb-0">
                        <i class="fas fa-university me-2"></i>${account.account_name}
                    </h5>
                    <span class="badge bg-secondary" data-label-stocks="{{ _('stocks') }}">${account.holdings.length} {{ _('stocks') }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 holdings-table hb-sortable" id="holdingsBoardTable-${account.account_id}">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3 sortable" data-sort="symbol">
                                        {{ _('Stock Symbol') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="shares">
                                        {{ _('Shares') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="avg_cost">
                                        {{ _('Avg Cost') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="current_price">
                                        {{ _('Current Price') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="daily_change">
                                        {{ _('Daily Change') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="market_value">
                                        {{ _('Market Value') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="unrealized_gain">
                                        {{ _('Unrealized P&L') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="realized_gain">
                                        {{ _('Realized Gains') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="dividends">
                                        {{ _('Dividends') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="interest">
                                        {{ _('Interest') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end pe-3 sortable" data-sort="return_percent">
                                        {{ _('Return Percent') }} <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        account.holdings.forEach(holding => {
            const unrealizedGain = toSafeNumber(holding.unrealized_gain);
            const unrealizedGainPercent = toSafeNumber(holding.unrealized_gain_percent);
            const totalReturnPct = calculateTotalReturnPercent(holding);
            const tooltip = buildTxTooltip(holding);
            const tooltipAttr = tooltip ? `data-tooltip-html-enc="${encodeURIComponent(tooltip)}"` : '';
            const detailUrl = stockDetailBase
                .replace('__SYMBOL__', encodeURIComponent(holding.symbol || ''))
                .replace('__ACCOUNT__', encodeURIComponent(account.account_id || ''));

            html += `
                <tr class="align-middle holdings-row"
                    data-symbol="${holding.symbol}"
                    data-currency="${holding.currency}"
                    data-sector="${holding.sector || 'Unknown'}"
                    data-shares="${holding.shares || 0}"
                    data-avg-cost="${holding.average_cost || 0}"
                    data-current-price="${holding.current_price || 0}"
                    data-daily-change="${holding.daily_change_value || 0}"
                    data-market-value="${holding.current_value || 0}"
                    data-unrealized-gain="${holding.unrealized_gain || 0}"
                    data-realized-gain="${holding.realized_gain || 0}"
                    data-dividends="${(holding.dividends || 0)}"
                    data-interest="${(holding.interest || 0)}"
                    data-return-percent="${totalReturnPct || 0}"
                    ${tooltipAttr}>
                    <!-- Stock Symbol -->
                    <td class="ps-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-${holding.currency === 'CAD' ? 'warning' : 'success'} rounded-circle d-flex align-items-center justify-content-center me-2 stock-avatar"
                                 style="color: ${holding.currency === 'CAD' ? 'black' : 'white'};">
                                ${holding.currency === 'CAD' ? 'C$' : '$'}
                            </div>
                            <div>
                                <a href="${detailUrl}" class="text-decoration-none fw-bold">${holding.symbol}</a>
                                <br><small class="text-muted">${holding.sector || 'Unknown'}</small>
                            </div>
                        </div>
                    </td>

                    <!-- Shares -->
                    <td class="text-end">
                        <span class="fw-medium">${(holding.shares || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                    </td>

                    <!-- Average Cost -->
                    <td class="text-end">
                        <span class="text-muted">$${(holding.average_cost || 0).toFixed(2)}</span>
                        <br><small class="text-muted">${holding.currency}</small>
                    </td>

                    <!-- Current Price -->
                    <td class="text-end">
                        <span class="fw-medium">$${(holding.current_price || 0).toFixed(2)}</span>
                        <br><small class="text-muted">${holding.currency}</small>
                    </td>

                    <!-- Daily Change -->
                    <td class="text-end">
                        <span class="fw-medium ${(holding.daily_change_value || 0) >= 0 ? 'text-success' : 'text-danger'}">
                            ${(holding.daily_change_value || 0) >= 0 ? '+' : '-'}$${Math.abs(holding.daily_change_value || 0).toFixed(2)}
                        </span>
                        <br>
                        <small class="${(holding.daily_change_percent || 0) >= 0 ? 'text-success' : 'text-danger'}">
                            ${(holding.daily_change_percent || 0) >= 0 ? '+' : ''}${(holding.daily_change_percent || 0).toFixed(2)}%
                        </small>
                    </td>

                    <!-- Market Value -->
                    <td class="text-end">
                        <span class="fw-bold">$${(holding.current_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        <br><small class="text-muted">${holding.currency}</small>
                    </td>

                    <!-- Unrealized Gain/Loss -->
                    <td class="text-end">
                        <span class="fw-bold ${unrealizedGain >= 0 ? 'text-success' : 'text-danger'}">
                            ${unrealizedGain >= 0 ? '+' : '-'}$${Math.abs(unrealizedGain).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                        </span>
                        <br>
                        <small class="fw-bold text-muted ${unrealizedGainPercent >= 0 ? 'text-success' : 'text-danger'}">
                            ${unrealizedGainPercent >= 0 ? '+' : '-'}${Math.abs(unrealizedGainPercent).toFixed(1)}%
                        </small>
                    </td>

                    <!-- Realized Gains -->
                    <td class="text-end">
                        <span class="fw-medium ${(holding.realized_gain || 0) >= 0 ? 'text-success' : 'text-danger'}">
                            ${(holding.realized_gain || 0) >= 0 ? '+' : '-'}$${Math.abs(holding.realized_gain || 0).toFixed(2)}
                        </span>
                    </td>

                    <!-- Dividends -->
                    <td class="text-end">
                        <span class="fw-medium text-info">
                            $${(holding.dividends || 0).toFixed(2)}
                        </span>
                    </td>

                    <!-- Interest -->
                    <td class="text-end">
                        <span class="fw-medium text-warning">
                            $${(holding.interest || 0).toFixed(2)}
                        </span>
                    </td>

                    <!-- Return Percentage -->
                    <td class="text-end pe-3">
                        <span class="badge ${totalReturnPct >= 0 ? 'bg-success' : 'bg-danger'} return-badge">
                            ${totalReturnPct >= 0 ? '+' : ''}${totalReturnPct.toFixed(1)}%
                        </span>
                    </td>
                </tr>
            `;
        });

        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });

    if (html === '') {
        showAllHiddenHoldingsMessage();
        return;
    }

    document.getElementById('holdingsContent').innerHTML = html;

    // 添加拖拽和右键菜单事件监听器
    setupDragAndDropEvents();
    initHoldingsTooltips();
    initHoldingsBoardSorting();
    bindPeriodButtons();
}

function cloneHoldingsData(accountsData) {
    return (accountsData || []).map(account => ({
        ...account,
        holdings: (account.holdings || []).map(holding => ({ ...holding }))
    }));
}

function filterVisibleHoldings(holdings) {
    return (holdings || []).filter(holding => holding && !hiddenSymbols.has(holding.symbol));
}

function formatShareCount(value) {
    const num = Number(value) || 0;
    const isInt = Number.isInteger(num);
    return num.toLocaleString('en-US', { minimumFractionDigits: isInt ? 0 : 4, maximumFractionDigits: isInt ? 0 : 4 });
}

function toSafeNumber(value) {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
}

function getTotalBoughtValue(holding) {
    if (!holding) return 0;
    return toSafeNumber(holding.total_bought_value);
}

function calculateTotalReturnPercent(holding) {
    const totalGain = toSafeNumber(holding.unrealized_gain) +
        toSafeNumber(holding.realized_gain) +
        toSafeNumber(holding.dividends ?? holding.dividend_received) +
        toSafeNumber(holding.interest ?? holding.interest_received);
    const base = getTotalBoughtValue(holding);
    return base ? (totalGain / base) * 100 : 0;
}

function initHoldingsTooltips() {
    const tooltipElements = document.querySelectorAll('[data-tooltip-html], [data-tooltip-html-enc]');
    let tooltipEl = null;

    const showTooltip = (e, content) => {
        if (!content) return;
        if (!tooltipEl) {
            tooltipEl = document.createElement('div');
            tooltipEl.className = 'hb-tooltip';
            document.body.appendChild(tooltipEl);
        }
        tooltipEl.innerHTML = content;
        tooltipEl.style.display = 'block';
        moveTooltip(e);
    };

    const moveTooltip = (e) => {
        if (!tooltipEl) return;
        const padding = 12;
        const x = e.clientX + padding;
        const y = e.clientY + padding;
        tooltipEl.style.left = `${x}px`;
        tooltipEl.style.top = `${y}px`;
    };

    const hideTooltip = () => {
        if (tooltipEl) {
            tooltipEl.style.display = 'none';
        }
    };

    tooltipElements.forEach(el => {
        const content = el.getAttribute('data-tooltip-html');
        const encContent = el.getAttribute('data-tooltip-html-enc');
        const finalContent = encContent ? decodeURIComponent(encContent) : content;
        el.addEventListener('mouseenter', (e) => showTooltip(e, finalContent));
        el.addEventListener('mousemove', moveTooltip);
        el.addEventListener('mouseleave', hideTooltip);
        el.addEventListener('mousedown', hideTooltip);
        el.addEventListener('click', hideTooltip);
    });
}

function buildTxTooltip(holding) {
    const txs = holding.period_transactions || [];
    if (!Array.isArray(txs) || txs.length === 0) return '';
    const escapeHtml = (text) => (text || '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    const currentPrice = Number(holding.current_price || 0);
    const rows = txs.map(tx => {
        const qty = formatShareCount(tx.quantity || 0);
        const priceNum = Number(tx.price || 0);
        const price = priceNum.toFixed(2);
        const type = tx.type || '';
        const date = tx.date || '';
        const acc = tx.account_name ? ` (${tx.account_name})` : '';
        const base = escapeHtml(`${date} ${type} ${qty} @ $${price}${acc}`);

        if (type === 'BUY' && priceNum > 0 && currentPrice > 0) {
            const pnlPct = ((currentPrice - priceNum) / priceNum) * 100;
            const colorClass = pnlPct >= 0 ? 'text-success' : 'text-danger';
            const sign = pnlPct >= 0 ? '+' : '';
            return `${base} <span class="${colorClass}">(${sign}${pnlPct.toFixed(2)}%)</span>`;
        }
        return base;
    });
    const header = escapeHtml(holding.symbol || '');
    return `<strong>${header}</strong><br>${rows.join('<br>')}`;
}

function mergeHoldingsBySymbol(accountsData) {
    const merged = new Map();

    const toNumber = (value) => {
        const num = Number(value);
        return Number.isFinite(num) ? num : 0;
    };

    (accountsData || []).forEach(account => {
        (account.holdings || []).forEach(holding => {
            if (!holding || !holding.symbol) {
                return;
            }

            const currency = (holding.currency || 'USD').toUpperCase();
            const key = `${holding.symbol}__${currency}`;

            const shares = toNumber(holding.shares ?? holding.current_shares);
            const currentValue = toNumber(holding.current_value);
            const currentValueCad = toNumber(holding.current_value_cad ?? currentValue);
            const dailyChangeValue = toNumber(holding.daily_change_value);
            const averageCost = toNumber(holding.average_cost);
            const averageCostCad = toNumber(holding.average_cost_cad ?? averageCost);
            const totalCost = toNumber(holding.total_cost);
            const totalCostNative = toNumber(holding.total_cost_native ?? (averageCost * shares));
            const totalCostCad = toNumber(holding.total_cost_cad ?? totalCost ?? averageCostCad * shares);
            const currentPrice = toNumber(holding.current_price);
            const unrealizedGain = toNumber(holding.unrealized_gain);
            const realizedGain = toNumber(holding.realized_gain);
            const dividends = toNumber(holding.dividends ?? holding.dividend_received);
            const interest = toNumber(holding.interest ?? holding.interest_received);
            const totalBoughtValue = toNumber(holding.total_bought_value);
            const totalSoldValue = toNumber(holding.total_sold_value);
            const totalBoughtShares = toNumber(holding.total_bought_shares);
            const totalSoldShares = toNumber(holding.total_sold_shares);
            const previousValue = currentValue - dailyChangeValue;
            const periodTx = Array.isArray(holding.period_transactions) ? holding.period_transactions : [];

            let entry = merged.get(key);
            if (!entry) {
                entry = {
                    symbol: holding.symbol,
                    currency,
                    company_name: holding.company_name,
                    sector: holding.sector,
                    shares,
                    current_shares: shares,
                    current_value: currentValue,
                    current_value_cad: currentValueCad,
                    daily_change_value: dailyChangeValue,
                    realized_gain: realizedGain,
                    unrealized_gain: unrealizedGain,
                    dividends,
                    interest,
                    total_bought_value: totalBoughtValue,
                    total_sold_value: totalSoldValue,
                    total_bought_shares: totalBoughtShares,
                    total_sold_shares: totalSoldShares,
                    average_cost: averageCost,
                    average_cost_cad: averageCostCad,
                    current_price: currentPrice,
                    unrealized_gain_percent: toNumber(holding.unrealized_gain_percent),
                    daily_change_percent: toNumber(holding.daily_change_percent),
                    total_cost: totalCost,
                    total_cost_native: totalCostNative,
                    total_cost_cad: totalCostCad,
                    _total_cost_native: totalCostNative,
                    _total_cost_cad: totalCostCad,
                    _previous_value: previousValue,
                    _weight_current_price: currentPrice * shares,
                    account_details: [],
                    period_transactions: periodTx.slice()
                };
                merged.set(key, entry);
            } else {
                entry.shares += shares;
                entry.current_shares = entry.shares;
                entry.current_value += currentValue;
                entry.current_value_cad += currentValueCad;
                entry.daily_change_value += dailyChangeValue;
                entry.realized_gain += realizedGain;
                entry.unrealized_gain += unrealizedGain;
                entry.dividends += dividends;
                entry.interest += interest;
                entry.total_bought_value = toNumber(entry.total_bought_value) + totalBoughtValue;
                entry.total_sold_value = toNumber(entry.total_sold_value) + totalSoldValue;
                entry.total_bought_shares = toNumber(entry.total_bought_shares) + totalBoughtShares;
                entry.total_sold_shares = toNumber(entry.total_sold_shares) + totalSoldShares;
                entry._total_cost_native += totalCostNative;
                entry._total_cost_cad += totalCostCad;
                entry._previous_value += previousValue;
                entry._weight_current_price += currentPrice * shares;
                entry.total_cost = toNumber(entry.total_cost) + totalCost;
                entry.total_cost_native += totalCostNative;
                entry.total_cost_cad += totalCostCad;
                if (periodTx.length) {
                    entry.period_transactions = (entry.period_transactions || []).concat(periodTx);
                }
            }

            entry.account_details.push({
                account_name: account.account_name,
                shares,
                cost: totalCostNative,
                realized_gain: realizedGain,
                unrealized_gain: unrealizedGain
            });
        });
    });

    const mergedList = Array.from(merged.values()).map(entry => {
        const result = { ...entry };
        const shares = result.shares || 0;

        if (shares > 0) {
            result.current_price = result._weight_current_price / shares;
            result.average_cost = result._total_cost_native / shares;
            result.average_cost_cad = result._total_cost_cad / shares;
        } else {
            result.current_price = 0;
            result.average_cost = 0;
            result.average_cost_cad = 0;
        }

        const costBase = result.currency === 'USD' ? result._total_cost_native : result._total_cost_cad;
        result.unrealized_gain_percent = costBase ? (result.unrealized_gain / costBase) * 100 : 0;

        const previousValue = Number(result._previous_value);
        if (Number.isFinite(previousValue) && previousValue !== 0) {
            result.daily_change_percent = (result.daily_change_value / previousValue) * 100;
        } else {
            const baseValue = result.current_value - result.daily_change_value;
            result.daily_change_percent = baseValue ? (result.daily_change_value / baseValue) * 100 : 0;
        }

        const totalBoughtValue = toNumber(result.total_bought_value);
        const totalGain = toNumber(result.unrealized_gain) + toNumber(result.realized_gain) +
            toNumber(result.dividends) + toNumber(result.interest);
        result.total_return_percent = totalBoughtValue ? (totalGain / totalBoughtValue) * 100 : 0;

        // 清理临时字段
        delete result._total_cost_native;
        delete result._total_cost_cad;
        delete result._previous_value;
        delete result._weight_current_price;

        return result;
    });

    // 合并后的交易按日期排序
    mergedList.forEach(item => {
        if (item.period_transactions) {
            item.period_transactions.sort((a, b) => (a.date || '').localeCompare(b.date || ''));
        }
    });

    // 按市值降序排序，方便查看
    mergedList.sort((a, b) => (b.current_value || 0) - (a.current_value || 0));
    return mergedList;
}

function loadHiddenSymbolsFromStorage() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY_HIDDEN);
        if (!stored) {
            return new Set();
        }
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) {
            return new Set(parsed.map(symbol => String(symbol)));
        }
    } catch (error) {
        console.warn('Failed to load hidden stocks:', error);
    }
    return new Set();
}

function saveHiddenSymbolsToStorage() {
    try {
        localStorage.setItem(STORAGE_KEY_HIDDEN, JSON.stringify(Array.from(hiddenSymbols)));
    } catch (error) {
        console.warn('Failed to persist hidden stocks:', error);
    }
}

function clearHiddenSymbols() {
    hiddenSymbols.clear();
    saveHiddenSymbolsToStorage();
}

function showAllHiddenHoldingsMessage() {
    document.getElementById('holdingsContent').innerHTML = `
        <div class="alert alert-info m-3">
            <i class="fas fa-eye-slash me-2"></i>{{ _('All selected holdings are hidden. Reset default order to display them again.') }}
        </div>
    `;
}

function bindPeriodButtons() {
    const periodButtons = document.querySelectorAll('.period-btn');
    periodButtons.forEach(btn => {
        if (btn.dataset.bound === '1') return;
        btn.dataset.bound = '1';
        btn.addEventListener('click', () => {
            periodButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadHoldings();
        });
    });
}

function initHoldingsBoardSorting() {
    const tables = document.querySelectorAll('.hb-sortable');
    if (!tables.length) return;

    tables.forEach(table => {
        const sortableElements = table.querySelectorAll('th.sortable, .sort-region.sortable');
        let currentSort = { column: null, direction: 'asc' };

        sortableElements.forEach(el => {
            el.style.cursor = 'pointer';
            el.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const sortType = el.dataset.sort;
                const sortDirection = (currentSort.column === sortType && currentSort.direction === 'asc') ? 'desc' : 'asc';
                sortTable(table, sortType, sortDirection);
                updateSortIcons(sortableElements, el, sortDirection);
                currentSort = { column: sortType, direction: sortDirection };
            });
        });
    });

    function sortTable(table, sortType, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal;
            let bVal;

            if (['symbol', 'company', 'currency', 'sector'].includes(sortType)) {
                aVal = (a.dataset[sortType] || '').toLowerCase();
                bVal = (b.dataset[sortType] || '').toLowerCase();
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            }

            const attrMap = {
                'avg_cost': 'avgCost',
                'current_price': 'currentPrice',
                'daily_change': 'dailyChange',
                'market_value': 'marketValue',
                'unrealized_gain': 'unrealizedGain',
                'realized_gain': 'realizedGain',
                'return_percent': 'returnPercent',
                'bought_shares': 'boughtShares',
                'sold_shares': 'soldShares',
                'total_invested': 'totalInvested',
                'total_received': 'totalReceived'
            };

            const dataAttr = attrMap[sortType] || sortType.replace(/_([a-z])/g, (_, p1) => p1.toUpperCase());
            aVal = parseFloat(a.dataset[dataAttr]) || 0;
            bVal = parseFloat(b.dataset[dataAttr]) || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    function updateSortIcons(headers, clickedHeader, direction) {
        headers.forEach(header => {
            const icon = header.querySelector('.sort-icon');
            if (icon) {
                icon.className = 'fas fa-sort ms-1 sort-icon';
            }
        });
        const icon = clickedHeader.querySelector('.sort-icon');
        if (icon) {
            icon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} ms-1 sort-icon`;
        }
    }
}

function escapeForSelector(value) {
    if (window.CSS && CSS.escape) {
        return CSS.escape(value);
    }
    return String(value).replace(/([!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g, '\\$1');
}

function updateCardAfterRowRemoval(card) {
    if (!card) {
        return;
    }

    const remainingRows = card.querySelectorAll('tbody tr').length;

    if (remainingRows === 0) {
        card.remove();
        return;
    }

    const badge = card.querySelector('.card-header .badge[data-label-stocks]');
    if (badge) {
        const stocksLabel = badge.dataset.labelStocks || badge.textContent.replace(/^[0-9]+\s*/, '');
        badge.textContent = `${remainingRows} ${stocksLabel}`.trim();
    }
}

function hideStock(symbol) {
    const normalizedSymbol = symbol ? symbol.trim() : '';
    if (!normalizedSymbol) {
        return;
    }

    hiddenSymbols.add(normalizedSymbol);
    saveHiddenSymbolsToStorage();

    const escapedSymbol = escapeForSelector(normalizedSymbol);
    const matchingRows = document.querySelectorAll(`.holdings-row[data-symbol="${escapedSymbol}"]`);
    const affectedCards = new Set();

    matchingRows.forEach(rowEl => {
        const card = rowEl.closest('.card');
        rowEl.remove();
        if (card) {
            affectedCards.add(card);
        }
    });

    affectedCards.forEach(updateCardAfterRowRemoval);

    if (!document.querySelector('.holdings-row')) {
        showAllHiddenHoldingsMessage();
    }
}

// localStorage 功能
function saveSelectedAccounts() {
    try {
        const checkedBoxes = Array.from(document.querySelectorAll('.account-checkbox:checked'));
        const selectedIds = checkedBoxes.map(cb => cb.value);
        localStorage.setItem(STORAGE_KEY_ACCOUNTS, JSON.stringify(selectedIds));
    } catch (e) {
        console.warn('Failed to save selected accounts:', e);
    }
}

function saveSeparateByAccount() {
    try {
        const separateByAccount = document.getElementById('separateByAccount').checked;
        localStorage.setItem(STORAGE_KEY_SEPARATE, JSON.stringify(separateByAccount));
    } catch (e) {
        console.warn('Failed to save separate by account setting:', e);
    }
}

function restoreSavedSelections() {
    try {
        // 恢复账户选择
        const savedAccounts = localStorage.getItem(STORAGE_KEY_ACCOUNTS);
        if (savedAccounts) {
            const selectedIds = JSON.parse(savedAccounts);
            const accountCheckboxes = document.querySelectorAll('.account-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');

            // 首先取消所有选择
            accountCheckboxes.forEach(cb => cb.checked = false);
            selectAllCheckbox.checked = false;

            // 根据保存的选择恢复
            selectedIds.forEach(id => {
                const checkbox = document.getElementById('account' + id);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });

            // 更新全选状态和显示文本
            updateSelectAllState();
            updateSelectedAccountsText();
        }

        // 恢复分账户显示选择
        const savedSeparate = localStorage.getItem(STORAGE_KEY_SEPARATE);
        if (savedSeparate) {
            const separateByAccount = JSON.parse(savedSeparate);
            document.getElementById('separateByAccount').checked = separateByAccount;
        }
    } catch (e) {
        console.warn('Failed to restore saved selections:', e);
    }
}

// 拖拽相关变量
let draggedElement = null;

// 设置拖拽事件
function setupDragAndDropEvents() {
    const currencySymbols = document.querySelectorAll('.currency-symbol');
    const holdingsRows = document.querySelectorAll('.holdings-row');

    // 为货币符号添加拖拽事件
    currencySymbols.forEach(symbol => {
        symbol.addEventListener('dragstart', handleDragStart);
        symbol.addEventListener('dragend', handleDragEnd);
    });

    // 为表格行添加拖拽接收事件
    holdingsRows.forEach(row => {
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragenter', handleDragEnter);
        row.addEventListener('dragleave', handleDragLeave);
    });
}

// 拖拽开始
function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');

    // 为整行添加拖拽样式
    const row = this.closest('tr');
    if (row) {
        row.classList.add('dragging');
    }

    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
}

// 拖拽结束
function handleDragEnd(e) {
    this.classList.remove('dragging');

    // 清除整行的拖拽样式
    const row = this.closest('tr');
    if (row) {
        row.classList.remove('dragging');
    }

    // 清除所有拖拽样式
    document.querySelectorAll('.holdings-row').forEach(row => {
        row.classList.remove('drag-over');
    });

    draggedElement = null;
}

// 拖拽悬停
function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

// 拖拽进入
function handleDragEnter(e) {
    e.preventDefault();
    if (draggedElement && this !== draggedElement.closest('tr')) {
        this.classList.add('drag-over');
    }
}

// 拖拽离开
function handleDragLeave(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
}

// 放置
function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();

    this.classList.remove('drag-over');

    if (draggedElement && this !== draggedElement.closest('tr')) {
        // 获取被拖拽的行和目标行
        const draggedRow = draggedElement.closest('tr');
        const targetRow = this;

        // 重新排列表格行
        const tbody = targetRow.parentNode;
        const draggedRowNextSibling = draggedRow.nextSibling;

        // 移动行
        tbody.insertBefore(draggedRow, targetRow.nextSibling);

        console.log('Moved', draggedElement.dataset.symbol, 'near', this.dataset.symbol);
    }

    return false;
}

// 移动行到顶部
function moveRowToTop(row) {
    const tbody = row.parentNode;
    const firstRow = tbody.firstElementChild;
    if (row !== firstRow) {
        tbody.insertBefore(row, firstRow);
        console.log('Moved', row.dataset.symbol, 'to top');
    }
}

// 移动行到底部
function moveRowToBottom(row) {
    const tbody = row.parentNode;
    tbody.appendChild(row);
    console.log('Moved', row.dataset.symbol, 'to bottom');
}

// 向上移动一行
function moveRowUp(row) {
    const prevRow = row.previousElementSibling;
    if (prevRow) {
        row.parentNode.insertBefore(row, prevRow);
        console.log('Moved', row.dataset.symbol, 'up');
    }
}

// 向下移动一行
function moveRowDown(row) {
    const nextRow = row.nextElementSibling;
    if (nextRow) {
        row.parentNode.insertBefore(nextRow, row);
        console.log('Moved', row.dataset.symbol, 'down');
    }
}

// 重置默认顺序
function resetDefaultOrder() {
    clearHiddenSymbols();
    loadHoldings();
    console.log('Reset to default order and cleared hidden stocks');
}
</script>
{% endblock %}
