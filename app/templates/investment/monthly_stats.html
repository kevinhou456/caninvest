{% extends "base/investment_base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="fas fa-calendar-alt me-2"></i>{{ _('Monthly Analysis') }}
        </h2>
        <!-- <p class="text-muted">{{ _('Comprehensive monthly investment performance analysis') }}</p> -->
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary">
                <h6 class="m-0 font-weight-bold text-white">{{ _('Monthly Assets & Returns') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="height: 350px;">
                    <canvas id="monthlyPerformanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monthly Data Analysis Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-info">
        <h6 class="m-0 font-weight-bold text-white">{{ _('Monthly Data Analysis') }}</h6>
        <div class="form-check form-switch text-white mb-0">
            <input class="form-check-input" type="checkbox" id="toggleCurrencyBreakdown">
            <label class="form-check-label" for="toggleCurrencyBreakdown">{{ _('显示货币明细') }}</label>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="monthlyAnalysisTable" width="100%" cellspacing="0">
                <thead>
                    <tr class="bg-primary text-white">
                        <th>{{ _('Month') }}</th>
                        <th>{{ _('Total Assets') }}</th>
                        <th>{{ _('Realized Gain/Loss') }}</th>
                        <th>{{ _('Unrealized Gain/Loss') }}</th>
                        <th>{{ _('Return Percent') }}</th>
                        <th>{{ _('Total Dividends') }}</th>
                        <th>{{ _('Total Interest') }}</th>
                        <th>{{ _('Transactions') }}</th>
                        <th>{{ _('Buy Amount') }}</th>
                        <th>{{ _('Sell Amount') }}</th>
                    </tr>
                </thead>
                <tbody id="monthly-data-tbody">
                    <!-- Data populated by JavaScript -->
                </tbody>
                <tfoot>
                    <tr class="bg-light font-weight-bold">
                        <td>{{ _('Total') }}</td>
                        <td id="total-assets-footer">-</td>
                        <td id="total-realized-footer">-</td>
                        <td id="total-unrealized-footer">-</td>
                        <td id="total-return-percent-footer">--</td>
                        <td id="total-dividends-footer">-</td>
                        <td id="total-interest-footer">-</td>
                        <td id="total-transactions-footer">-</td>
                        <td id="total-buy-footer">-</td>
                        <td id="total-sell-footer">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>


<!-- Monthly Stock P&L Modal -->
<div class="modal fade monthly-stock-pnl-tooltip" id="monthlyStockPnlModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="monthlyStockPnlModalTitle">{{ _('Monthly Stock P&L') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 520px;">
                    <table class="table table-bordered table-sm" id="monthlyStockPnlTable">
                        <thead class="table-light">
                            <tr>
                                <th>{{ _('Symbol') }}</th>
                                <th class="text-end">{{ _('Monthly P&L') }}</th>
                                <th class="text-end">{{ _('Realized Gain') }}</th>
                                <th class="text-end">{{ _('Buy Qty') }}</th>
                                <th class="text-end">{{ _('Sell Qty') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="loading-spinner" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">{{ _('Loading...') }}</span>
    </div>
    <p class="mt-2 text-muted">{{ _('Loading monthly analysis data...') }}</p>
</div>

<style>
.monthly-stock-pnl-tooltip .modal-dialog {
    position: fixed;
    right: 1.25rem;
    bottom: 1.25rem;
    margin: 0;
    max-width: 520px;
    width: calc(100% - 2.5rem);
}
.monthly-stock-pnl-tooltip .modal-content {
    border-radius: 12px;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
    border: 1px solid rgba(0, 0, 0, 0.08);
}
.monthly-stock-pnl-tooltip .modal-header {
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}
.monthly-stock-pnl-tooltip .modal-body {
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.96);
}
.monthly-performance-tooltip {
    position: absolute;
    transform: translate(-50%, -100%);
    background: rgba(33, 37, 41, 0.95);
    color: #fff;
    padding: 0.6rem 0.75rem;
    border-radius: 10px;
    pointer-events: none;
    font-size: 0.85rem;
    z-index: 1080;
    max-width: 420px;
}
.monthly-performance-tooltip .tooltip-title {
    font-weight: 600;
    margin-bottom: 0.35rem;
}
.monthly-performance-tooltip .tooltip-body {
    display: grid;
    gap: 0.2rem;
}
.monthly-performance-tooltip .tooltip-line {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    line-height: 1.2;
    white-space: nowrap;
}
.monthly-performance-tooltip .tooltip-line.text-danger {
    color: #ff7b7b;
}
.monthly-performance-tooltip .tooltip-line.text-success {
    color: #7cf2a4;
}
.monthly-performance-tooltip .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex: 0 0 8px;
}
.monthly-performance-tooltip .tooltip-footer {
    margin-top: 0.35rem;
    font-weight: 600;
}
.monthly-performance-tooltip .tooltip-separator {
    margin: 0.45rem 0;
    border-top: 1px dashed rgba(255, 255, 255, 0.25);
}
@media (max-width: 768px) {
    .monthly-stock-pnl-tooltip .modal-dialog {
        right: 0.75rem;
        bottom: 0.75rem;
        max-width: 100%;
        width: calc(100% - 1.5rem);
    }
}
</style>

{% endblock %}

{% block scripts %}
<script>
let monthlyData = [];
let monthlyPerformanceChart = null;
let monthlyStockPnlModalInstance = null;
let showCurrencyBreakdown = false;
const monthlyStockPnlCache = new Map();
const monthlyStockPnlFetches = new Map();

function showLoadingOverlay(message) {
    const msg = message || '正在加载数据...';
    if (window.GlobalLoading && typeof GlobalLoading.manualShow === 'function') {
        GlobalLoading.manualShow(msg);
    } else if (window.GlobalLoading && typeof GlobalLoading.show === 'function') {
        GlobalLoading.show(msg);
    }
}

function hideLoadingOverlay() {
    if (window.GlobalLoading && typeof GlobalLoading.manualHide === 'function') {
        GlobalLoading.manualHide(300);
    } else if (window.GlobalLoading && typeof GlobalLoading.hide === 'function') {
        GlobalLoading.hide(300);
    }
}

function loadMonthlyAnalysis() {
    const familyId = {{ current_family.id if current_family else 1 }};
    const memberId = {{ current_member_id if current_member_id else 'null' }};
    const accountId = {{ current_account_id if current_account_id else 'null' }};
    const accountType = {{ current_account_type|tojson if current_account_type else 'null' }};

    let apiUrl = `/api/v1/families/${familyId}/reports/monthly-analysis`;
    const params = new URLSearchParams();

    if (memberId) {
        params.append('member_id', memberId);
    }
    if (accountId) {
        params.append('account_id', accountId);
    }
    if (accountType) {
        params.append('account_type', accountType);
    }

    if (params.toString()) {
        apiUrl += '?' + params.toString();
    }

    showLoadingOverlay('正在加载数据...');
    monthlyStockPnlCache.clear();
    monthlyStockPnlFetches.clear();

    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.analysis) {
                monthlyData = data.analysis.monthly_data || [];
                const currentTotals = data.analysis.current_totals || null;
                updateMonthlyPerformanceChart();
                updateMonthlyTable(currentTotals);
                document.getElementById('loading-spinner').style.display = 'none';
            } else {
                showError('No analysis data returned from API');
            }
        })
        .catch(error => {
            console.error('Error loading monthly analysis:', error);
            showError('Failed to load monthly analysis data: ' + error.message);
        })
        .finally(() => {
            hideLoadingOverlay();
        });
}

function updateMonthlyPerformanceChart() {
    const canvas = document.getElementById('monthlyPerformanceChart');
    if (!canvas) {
        return;
    }

    const ctx = canvas.getContext('2d');

    if (monthlyPerformanceChart) {
        monthlyPerformanceChart.destroy();
    }

    const chartData = [...monthlyData].sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
    });

    const labels = chartData.map(item => `${item.year}-${String(item.month).padStart(2, '0')}`);
    const assets = chartData.map(item => item.total_assets || 0);
    const realizedGains = chartData.map(item => item.monthly_realized_gain || 0);
    const unrealizedGains = chartData.map(item => item.monthly_unrealized_gain || 0);
    const dividendsAndInterest = chartData.map(item => (item.monthly_dividends || 0) + (item.monthly_interest || 0));

    monthlyPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '{{ _("Realized Gains") }}',
                    data: realizedGains,
                    backgroundColor: 'rgba(28, 200, 138, 0.8)',
                    borderColor: 'rgba(28, 200, 138, 1)',
                    borderWidth: 1,
                    yAxisID: 'yReturns',
                    order: 2
                },
                {
                    label: '{{ _("Unrealized Gains") }}',
                    data: unrealizedGains,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'yReturns',
                    order: 2
                },
                {
                    label: '{{ _("Dividends & Interest") }}',
                    data: dividendsAndInterest,
                    backgroundColor: 'rgba(255, 206, 86, 0.8)',
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1,
                    yAxisID: 'yReturns',
                    order: 2
                },
                {
                    type: 'line',
                    label: '{{ _("Total Assets") }}',
                    data: assets,
                    yAxisID: 'yAssets',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    backgroundColor: 'rgba(78, 115, 223, 0.2)',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    tension: 0.3,
                    fill: false,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            onClick: function(evt, elements) {
                if (!elements || !elements.length) return;
                const index = elements[0].index;
                const item = chartData[index];
                if (item) {
                    openMonthlyStockPnlModal(item.year, item.month);
                }
            },
            
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '{{ _("Month") }}'
                    }
                },
                yReturns: {
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '{{ _("Returns ($)") }}'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                yAssets: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '{{ _("Total Assets ($)") }}'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        const tooltip = context.tooltip;
                        let tooltipEl = document.getElementById('monthly-performance-tooltip');

                        if (!tooltipEl) {
                            tooltipEl = document.createElement('div');
                            tooltipEl.id = 'monthly-performance-tooltip';
                            tooltipEl.className = 'monthly-performance-tooltip';
                            tooltipEl.innerHTML = '<div class="tooltip-inner"></div>';
                            document.body.appendChild(tooltipEl);
                        }

                        if (tooltip.opacity === 0) {
                            tooltipEl.style.opacity = 0;
                            return;
                        }

                        const dataPoints = tooltip.dataPoints || [];
                        const index = dataPoints[0] ? dataPoints[0].dataIndex : null;
                        const item = (index !== null && chartData[index]) ? chartData[index] : null;

                        if (!item) {
                            tooltipEl.style.opacity = 0;
                            return;
                        }

                        const key = `${item.year}-${String(item.month).padStart(2, '0')}`;
                        const cached = monthlyStockPnlCache.get(key);
                        if (!cached) {
                            fetchMonthlyStockPnlSummary(item.year, item.month, key);
                        }

                        let html = '';
                        if (tooltip.title && tooltip.title.length) {
                            html += `<div class="tooltip-title">${tooltip.title[0]}</div>`;
                        }

                        if (dataPoints.length) {
                            html += '<div class="tooltip-body">';
                            dataPoints.forEach(dp => {
                                const label = dp.dataset.label || '';
                                let valueText = '$' + (dp.parsed.y || 0).toLocaleString();
                                if (label === '{{ _("Dividends & Interest") }}') {
                                    const dividends = item.monthly_dividends || 0;
                                    const interest = item.monthly_interest || 0;
                                    valueText = '$' + (dp.parsed.y || 0).toLocaleString() +
                                        ` ({{ _("Dividends") }}: $${dividends.toLocaleString()}, {{ _("Interest") }}: $${interest.toLocaleString()})`;
                                }
                                const color = dp.dataset.borderColor || dp.dataset.backgroundColor || '#6c757d';
                                html += `<div class="tooltip-line"><span class="dot" style="background:${color}"></span>${label}: ${valueText}</div>`;
                            });
                            html += '</div>';
                        }

                        let total = 0;
                        dataPoints.forEach(dp => {
                            if (dp.dataset.yAxisID === 'yReturns') {
                                total += dp.parsed.y || 0;
                            }
                        });
                        if (total !== 0) {
                            html += `<div class="tooltip-footer">{{ _("Total") }}: $${total.toLocaleString()}</div>`;
                        }

                        const summaryLines = cached || ['{{ _("Loading per-stock P&L...") }}'];
                        html += '<div class="tooltip-separator"></div>';
                        html += '<div class="tooltip-body">';
                        summaryLines.forEach(line => {
                            const isLoading = line.indexOf('{{ _("Loading per-stock P&L...") }}') === 0;
                            if (isLoading) {
                                html += `<div class="tooltip-line text-muted">${line}</div>`;
                                return;
                            }
                            const match = line.match(/:\s*([+-]?\$?[\d,.]+)\s*\|/);
                            let cls = '';
                            if (match && match[1]) {
                                cls = (match[1].startsWith('-')) ? 'text-danger' : 'text-success';
                            }
                            html += `<div class="tooltip-line ${cls}">${line}</div>`;
                        });
                        html += '</div>';

                        const inner = tooltipEl.querySelector('.tooltip-inner');
                        inner.innerHTML = html;

                        const position = context.chart.canvas.getBoundingClientRect();
                        tooltipEl.style.opacity = 1;
                        tooltipEl.style.left = position.left + window.pageXOffset + tooltip.caretX + 'px';
                        tooltipEl.style.top = position.top + window.pageYOffset + tooltip.caretY + 'px';
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

function updateMonthlyTable(currentTotals) {
    const tbody = document.getElementById('monthly-data-tbody');
    tbody.innerHTML = '';

    let totalAssets = 0, totalRealized = 0, totalUnrealized = 0;
    let totalDividends = 0, totalInterest = 0, totalTransactions = 0;
    let totalBuy = 0, totalSell = 0;
    let totalAssetsCad = 0, totalAssetsUsd = 0;
    let totalRealizedCad = 0, totalRealizedUsd = 0;
    let totalUnrealizedCad = 0, totalUnrealizedUsd = 0;
    let totalDividendsCad = 0, totalDividendsUsd = 0;
    let totalInterestCad = 0, totalInterestUsd = 0;
    let totalBuyCad = 0, totalBuyUsd = 0;
    let totalSellCad = 0, totalSellUsd = 0;
    let compoundReturnFactor = 1;
    let hasReturnBase = false;

    const tableData = [...monthlyData].sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return b.month - a.month;
    });

    tableData.forEach(item => {
        const row = document.createElement('tr');

        const realizedClass = item.monthly_realized_gain >= 0 ? 'text-success' : 'text-danger';
        const unrealizedClass = item.monthly_unrealized_gain >= 0 ? 'text-success' : 'text-danger';
        const returnPercent = item.monthly_return_percent || 0;
        const returnClass = returnPercent >= 0 ? 'text-success' : 'text-danger';
        const currencyBreakdown = item.currency_breakdown || {};

        row.innerHTML = `
            <td class="font-weight-bold">${item.year}-${String(item.month).padStart(2, '0')}</td>
            <td>
                $${formatNumber(item.total_assets, 2)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.total_assets_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.total_assets_usd || 0, 2)}</small>
            </td>
            <td class="${realizedClass}">
                $${formatNumber(item.monthly_realized_gain, 2, true)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.realized_gain_cad || 0, 2, true)} | USD: $${formatNumber(currencyBreakdown.realized_gain_usd || 0, 2, true)}</small>
            </td>
            <td class="${unrealizedClass}">
                $${formatNumber(item.monthly_unrealized_gain, 2, true)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.unrealized_gain_cad || 0, 2, true)} | USD: $${formatNumber(currencyBreakdown.unrealized_gain_usd || 0, 2, true)}</small>
            </td>
            <td class="${returnClass}">
                ${formatNumber(returnPercent, 2, true)}%
            </td>
            <td class="text-info">
                $${formatNumber(item.monthly_dividends, 2)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.dividends_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.dividends_usd || 0, 2)}</small>
            </td>
            <td class="text-info">
                $${formatNumber(item.monthly_interest, 2)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.interest_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.interest_usd || 0, 2)}</small>
            </td>
            <td class="text-center">${item.transaction_count}</td>
            <td class="text-success">
                $${formatNumber(item.buy_amount, 2)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.buy_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.buy_usd || 0, 2)}</small>
            </td>
            <td class="text-danger">
                $${formatNumber(item.sell_amount, 2)}
                <br><small class="text-muted currency-breakdown">CAD: $${formatNumber(currencyBreakdown.sell_cad || 0, 2)} | USD: $${formatNumber(currencyBreakdown.sell_usd || 0, 2)}</small>
            </td>
        `;

        tbody.appendChild(row);

        if (item === tableData[0]) {
            totalAssets = item.total_assets;
        }
        totalRealized += item.monthly_realized_gain;
        totalUnrealized += item.monthly_unrealized_gain;
        totalDividends += item.monthly_dividends;
        totalInterest += item.monthly_interest;
        totalTransactions += item.transaction_count;
        totalBuy += item.buy_amount;
        totalSell += item.sell_amount;
        totalAssetsCad += Number(currencyBreakdown.total_assets_cad || 0);
        totalAssetsUsd += Number(currencyBreakdown.total_assets_usd || 0);
        totalRealizedCad += Number(currencyBreakdown.realized_gain_cad || 0);
        totalRealizedUsd += Number(currencyBreakdown.realized_gain_usd || 0);
        totalUnrealizedCad += Number(currencyBreakdown.unrealized_gain_cad || 0);
        totalUnrealizedUsd += Number(currencyBreakdown.unrealized_gain_usd || 0);
        totalDividendsCad += Number(currencyBreakdown.dividends_cad || 0);
        totalDividendsUsd += Number(currencyBreakdown.dividends_usd || 0);
        totalInterestCad += Number(currencyBreakdown.interest_cad || 0);
        totalInterestUsd += Number(currencyBreakdown.interest_usd || 0);
        totalBuyCad += Number(currencyBreakdown.buy_cad || 0);
        totalBuyUsd += Number(currencyBreakdown.buy_usd || 0);
        totalSellCad += Number(currencyBreakdown.sell_cad || 0);
        totalSellUsd += Number(currencyBreakdown.sell_usd || 0);
        if (item.total_assets) {
            const periodReturn = (item.monthly_realized_gain + item.monthly_unrealized_gain) / item.total_assets;
            compoundReturnFactor *= (1 + periodReturn);
            hasReturnBase = true;
        }
    });

    const totalAssetsValue = currentTotals ? currentTotals.total_assets : totalAssets;
    const totalAssetsCadValue = currentTotals ? currentTotals.total_assets_cad : totalAssetsCad;
    const totalAssetsUsdValue = currentTotals ? currentTotals.total_assets_usd : totalAssetsUsd;
    const totalRealizedValue = currentTotals ? currentTotals.realized_gain : totalRealized;
    const totalRealizedCadValue = currentTotals ? currentTotals.realized_gain_cad : totalRealizedCad;
    const totalRealizedUsdValue = currentTotals ? currentTotals.realized_gain_usd : totalRealizedUsd;
    const totalUnrealizedValue = currentTotals ? currentTotals.unrealized_gain : totalUnrealized;
    const totalUnrealizedCadValue = currentTotals ? currentTotals.unrealized_gain_cad : totalUnrealizedCad;
    const totalUnrealizedUsdValue = currentTotals ? currentTotals.unrealized_gain_usd : totalUnrealizedUsd;
    const footerReturnPercent = currentTotals ? currentTotals.return_percent : (hasReturnBase ? (compoundReturnFactor - 1) * 100 : null);

    // Recalculate totals using current exchange rate
    const currentRate = {{ exchange_rates['usd_to_cad'] if exchange_rates else 1.3782 }};
    const totalAssetsCorrect = totalAssetsCadValue + totalAssetsUsdValue * currentRate;
    const totalRealizedCorrect = totalRealizedCadValue + totalRealizedUsdValue * currentRate;
    const totalUnrealizedCorrect = totalUnrealizedCadValue + totalUnrealizedUsdValue * currentRate;
    const totalDividendsCorrect = totalDividendsCad + totalDividendsUsd * currentRate;
    const totalInterestCorrect = totalInterestCad + totalInterestUsd * currentRate;
    const totalBuyCorrect = totalBuyCad + totalBuyUsd * currentRate;
    const totalSellCorrect = totalSellCad + totalSellUsd * currentRate;

    document.getElementById('total-assets-footer').innerHTML = '$' + formatNumber(totalAssetsCorrect, 2) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalAssetsCadValue, 2)} | USD: $${formatNumber(totalAssetsUsdValue, 2)}</small>`;
    document.getElementById('total-realized-footer').innerHTML = '$' + formatNumber(totalRealizedCorrect, 2, true) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalRealizedCadValue, 2, true)} | USD: $${formatNumber(totalRealizedUsdValue, 2, true)}</small>`;
    document.getElementById('total-unrealized-footer').innerHTML = '$' + formatNumber(totalUnrealizedCorrect, 2, true) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalUnrealizedCadValue, 2, true)} | USD: $${formatNumber(totalUnrealizedUsdValue, 2, true)}</small>`;
    if (footerReturnPercent !== null && footerReturnPercent !== undefined) {
        document.getElementById('total-return-percent-footer').textContent = formatNumber(footerReturnPercent, 2, true) + '%';
    } else if (hasReturnBase) {
        const cumulativeReturn = (compoundReturnFactor - 1) * 100;
        document.getElementById('total-return-percent-footer').textContent = formatNumber(cumulativeReturn, 2, true) + '%';
    } else {
        document.getElementById('total-return-percent-footer').textContent = '--';
    }
    document.getElementById('total-dividends-footer').innerHTML = '$' + formatNumber(totalDividendsCorrect, 2) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalDividendsCad, 2)} | USD: $${formatNumber(totalDividendsUsd, 2)}</small>`;
    document.getElementById('total-interest-footer').innerHTML = '$' + formatNumber(totalInterestCorrect, 2) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalInterestCad, 2)} | USD: $${formatNumber(totalInterestUsd, 2)}</small>`;
    document.getElementById('total-transactions-footer').textContent = totalTransactions;
    document.getElementById('total-buy-footer').innerHTML = '$' + formatNumber(totalBuyCorrect, 2) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalBuyCad, 2)} | USD: $${formatNumber(totalBuyUsd, 2)}</small>`;
    document.getElementById('total-sell-footer').innerHTML = '$' + formatNumber(totalSellCorrect, 2) +
        `<br><small class="text-muted currency-breakdown">CAD: $${formatNumber(totalSellCad, 2)} | USD: $${formatNumber(totalSellUsd, 2)}</small>`;

    updateCurrencyBreakdownVisibility();
}

function buildMonthlyStockPnlUrl(year, month) {
    const familyId = {{ current_family.id if current_family else 1 }};
    const memberId = {{ current_member_id if current_member_id else 'null' }};
    const accountId = {{ current_account_id if current_account_id else 'null' }};
    const accountType = {{ current_account_type|tojson if current_account_type else 'null' }};

    let apiUrl = `/api/v1/families/${familyId}/reports/monthly-stock-pnl?year=${year}&month=${month}`;
    const params = new URLSearchParams();
    if (memberId) {
        params.append('member_id', memberId);
    }
    if (accountId) {
        params.append('account_id', accountId);
    }
    if (accountType) {
        params.append('account_type', accountType);
    }
    if (params.toString()) {
        apiUrl += '&' + params.toString();
    }
    return apiUrl;
}

function formatSignedCurrency(value) {
    const num = Number(value || 0);
    const abs = Math.abs(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return (num < 0 ? '-' : '') + '$' + abs;
}

function fetchMonthlyStockPnlSummary(year, month, key) {
    if (monthlyStockPnlCache.has(key) || monthlyStockPnlFetches.has(key)) return;
    const request = fetch(buildMonthlyStockPnlUrl(year, month))
        .then(response => response.json())
        .then(data => {
            if (!data.success) return;
            const symbols = (data.data && data.data.symbols) ? data.data.symbols : [];
            const lines = [];
            const maxRows = 5;
            symbols.slice(0, maxRows).forEach(item => {
                const pnl = formatSignedCurrency(item.value);
                const realized = formatSignedCurrency(item.realized_gain);
                const buyQty = (item.buy_qty || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                const sellQty = (item.sell_qty || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                lines.push(`${item.label}: ${pnl} | R: ${realized} | B: ${buyQty} S: ${sellQty}`);
            });
            if (symbols.length > maxRows) {
                lines.push('{{ _("More... click bar for full list") }}');
            } else if (symbols.length) {
                lines.push('{{ _("Click bar for full list") }}');
            }
            monthlyStockPnlCache.set(key, lines);
            if (monthlyPerformanceChart) {
                monthlyPerformanceChart.update('none');
            }
        })
        .finally(() => {
            monthlyStockPnlFetches.delete(key);
        });
    monthlyStockPnlFetches.set(key, request);
}


function getMonthlyStockPnlModal() {
    if (monthlyStockPnlModalInstance) {
        return monthlyStockPnlModalInstance;
    }
    const modalEl = document.getElementById('monthlyStockPnlModal');
    if (!modalEl) return null;
    monthlyStockPnlModalInstance = new bootstrap.Modal(modalEl, {
        backdrop: true,
        keyboard: true
    });
    return monthlyStockPnlModalInstance;
}

function openMonthlyStockPnlModal(year, month) {
    const modal = getMonthlyStockPnlModal();
    if (!modal) return;
    const titleEl = document.getElementById('monthlyStockPnlModalTitle');
    if (titleEl) {
        titleEl.textContent = `{{ _('Monthly Stock P&L') }}: ${year}-${String(month).padStart(2, '0')}`;
    }
    modal.show();
    loadMonthlyStockPnl(year, month);
}

function loadMonthlyStockPnl(year, month) {
    fetch(buildMonthlyStockPnlUrl(year, month))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderMonthlyStockPnlTable(data.data);
            } else {
                console.error('Failed to load monthly stock P&L:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading monthly stock P&L:', error);
        });
}

function renderMonthlyStockPnlTable(payload) {
    const table = document.getElementById('monthlyStockPnlTable');
    if (!table || !payload) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    tbody.innerHTML = '';
    const symbols = payload.symbols || [];
    if (!symbols.length) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="5" class="text-center text-muted">{{ _('No data') }}</td>`;
        tbody.appendChild(row);
        return;
    }

    symbols.forEach(item => {
        const value = Number(item.value || 0);
        const row = document.createElement('tr');
        const valueClass = value >= 0 ? 'text-success' : 'text-danger';
        row.innerHTML = `
            <td>${item.label}</td>
            <td class="text-end ${valueClass}">${value < 0 ? '-' : ''}$${Math.abs(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="text-end ${valueClass}">${(item.realized_gain || 0) < 0 ? '-' : ''}$${Math.abs(item.realized_gain || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="text-end">${(item.buy_qty || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 4 })}</td>
            <td class="text-end">${(item.sell_qty || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 4 })}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateCurrencyBreakdownVisibility() {
    const breakdownElements = document.querySelectorAll('.currency-breakdown');
    breakdownElements.forEach(el => {
        if (showCurrencyBreakdown) {
            el.classList.remove('d-none');
        } else {
            el.classList.add('d-none');
        }
    });
}

function formatNumber(num, decimals = 0, showSign = false) {
    const number = parseFloat(num) || 0;
    const formatted = number.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });

    if (showSign && number > 0) {
        return '+' + formatted;
    }

    return formatted;
}

function showError(message) {
    document.getElementById('loading-spinner').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', function() {
    loadMonthlyAnalysis();
    const toggle = document.getElementById('toggleCurrencyBreakdown');
    if (toggle) {
        toggle.addEventListener('change', function(event) {
            showCurrencyBreakdown = event.target.checked;
            updateCurrencyBreakdownVisibility();
        });
    }
});
</script>
{% endblock %}
