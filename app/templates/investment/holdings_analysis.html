{% extends "base/investment_base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-pie me-2"></i>{{ _('Holdings Analysis') }}
        </h2>
        <!-- <p class="text-muted">{{ _('Current portfolio distribution analysis with four different perspectives') }}</p> -->
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4" id="summary-cards">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            {{ _('Total Value') }} (CAD)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-value">
                            $0.00
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            {{ _('Unique Stocks') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="unique-stocks">
                            0
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-layer-group fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            {{ _('Categories') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="categories-count">
                            0
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tags fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            {{ _('Accounts') }}
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="accounts-count">
                            0
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-university fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Four Pie Charts Row -->
<div class="row">
    <!-- Holdings by Stock Chart -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">{{ _('Holdings by Stock') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="position: relative; height: 400px;">
                    <canvas id="stocksChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Holdings by Category Chart -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">{{ _('Holdings by Category') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="position: relative; height: 400px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Holdings by Currency Chart -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">{{ _('Holdings by Currency') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="position: relative; height: 400px;">
                    <canvas id="currencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Holdings by Account Chart -->
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold" id="accountChartTitle" data-default-title="{{ _('Holdings by Account') }}">{{ _('Holdings by Account') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="position: relative; height: 400px;">
                    <canvas id="accountChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="memberChartRow" style="display: none;">
    <div class="col-xl-6 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 font-weight-bold">{{ _('Holdings by Member') }}</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="position: relative; height: 400px;">
                    <canvas id="memberChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js datalabels plugin for displaying percentages on charts -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
if (window.Chart && Chart.register && typeof ChartDataLabels !== 'undefined') {
    Chart.register(ChartDataLabels);
}
let distributionData = {};
let stocksChart = null;
let categoryChart = null;
let currencyChart = null;
let accountChart = null;
let memberChart = null;
const STOCKS_LABEL_SUFFIX = ' stocks';
const BASE_CHART_COLORS = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#e83e8c', '#fd7e14'];
const CASH_SLICE_COLOR = '#d6d8db';

// Get current family ID and other parameters
const familyId = {{ family.id if family else 'null' }};
const memberId = new URLSearchParams(window.location.search).get('member_id');
const accountId = new URLSearchParams(window.location.search).get('account_id');

// Apply current exchange rate to recalculate all distribution values
function applyCurrentExchangeRateToDistribution(distribution) {
    const currentRate = {{ exchange_rates['usd_to_cad'] if exchange_rates else 1.3782 }};

    // Helper function to recalculate value from currency breakdown
    function recalculateValue(item) {
        if (item.currency_breakdown) {
            const cadValue = item.currency_breakdown.CAD || 0;
            const usdValue = item.currency_breakdown.USD || 0;
            return cadValue + usdValue * currentRate;
        }
        return item.value || 0;
    }

    // Deep clone the distribution to avoid modifying original data
    const correctedDistribution = JSON.parse(JSON.stringify(distribution));

    // Update summary total value
    if (correctedDistribution.summary && correctedDistribution.summary.currency_breakdown) {
        const cadValue = correctedDistribution.summary.currency_breakdown.CAD || 0;
        const usdValue = correctedDistribution.summary.currency_breakdown.USD || 0;
        correctedDistribution.summary.total_value_cad = cadValue + usdValue * currentRate;
    }

    // Update all distribution arrays
    ['by_stocks', 'by_categories', 'by_currencies', 'by_accounts', 'by_member'].forEach(arrayKey => {
        if (correctedDistribution[arrayKey] && Array.isArray(correctedDistribution[arrayKey])) {
            correctedDistribution[arrayKey].forEach(item => {
                item.value = recalculateValue(item);
            });
        }
    });

    console.log('Holdings distribution updated with current exchange rate:', currentRate);
    return correctedDistribution;
}

function loadHoldingsDistribution() {
    let apiUrl = `/api/v1/families/${familyId}/reports/holdings-distribution`;
    let params = new URLSearchParams();
    
    if (memberId) params.append('member_id', memberId);
    if (accountId) params.append('account_id', accountId);
    
    if (params.toString()) {
        apiUrl += '?' + params.toString();
    }
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            distributionData = applyCurrentExchangeRateToDistribution(data.distribution);
            updateSummaryCards(distributionData.summary);
            updateStocksChart();
            updateCategoryChart();
            updateCurrencyChart();
            updateAccountChart();
            updateMemberChart();
        })
        .catch(error => {
            console.error('Error loading holdings distribution:', error);
            showNoDataMessage();
        });
}

function updateSummaryCards(summary) {
    // Get current exchange rate for USD to CAD conversion
    const currentRate = {{ exchange_rates['usd_to_cad'] if exchange_rates else 1.3782 }};

    let totalValueCorrect = summary.total_value_cad || 0;

    // If summary contains currency breakdown, recalculate with current exchange rate
    if (summary.currency_breakdown) {
        const cadValue = summary.currency_breakdown.CAD || 0;
        const usdValue = summary.currency_breakdown.USD || 0;
        totalValueCorrect = cadValue + usdValue * currentRate;
    }

    document.getElementById('total-value').textContent =
        '$' + totalValueCorrect.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    document.getElementById('unique-stocks').textContent = summary.unique_stocks || 0;
    document.getElementById('categories-count').textContent = summary.categories_count || 0;
    document.getElementById('accounts-count').textContent = summary.accounts_count || 0;
}

function updateStocksChart() {
    const ctx = document.getElementById('stocksChart').getContext('2d');
    
    if (stocksChart) {
        stocksChart.destroy();
    }
    
    if (!distributionData.by_stocks || distributionData.by_stocks.length === 0) {
        showChartNoData(ctx, 'No stock holdings data');
        return;
    }
    
    const stocksData = distributionData.by_stocks.slice();
    const cashIndex = stocksData.findIndex(item => item.is_cash || item.symbol === 'Cash');
    let cashItem = null;
    if (cashIndex >= 0) {
        cashItem = stocksData.splice(cashIndex, 1)[0];
    }

    const sortedRegular = stocksData.sort((a, b) => b.value - a.value);
    let displayedStocks;
    if (cashItem) {
        const limit = 9;
        displayedStocks = sortedRegular.slice(0, limit);
        displayedStocks.push(cashItem);
    } else {
        displayedStocks = sortedRegular.slice(0, 10);
    }

    const labels = displayedStocks.map(stock => {
        const labelKey = stock.symbol || stock.name || 'Item';
        return `${labelKey} ($${stock.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
    });
    const data = displayedStocks.map(stock => stock.value);

    const backgroundColors = displayedStocks.map((stock, idx) => {
        if (stock.is_cash || stock.symbol === 'Cash' || stock.name === 'Cash') {
            return CASH_SLICE_COLOR;
        }
        return BASE_CHART_COLORS[idx % BASE_CHART_COLORS.length];
    });

    stocksChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                hoverBorderColor: "rgba(234, 236, 244, 1)",
                borderWidth: 2
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 40,
                    bottom: 40,
                    left: 60,
                    right: 60
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'right'
                },
                datalabels: {
                    display: true,
                    color: '#2c3e50',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    borderRadius: 3,
                    padding: 4,
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    anchor: 'end',
                    align: 'end',
                    offset: 15,
                    // 连接线配置
                    listeners: {
                        enter: function(context) {
                            // 鼠标悬停时显示连接线
                            return true;
                        }
                    },
                    // 尝试Chart.js 3.x的连接线语法
                    clip: false,
                    clamp: false,
                    formatter: function(value, context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        if (!total) return '';
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    }
                }
            }
        }
    });
}

function updateCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    
    if (categoryChart) {
        categoryChart.destroy();
    }
    
    if (!distributionData.by_category || distributionData.by_category.length === 0) {
        showChartNoData(ctx, 'No category data');
        return;
    }
    
    const categoriesData = distributionData.by_category.slice();
    const cashCategoryIndex = categoriesData.findIndex(cat => cat.is_cash || cat.category === 'Cash');
    let cashCategory = null;
    if (cashCategoryIndex >= 0) {
        cashCategory = categoriesData.splice(cashCategoryIndex, 1)[0];
    }
    const arrangedCategories = cashCategory ? categoriesData.concat([cashCategory]) : categoriesData;

    const labels = arrangedCategories.map(cat => `${cat.category} ($${cat.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`);
    const data = arrangedCategories.map(cat => cat.value);
    const categoryBackgrounds = arrangedCategories.map((cat, idx) => {
        if (cat.is_cash || cat.category === 'Cash') {
            return CASH_SLICE_COLOR;
        }
        return BASE_CHART_COLORS[idx % BASE_CHART_COLORS.length];
    });

    categoryChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: categoryBackgrounds,
                hoverBorderColor: "rgba(234, 236, 244, 1)",
                borderWidth: 2
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 40,
                    bottom: 40,
                    left: 60,
                    right: 60
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            const categoryEntry = arrangedCategories[context.dataIndex];
                            const stocksCount = categoryEntry ? categoryEntry.stocks_count : null;
                            const suffix = (typeof stocksCount === 'number') ? ' - ' + stocksCount + STOCKS_LABEL_SUFFIX : '';
                            return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%)' + suffix;
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'right'
                },
                datalabels: {
                    display: true,
                    color: '#2c3e50',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    borderRadius: 3,
                    padding: 4,
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    anchor: 'end',
                    align: 'end',
                    offset: 15,
                    // 连接线配置
                    listeners: {
                        enter: function(context) {
                            // 鼠标悬停时显示连接线
                            return true;
                        }
                    },
                    // 尝试Chart.js 3.x的连接线语法
                    clip: false,
                    clamp: false,
                    formatter: function(value, context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        if (!total) return '';
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    }
                }
            }
        }
    });
}

function updateCurrencyChart() {
    const ctx = document.getElementById('currencyChart').getContext('2d');
    
    if (currencyChart) {
        currencyChart.destroy();
    }
    
    if (!distributionData.by_currency || distributionData.by_currency.length === 0) {
        showChartNoData(ctx, 'No currency data');
        return;
    }
    
    const labels = distributionData.by_currency.map(curr => `${curr.currency} ($${curr.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`);
    const data = distributionData.by_currency.map(curr => curr.value);
    
    currencyChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FFF5B7', '#28a745'  // 淡黄色for CAD, 绿色for USD
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
                borderWidth: 2
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 40,
                    bottom: 40,
                    left: 60,
                    right: 60
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'right'
                },
                datalabels: {
                    display: true,
                    color: '#2c3e50',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    borderRadius: 3,
                    padding: 4,
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    anchor: 'end',
                    align: 'end',
                    offset: 15,
                    // 连接线配置
                    listeners: {
                        enter: function(context) {
                            // 鼠标悬停时显示连接线
                            return true;
                        }
                    },
                    // 尝试Chart.js 3.x的连接线语法
                    clip: false,
                    clamp: false,
                    formatter: function(value, context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    }
                }
            }
        }
    });
}

function updateAccountChart() {
    const ctx = document.getElementById('accountChart').getContext('2d');

    if (accountChart) {
        accountChart.destroy();
    }
    
    if (!distributionData.by_account || distributionData.by_account.length === 0) {
        showChartNoData(ctx, 'No account data');
        return;
    }
    
    const accountData = distributionData.by_account;
    const titleEl = document.getElementById('accountChartTitle');
    const defaultTitle = titleEl ? titleEl.dataset.defaultTitle : null;

    const singleJointAccount = accountData.length === 1 && accountData[0].is_joint && accountData[0].members && accountData[0].members.length > 1;

    let labels;
    let data;
    let tooltipSource = accountData;

    if (singleJointAccount) {
        const account = accountData[0];
        labels = account.members.map(member => `${member.name} ($${(member.value || account.value * (member.ownership_percentage || 0) / 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`);
        data = account.members.map(member => {
            if (typeof member.value === 'number' && !Number.isNaN(member.value)) {
                return member.value;
            }
            return account.value * (member.ownership_percentage || 0) / 100;
        });
        tooltipSource = account.members;
        if (titleEl && defaultTitle) {
            titleEl.textContent = `${defaultTitle} - ${account.account_name}`;
        }
    } else {
        labels = accountData.map(acc => `${acc.account_name} ($${acc.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`);
        data = accountData.map(acc => acc.value);
        if (titleEl && defaultTitle) {
            titleEl.textContent = defaultTitle;
        }
    }

    accountChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#e74a3b', '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
                    '#858796', '#5a5c69', '#6f42c1', '#e83e8c', '#fd7e14'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
                borderWidth: 2
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 40,
                    bottom: 40,
                    left: 60,
                    right: 60
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            if (singleJointAccount) {
                                return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                            }
                            const holdingsCount = tooltipSource[context.dataIndex].holdings_count;
                            return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%) - ' + holdingsCount + ' holdings';
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'right'
                },
                datalabels: {
                    display: true,
                    color: '#2c3e50',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    borderRadius: 3,
                    padding: 4,
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    anchor: 'end',
                    align: 'end',
                    offset: 15,
                    // 连接线配置
                    listeners: {
                        enter: function(context) {
                            // 鼠标悬停时显示连接线
                            return true;
                        }
                    },
                    // 尝试Chart.js 3.x的连接线语法
                    clip: false,
                    clamp: false,
                    formatter: function(value, context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        if (!total) return '';
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    }
                }
            }
        }
    });
}

function updateMemberChart() {
    const memberRow = document.getElementById('memberChartRow');
    const memberCanvas = document.getElementById('memberChart');

    if (!memberRow || !memberCanvas) {
        return;
    }

    if (memberChart) {
        memberChart.destroy();
        memberChart = null;
    }

    // Only show for the "All Members" view (no member/account filters applied)
    if (memberId || accountId) {
        memberRow.style.display = 'none';
        return;
    }

    const ctx = memberCanvas.getContext('2d');
    const membersData = (distributionData.by_member || []).slice();

    if (membersData.length === 0) {
        memberRow.style.display = '';
        showChartNoData(ctx, 'No member data');
        return;
    }

    memberRow.style.display = '';

    const sortedMembers = membersData.sort((a, b) => b.value - a.value);
    const labels = sortedMembers.map(member => {
        const memberName = member.name || 'Member';
        return `${memberName} ($${member.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
    });
    const data = sortedMembers.map(member => member.value);
    const backgroundColors = sortedMembers.map((member, index) => BASE_CHART_COLORS[index % BASE_CHART_COLORS.length]);

    memberChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                hoverBorderColor: "rgba(234, 236, 244, 1)",
                borderWidth: 2
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 40,
                    bottom: 40,
                    left: 60,
                    right: 60
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total ? ((value / total) * 100).toFixed(1) : '0.0';
                            return context.label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                        }
                    }
                },
                legend: {
                    display: true,
                    position: 'right'
                },
                datalabels: {
                    display: true,
                    color: '#2c3e50',
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#dee2e6',
                    borderWidth: 1,
                    borderRadius: 3,
                    padding: 4,
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    anchor: 'end',
                    align: 'end',
                    offset: 15,
                    clip: false,
                    clamp: false,
                    formatter: function(value, context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        if (!total) return '';
                        const percentage = ((value / total) * 100).toFixed(1);
                        return percentage + '%';
                    }
                }
            }
        }
    });
}

function showChartNoData(ctx, message) {
    ctx.fillStyle = '#858796';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
}

function showNoDataMessage() {
    const cards = document.querySelectorAll('.chart-area');
    cards.forEach(card => {
        card.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-chart-pie fa-3x text-gray-300 mb-3"></i>
                <p class="text-muted">{{ _('No holdings data available') }}</p>
            </div>
        `;
    });
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadHoldingsDistribution();
});
</script>
{% endblock %}
