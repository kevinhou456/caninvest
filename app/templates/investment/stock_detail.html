{% extends "base/investment_base.html" %}

{% block extra_head %}
<!-- Stock Symbol Correction Component -->
<script src="{{ url_for('static', filename='js/stock-symbol-correction.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div>
                <!-- Header with Stock Info and Summary -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center flex-wrap gap-3">
                            <h2 class="mb-0">
                                <i class="fas fa-chart-line me-2 text-primary"></i>
                                {{ stock_symbol }}
                                {% if stock_info and stock_info.name %}
                                    <small class="text-muted">- {{ stock_info.name }}</small>
                                {% endif %}
                                
                                <!-- Display current filter next to stock symbol -->
                                {% if member_id or account_id %}
                                    {% set filter_info = get_current_filter_display(family, member_id, account_id, true, account_members) %}
                                    {% if filter_info %}
                                        <span class="badge bg-info ms-3" style="font-size: 0.6em;">
                                            <i class="{{ filter_info.icon_class }} me-1"></i>{{ filter_info.display_text }}
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </h2>
                            
                            <!-- Stock Symbol Correction Button -->
                            {% if needs_symbol_correction %}
                            <button type="button" class="btn btn-warning btn-sm" id="stockCorrectionBtn" onclick="testModal()">
                                <i class="fas fa-edit me-1"></i>修正股票代码
                            </button>
                            {% endif %}
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <nav aria-label="breadcrumb" class="mb-0">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="{{ url_for('main.overview', member_id=member_id, account_id=account_id) }}">{{ _('Overview') }}</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">{{ stock_symbol }}</li>
                                </ol>
                            </nav>
                            
                            <!-- Inline Stock Summary -->
                            {% if stock_stats and stock_stats.current_shares > 0 %}
                            <div class="d-flex flex-wrap gap-4" style="font-size: 1rem;">
                                <span>shares: <strong class="text-dark">{{ "{:,.0f}".format(stock_stats.current_shares) }}</strong></span>
                                <span>price: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.current_price) if stock_stats.current_price > 0 else 'N/A' }}</strong></span>
                                <span>value: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.market_value) if stock_stats.market_value > 0 else 'N/A' }}</strong></span>
                                <span>unrealized: <strong class="{{ 'text-success' if stock_stats.unrealized_pnl >= 0 else 'text-danger' }}">{{ "+" if stock_stats.unrealized_pnl >= 0 else "" }}{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.unrealized_pnl) }}</strong></span>
                                <span>realized: <strong class="{{ 'text-success' if stock_stats.realized_pnl >= 0 else 'text-danger' }}">{{ "+" if stock_stats.realized_pnl >= 0 else "" }}{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.realized_pnl) }}</strong></span>
                                <span>div: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.total_dividends) }}</strong></span>
                                <span>int: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.total_interest) }}</strong></span>
                            </div>
                            {% elif current_holding %}
                            <div class="d-flex gap-4" style="font-size: 1rem;">
                                <span>shares: <strong class="text-dark">{{ "{:,.0f}".format(current_holding.shares) }}</strong></span>
                                <span>avg cost: <strong class="text-dark">{{ current_holding.currency }}${{ "{:,.2f}".format(current_holding.avg_cost) }}</strong></span>
                                <span>total cost: <strong class="text-dark">{{ current_holding.currency }}${{ "{:,.2f}".format(current_holding.total_cost) }}</strong></span>
                                <span>return rate: <strong class="{{ 'text-success' if (stock_stats.total_return_rate or 0) >= 0 else 'text-danger' }}">{{ "+" if (stock_stats.total_return_rate or 0) >= 0 else "" }}{{ "{:.2f}".format(stock_stats.total_return_rate or 0) }}%</strong></span>
                            </div>
                            {% elif stock_stats %}
                            <!-- Show summary for zero holdings -->
                            <div class="d-flex flex-wrap gap-4" style="font-size: 1rem;">
                                <span>Total Invested: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.total_invested or 0) }}</strong></span>
                                <span>Realized Gain: <strong class="{{ 'text-success' if (stock_stats.realized_pnl or 0) >= 0 else 'text-danger' }}">{{ "+" if (stock_stats.realized_pnl or 0) >= 0 else "" }}{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.realized_pnl or 0) }}</strong></span>
                                <span>Dividend: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.total_dividends or 0) }}</strong></span>
                                <span>Interest: <strong class="text-dark">{{ stock_stats.currency }}${{ "{:,.2f}".format(stock_stats.total_interest or 0) }}</strong></span>
                                <span>Return Rate: <strong class="{{ 'text-success' if (stock_stats.zero_holding_return_rate or 0) >= 0 else 'text-danger' }}">{{ "+" if (stock_stats.zero_holding_return_rate or 0) >= 0 else "" }}{{ "{:.2f}".format(stock_stats.zero_holding_return_rate or 0) }}%</strong></span>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Show All button for filtered views -->
                        {% if member_id or account_id %}
                        <div class="ms-auto">
                            <a href="{{ url_for('main.stock_detail', stock_symbol=stock_symbol) }}" class="btn btn-sm btn-outline-secondary">
                                {{ _('Show All') }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Combined Chart Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-mixed me-2"></i>{{ _('Stock Price & Holdings Analysis') }}
                    </h5>
                    <small class="text-muted">{{ _('Price (line) & Quantity (bars)') }}</small>
                </div>
                <div class="card-body">
                    <div style="position: relative; width: 100%; height: 600px;">
                        <canvas id="combinedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table Section -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>{{ _('Transaction History') }}
                    </h5>
                    <div class="d-flex align-items-center gap-3">
                        <span class="badge bg-primary">{{ transactions|length }} {{ _('transactions') }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="transactionTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="date">
                                        {{ _('Date') }}
                                        <i class="fas fa-sort-down ms-1 sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="account">
                                        {{ _('Account') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="type">
                                        {{ _('Type') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="quantity">
                                        {{ _('Quantity') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="price">
                                        {{ _('Price') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="amount">
                                        {{ _('Amount') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="fee">
                                        {{ _('Fee') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="currency">
                                        {{ _('Currency') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="notes">
                                        {{ _('Notes') }}
                                        <i class="fas fa-sort ms-1 sort-icon"></i>
                                    </th>
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr data-date="{{ transaction.trade_date.isoformat() }}"
                                    data-account="{{ transaction.account.name }}"
                                    data-type="{{ transaction.type }}"
                                    data-quantity="{{ transaction.quantity or 0 }}"
                                    data-price="{{ transaction.price or 0 }}"
                                    data-amount="{{ transaction.amount or 0 }}"
                                    data-fee="{{ transaction.fee or 0 }}"
                                    data-currency="{{ transaction.currency or 'CAD' }}"
                                    data-notes="{{ transaction.notes or '' }}">
                                    <td>
                                        <span class="fw-medium">{{ transaction.trade_date.strftime('%Y-%m-%d') }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ transaction.account.name }}</small>
                                    </td>
                                    <td>
                                        {% if transaction.type == 'BUY' %}
                                            <span class="badge bg-success">{{ _('Buy') }}</span>
                                        {% elif transaction.type == 'SELL' %}
                                            <span class="badge bg-danger">{{ _('Sell') }}</span>
                                        {% elif transaction.type == 'DIVIDEND' %}
                                            <span class="badge bg-info">{{ _('Dividend') }}</span>
                                        {% elif transaction.type == 'INTEREST' %}
                                            <span class="badge bg-warning">{{ _('Interest') }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ transaction.type }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if transaction.quantity %}
                                            {{ "{:,.2f}".format(transaction.quantity) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if transaction.price %}
                                            ${{ "{:,.2f}".format(transaction.price) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if transaction.amount %}
                                            <span class="{{ 'text-danger' if transaction.amount < 0 else 'text-success' }}">
                                                ${{ "{:,.2f}".format(transaction.amount|abs) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if transaction.fee %}
                                            <span class="text-warning">${{ "{:,.2f}".format(transaction.fee) }}</span>
                                        {% else %}
                                            <span class="text-muted">$0.00</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ transaction.currency or 'CAD' }}</span>
                                    </td>
                                    <td>
                                        {% if transaction.notes %}
                                            <small class="text-muted">{{ transaction.notes }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    onclick="editTransactionNotes({{ transaction.id }}, '{{ transaction.notes or '' }}')">
                                                <i class="fas fa-edit me-1"></i>{{ _('Edit Notes') }}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script>
console.log('=== Chart initialization starting ===');

// Update debug status immediately
// 全局测试函数 - 移到外部避免作用域问题
window.testModal = function() {
    console.log('测试模态框函数被调用');
    
    // 检查StockSymbolCorrection是否已加载
    if (typeof StockSymbolCorrection === 'undefined') {
        console.error('StockSymbolCorrection 组件未加载');
        alert('股票修正组件未加载，请检查JavaScript文件');
        return;
    }
    
    try {
        const correction = new StockSymbolCorrection({
            onSuccess: (result) => {
                console.log('修正成功:', result);
                alert('修正成功，将跳转到新页面');
                // 跳转逻辑
                if (result.stock_info && result.stock_info.symbol) {
                    const newSymbol = result.stock_info.symbol;
                    const currentParams = new URLSearchParams(window.location.search);
                    let newUrl = `{{ url_for('main.stock_detail', stock_symbol='__SYMBOL__') }}`.replace('__SYMBOL__', newSymbol);
                    
                    if (currentParams.toString()) {
                        newUrl += '?' + currentParams.toString();
                    }
                    
                    console.log('跳转到:', newUrl);
                    window.location.href = newUrl;
                } else {
                    window.location.reload();
                }
            },
            onError: (error) => {
                console.error('修正失败:', error);
                alert('修正失败: ' + error);
            }
        });
        
        console.log('显示修正对话框，传入数据:', {
            stockId: {{ stock_info.id if stock_info else 'null' }},
            symbol: {{ stock_symbol | tojson }},
            currency: {{ (stock_info.currency if stock_info else 'CAD') | tojson }}
        });
        
        correction.show({
            stockId: {{ stock_info.id if stock_info else 'null' }},
            symbol: {{ stock_symbol | tojson }},
            currency: {{ (stock_info.currency if stock_info else 'CAD') | tojson }}
        });
        
    } catch (error) {
        console.error('创建修正组件失败:', error);
        alert('创建修正组件失败: ' + error.message);
    }
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing chart...');
    
    // Get data from backend
    const priceDataRaw = {{ price_data | tojson | safe }};
    const quantityDataRaw = {{ quantity_data | tojson | safe }};
    const transactionMarkersRaw = {{ transaction_markers | tojson | safe }};
    const showAccountNumbers = {{ show_account_numbers | tojson }};
    
    console.log('Initializing chart with', priceDataRaw ? priceDataRaw.length : 0, 'price points,', quantityDataRaw ? quantityDataRaw.length : 0, 'quantity points and', transactionMarkersRaw ? transactionMarkersRaw.length : 0, 'transaction markers');
    
    // Validate Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        const chartContainer = document.querySelector('#combinedChart').parentElement;
        chartContainer.innerHTML = '<div class="text-center text-danger py-5">Chart.js library failed to load</div>';
        return;
    }
    
    // Get chart canvas
    const canvas = document.getElementById('combinedChart');
    if (!canvas) {
        console.error('Canvas element not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Process data if available
    if (!priceDataRaw || priceDataRaw.length === 0) {
        console.log('No price data available');
        const chartContainer = document.querySelector('#combinedChart').parentElement;
        chartContainer.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-chart-mixed fa-3x mb-3"></i><p>No price data available for chart</p></div>';
        return;
    }
    
    // Prepare labels from all dates
    const allDates = new Set();
    priceDataRaw.forEach(item => allDates.add(item.date));
    if (quantityDataRaw) {
        quantityDataRaw.forEach(item => allDates.add(item.date));
    }
    const labels = Array.from(allDates).sort();
    
    // Prepare price data
    const priceMap = {};
    priceDataRaw.forEach(item => {
        priceMap[item.date] = item.price;
    });
    const alignedPrices = labels.map(date => priceMap[date] || null);
    
    // Prepare quantity data  
    const quantityMap = {};
    if (quantityDataRaw) {
        quantityDataRaw.forEach(item => {
            quantityMap[item.date] = item.quantity;
        });
    }
    const alignedQuantities = labels.map(date => quantityMap[date] || 0);
    
    // Create datasets
    const datasets = [];
    
    // Price line chart
    datasets.push({
        type: 'line',
        label: 'Stock Price ({% if transactions %}{{ transactions[0].currency }}{% else %}CAD{% endif %})',
        data: alignedPrices,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.1)',
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        yAxisID: 'y'
    });
    
    // Quantity bar chart (if data available)
    if (quantityDataRaw && quantityDataRaw.length > 0) {
        datasets.push({
            type: 'bar',
            label: 'Holdings Quantity',
            data: alignedQuantities,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            yAxisID: 'y1'
        });
    }
    
    // Add transaction markers as scatter points
    if (transactionMarkersRaw && transactionMarkersRaw.length > 0) {
        const buyPoints = [];
        const sellPoints = [];
        
        transactionMarkersRaw.forEach(marker => {
            const point = {
                x: marker.date,
                y: marker.price
            };
            
            if (marker.type === 'BUY') {
                buyPoints.push(point);
            } else if (marker.type === 'SELL') {
                sellPoints.push(point);
            }
        });
        
        // Buy markers (green triangles pointing up)
        if (buyPoints.length > 0) {
            datasets.push({
                type: 'scatter',
                label: 'Buy Transactions',
                data: buyPoints,
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 2,
                pointStyle: 'triangle',
                pointRadius: 8,
                yAxisID: 'y'
            });
        }
        
        // Sell markers (red triangles pointing down)
        if (sellPoints.length > 0) {
            datasets.push({
                type: 'scatter',
                label: 'Sell Transactions',
                data: sellPoints,
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderColor: 'rgb(239, 68, 68)',
                borderWidth: 2,
                pointStyle: 'triangle',
                pointRadius: 8,
                pointRotation: 180,
                yAxisID: 'y'
            });
        }
    }
    
    console.log('Creating chart with datasets:', datasets);
    
    console.log('Transaction markers data:', transactionMarkersRaw);
    
    try {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            plugins: [{
                id: 'accountNumberCircles',
                afterDraw: function(chart, args, options) {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    
                    // Draw account number circles for transaction markers (only for multiple accounts)
                    if (showAccountNumbers && transactionMarkersRaw && transactionMarkersRaw.length > 0) {
                        transactionMarkersRaw.forEach(marker => {
                            const xScale = chart.scales.x;
                            const yScale = chart.scales.y;
                            
                            // Get pixel coordinates for the transaction point
                            const xPixel = xScale.getPixelForValue(marker.date);
                            const yPixel = yScale.getPixelForValue(marker.price);
                            
                            // Position circle above the triangle (offset by 25 pixels up)
                            const circleY = yPixel - 25;
                            
                            // Only draw if within chart area
                            if (xPixel >= chartArea.left && xPixel <= chartArea.right && 
                                circleY >= chartArea.top && circleY <= chartArea.bottom) {
                                
                                ctx.save();
                                
                                // Draw black circle
                                ctx.beginPath();
                                ctx.arc(xPixel, circleY, 12, 0, 2 * Math.PI);
                                ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                                ctx.fill();
                                ctx.strokeStyle = 'white';
                                ctx.lineWidth = 2;
                                ctx.stroke();
                                
                                // Draw white account number
                                ctx.fillStyle = 'white';
                                ctx.font = 'bold 10px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(marker.account_number.toString(), xPixel, circleY);
                                
                                ctx.restore();
                            }
                        });
                    }
                }
            }],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                height: 600,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Price ({% if transactions %}{{ transactions[0].currency }}{% else %}CAD{% endif %})'
                        },
                        beginAtZero: false
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Quantity'
                        },
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                },
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.type === 'line') {
                                    return context.dataset.label + ': $' + (context.parsed.y ? context.parsed.y.toFixed(2) : 'N/A');
                                } else if (context.dataset.type === 'scatter') {
                                    // For transaction markers, show detailed info
                                    const marker = transactionMarkersRaw.find(m => 
                                        m.date === context.parsed.x && Math.abs(m.price - context.parsed.y) < 0.01
                                    );
                                    if (marker) {
                                        return [
                                            context.dataset.label + ': $' + context.parsed.y.toFixed(2),
                                            `Account ${marker.account_number} (${marker.account_name})`,
                                            `Quantity: ${marker.quantity}`
                                        ];
                                    }
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                } else {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(0);
                                }
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        console.log('Chart created successfully!');
        
    } catch (error) {
        console.error('Chart creation failed:', error);
        const chartContainer = document.querySelector('#combinedChart').parentElement;
        chartContainer.innerHTML = '<div class="text-center text-danger py-5"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Chart error: ' + error.message + '</p></div>';
    }

    // 初始化股票代码修正功能
    console.log('检查修正按钮初始化条件:', {
        needs_symbol_correction: {{ needs_symbol_correction | tojson }},
        stock_info: {{ stock_info | tojson if stock_info else 'null' }}
    });
    
    const correctionBtn = document.getElementById('stockCorrectionBtn');
    console.log('修正按钮元素:', correctionBtn);
    
    if (correctionBtn) {
        console.log('添加点击事件监听器');
        correctionBtn.addEventListener('click', (e) => {
            console.log('修正按钮被点击');
            e.preventDefault();
            
            // 检查StockSymbolCorrection是否已加载
            if (typeof StockSymbolCorrection === 'undefined') {
                console.error('StockSymbolCorrection 组件未加载');
                alert('股票修正组件未加载，请刷新页面重试');
                return;
            }
            
            try {
                const correction = new StockSymbolCorrection({
                    onSuccess: (result) => {
                        console.log('修正成功:', result);
                        // 跳转到新的股票代码页面（保持当前过滤条件）
                        if (result.stock_info && result.stock_info.symbol) {
                            const newSymbol = result.stock_info.symbol;
                            const currentParams = new URLSearchParams(window.location.search);
                            let newUrl = `{{ url_for('main.stock_detail', stock_symbol='__SYMBOL__') }}`.replace('__SYMBOL__', newSymbol);
                            
                            // 保持当前的过滤参数
                            if (currentParams.toString()) {
                                newUrl += '?' + currentParams.toString();
                            }
                            
                            console.log('跳转到:', newUrl);
                            window.location.href = newUrl;
                        } else {
                            // 如果没有返回新的股票代码，则刷新当前页面
                            window.location.reload();
                        }
                    },
                    onError: (error) => {
                        console.error('修正失败:', error);
                    }
                });
                
                console.log('显示修正对话框');
                correction.show({
                    stockId: {{ stock_info.id if stock_info else 'null' }},
                    symbol: {{ stock_symbol | tojson }},
                    currency: {{ (stock_info.currency if stock_info else 'CAD') | tojson }}
                });
            } catch (error) {
                console.error('创建修正组件失败:', error);
                alert('创建修正组件失败: ' + error.message);
            }
        });
    } else {
        console.log('修正按钮未找到');
    }
});

// Transaction management functions (reused from transactions page)
function editTransaction(transactionId) {
    fetch(`/api/v1/transactions/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                openEditTransactionModal(data.transaction);
            } else {
                alert('{{ _("Error loading transaction: ") }}' + (data.error || '{{ _("Unknown error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ _("Error loading transaction. Please try again.") }}');
        });
}

function deleteTransaction(transactionId) {
    if (confirm('{{ _("Are you sure you want to delete this transaction? This action cannot be undone.") }}')) {
        fetch(`/api/v1/transactions/${transactionId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('{{ _("Error deleting transaction: ") }}' + (data.error || '{{ _("Unknown error") }}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{{ _("Error deleting transaction. Please try again.") }}');
        });
    }
}

function openEditTransactionModal(transaction) {
    const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
    
    document.getElementById('editTransactionId').value = transaction.id;
    document.getElementById('editTradeDate').value = transaction.trade_date;
    document.getElementById('editType').value = transaction.type;
    document.getElementById('editStock').value = transaction.stock;
    document.getElementById('editQuantity').value = transaction.quantity;
    document.getElementById('editPrice').value = transaction.price;
    document.getElementById('editCurrency').value = transaction.currency;
    document.getElementById('editFee').value = transaction.fee;
    document.getElementById('editAccountId').value = transaction.account_id;
    document.getElementById('editNotes').value = transaction.notes || '';
    
    modal.show();
}

function handleEditTransactionSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const transactionId = formData.get('transaction_id');
    
    const data = {
        trade_date: formData.get('trade_date'),
        type: formData.get('type'),
        stock: formData.get('stock'),
        quantity: formData.get('quantity'),
        price: formData.get('price'),
        currency: formData.get('currency'),
        fee: formData.get('fee'),
        account_id: formData.get('account_id'),
        notes: formData.get('notes')
    };
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{{ _("Updating...") }}';
    submitBtn.disabled = true;
    
    fetch(`/api/v1/transactions/${transactionId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('{{ _("Error updating transaction: ") }}' + (data.error || '{{ _("Unknown error") }}'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ _("Error updating transaction. Please try again.") }}');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Function to open add transaction modal with stock symbol pre-filled
function openStockTransactionModal(stockSymbol) {
    // Check if we need to create the function that's in the transactions page
    if (typeof openAddTransactionModal === 'function') {
        // Reset the form first
        resetTransactionForm();
        
        // Pre-fill stock symbol
        document.getElementById('modal_stock_symbol').value = stockSymbol;
        
        // Check if holding quantity > 0 for pre-fill logic
        {% if stock_stats and stock_stats.current_shares > 0 %}
        // Pre-fill with SELL type and current quantity for stocks with holdings
        document.getElementById('modal_transaction_type').value = 'SELL';
        document.getElementById('modal_quantity').value = '{{ stock_stats.current_shares }}';
        
        // Trigger the transaction type change to adjust form visibility
        handleTransactionTypeChange();
        {% endif %}
        
        // Trigger stock lookup
        lookupStockInfo();
        
        // Open the modal
        const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
        modal.show();
    } else {
        alert('{{ _("Transaction modal not available. Please check the page setup.") }}');
    }
}

// Notes editing functions
function editTransactionNotes(transactionId, currentNotes) {
    document.getElementById('editNotesTransactionId').value = transactionId;
    document.getElementById('editNotesField').value = currentNotes;
    
    const modal = new bootstrap.Modal(document.getElementById('editNotesModal'));
    modal.show();
}

function handleEditNotesSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    fetch('{{ url_for("main.update_transaction_notes") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editNotesModal'));
            modal.hide();
            
            // Reload page to show updated notes
            location.reload();
        } else {
            alert(data.error || '{{ _("Failed to update notes") }}');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ _("Failed to update notes") }}');
    });
}

// Table sorting functionality for transaction table
document.addEventListener('DOMContentLoaded', function() {
    // Initialize sorting for transaction table
    initTransactionTableSorting('transactionTable');

    function initTransactionTableSorting(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const sortableHeaders = table.querySelectorAll('th.sortable');
        let currentSort = {column: 'date', direction: 'desc'}; // Default to date descending

        sortableHeaders.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const sortType = this.dataset.sort;
                const sortDirection = (currentSort.column === sortType && currentSort.direction === 'asc') ? 'desc' : 'asc';

                sortTransactionTable(table, sortType, sortDirection);
                updateTransactionSortIcons(sortableHeaders, this, sortDirection);

                currentSort = {column: sortType, direction: sortDirection};
            });
        });

        // Apply default sort (date descending)
        const tbody = table.querySelector('tbody');
        if (tbody && tbody.children.length > 0) {
            sortTransactionTable(table, 'date', 'desc');
        }
    }

    function sortTransactionTable(table, sortType, direction) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;

            if (sortType === 'date') {
                aVal = new Date(a.dataset.date);
                bVal = new Date(b.dataset.date);
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            } else if (sortType === 'account' || sortType === 'type' || sortType === 'currency' || sortType === 'notes') {
                aVal = (a.dataset[sortType] || '').toLowerCase();
                bVal = (b.dataset[sortType] || '').toLowerCase();
                return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            } else {
                // For numeric values (quantity, price, amount, fee)
                aVal = parseFloat(a.dataset[sortType]) || 0;
                bVal = parseFloat(b.dataset[sortType]) || 0;
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }
        });

        // Remove all rows and re-add them in sorted order
        rows.forEach(row => tbody.removeChild(row));
        rows.forEach(row => tbody.appendChild(row));
    }

    function updateTransactionSortIcons(headers, clickedHeader, direction) {
        // Reset all icons
        headers.forEach(header => {
            const icon = header.querySelector('.sort-icon');
            icon.className = 'fas fa-sort ms-1 sort-icon';
        });

        // Update clicked header icon
        const icon = clickedHeader.querySelector('.sort-icon');
        icon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} ms-1 sort-icon`;
    }
});
</script>

<style>
.sortable {
    user-select: none;
    transition: background-color 0.2s ease;
}

.sortable:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.sort-icon {
    opacity: 0.3;
    transition: opacity 0.2s ease;
    font-size: 0.8rem;
}

.sortable:hover .sort-icon {
    opacity: 0.7;
}

.sortable .fa-sort-up,
.sortable .fa-sort-down {
    opacity: 1;
    color: #007bff;
}

#transactionTable {
    position: relative;
}

#transactionTable tbody tr {
    transition: all 0.3s ease;
}
</style>

</script>

<!-- Include Transaction Modals -->
{% include 'transactions/create.html' %}

<!-- Notes Edit Modal -->
<div class="modal fade" id="editNotesModal" tabindex="-1" aria-labelledby="editNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editNotesModalLabel">
                    <i class="fas fa-edit me-2"></i>{{ _('Edit Notes') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form onsubmit="handleEditNotesSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="editNotesTransactionId" name="transaction_id">
                    <div class="mb-3">
                        <label for="editNotesField" class="form-label">{{ _('Notes') }}</label>
                        <textarea class="form-control" id="editNotesField" name="notes" rows="3" placeholder="{{ _('Enter notes...') }}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>{{ _('Save Notes') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal (reused from transactions page) -->
<div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTransactionModalLabel">
                    <i class="fas fa-edit me-2"></i>{{ _('Edit Transaction') }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <form onsubmit="handleEditTransactionSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="editTransactionId" name="transaction_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTradeDate" class="form-label">{{ _('Trade Date') }} <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="editTradeDate" name="trade_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editType" class="form-label">{{ _('Transaction Type') }} <span class="text-danger">*</span></label>
                                <select class="form-select" id="editType" name="type" required>
                                    <option value="">{{ _('Select Type') }}</option>
                                    <option value="BUY">{{ _('Buy') }}</option>
                                    <option value="SELL">{{ _('Sell') }}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStock" class="form-label">{{ _('Stock Symbol') }} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editStock" name="stock" placeholder="AAPL" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editAccountId" class="form-label">{{ _('Account') }} <span class="text-danger">*</span></label>
                                <select class="form-select" id="editAccountId" name="account_id" required>
                                    <option value="">{{ _('Select Account') }}</option>
                                    {% if accounts %}
                                        {% for account in accounts %}
                                        <option value="{{ account.id }}">{{ account.name }} ({{ account.account_type.name if account.account_type else 'Unknown' }})</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editQuantity" class="form-label">{{ _('Quantity') }} <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editQuantity" name="quantity" step="0.0001" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editPrice" class="form-label">{{ _('Price per Share') }} <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editPrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editCurrency" class="form-label">{{ _('Currency') }} <span class="text-danger">*</span></label>
                                <select class="form-select" id="editCurrency" name="currency" required>
                                    <option value="">{{ _('Select Currency') }}</option>
                                    <option value="USD">USD</option>
                                    <option value="CAD">CAD</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFee" class="form-label">{{ _('Transaction Fee') }}</label>
                                <input type="number" class="form-control" id="editFee" name="fee" step="0.01" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">{{ _('Notes') }}</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3" placeholder="{{ _('Optional notes...') }}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>{{ _('Cancel') }}
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>{{ _('Update Transaction') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}