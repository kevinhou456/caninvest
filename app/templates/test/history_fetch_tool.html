{% extends "base/investment_base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">历史数据获取工具</h2>
        <p class="text-muted mb-0">输入股票代码与日期范围，拉取 yfinance 历史价格并写入缓存数据库</p>
    </div>
    <a href="{{ url_for('main.transactions') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>返回交易列表
    </a>
</div>

<form method="post" class="card card-body mb-4 shadow-sm">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="symbol" class="form-label">股票代码</label>
            <input type="text" class="form-control" id="symbol" name="symbol" value="{{ symbol }}" placeholder="例如：TD.TO" required>
        </div>
        <div class="col-md-3">
            <label for="startDate" class="form-label">开始日期</label>
            <input type="date" class="form-control" id="startDate" name="start_date" value="{{ start_date }}" required>
        </div>
        <div class="col-md-3">
            <label for="endDate" class="form-label">结束日期</label>
            <input type="date" class="form-control" id="endDate" name="end_date" value="{{ end_date }}" required>
        </div>
        <div class="col-md-2">
            <label for="currency" class="form-label">货币</label>
            <select class="form-select" id="currency" name="currency">
                <option value="CAD" {% if currency == 'CAD' %}selected{% endif %}>CAD</option>
                <option value="USD" {% if currency == 'USD' %}selected{% endif %}>USD</option>
            </select>
        </div>
        <div class="col-md-1">
            <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="forceRefresh" name="force_refresh" {% if force_refresh %}checked{% endif %}>
                <label class="form-check-label" for="forceRefresh">强制刷新</label>
            </div>
        </div>
    </div>
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-database me-2"></i>获取并写入缓存
        </button>
    </div>
</form>

{% if error %}
<div class="alert alert-danger shadow-sm">{{ error }}</div>
{% endif %}

{% if success and fetch_info %}
<div class="alert alert-success shadow-sm">
    成功从 {{ fetch_info.start }} 到 {{ fetch_info.end }} 获取 <strong>{{ fetch_info.count }}</strong> 条 {{ fetch_info.symbol }} ({{ fetch_info.currency }}) 的历史记录，并写入缓存。
</div>
{% endif %}

{% if missing_days %}
<div class="alert alert-warning shadow-sm">
    已检测到 <strong>{{ fetch_info.missing_count }}</strong> 个可能的缺失交易日，并写入 <code>stock_holiday_attempts</code>：
    <div class="mt-2 small text-monospace">
        {{ missing_days|join(', ') }}
    </div>
</div>
{% endif %}

{% if rows %}
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <strong>历史价格数据</strong>
    </div>
    <div class="table-responsive">
        <table class="table table-striped mb-0">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>开盘</th>
                    <th>最高</th>
                    <th>最低</th>
                    <th>收盘</th>
                    <th>成交量</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    <td>{{ row.date or row.trade_date }}</td>
                    <td>{{ '%.4f'|format(row.open or 0) if row.open is not none else '-' }}</td>
                    <td>{{ '%.4f'|format(row.high or 0) if row.high is not none else '-' }}</td>
                    <td>{{ '%.4f'|format(row.low or 0) if row.low is not none else '-' }}</td>
                    <td>{{ '%.4f'|format(row.close or 0) if row.close is not none else '-' }}</td>
                    <td>{{ row.volume or 0 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% elif success %}
<div class="alert alert-info shadow-sm">本次查询未返回任何历史价格记录。</div>
{% endif %}

{% endblock %}
